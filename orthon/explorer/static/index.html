<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√òRTHON</title>
    <script src="https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/dist/duckdb-browser-blocking.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
            --purple: #bc8cff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: ui-monospace, 'Cascadia Code', 'SF Mono', Consolas, monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .brand { display: flex; flex-direction: column; }
        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .logo span { color: var(--accent); }
        .logo span:not(:first-child) { color: var(--text); }
        .tagline { font-size: 0.8rem; color: var(--dim); margin-top: 0.15rem; letter-spacing: 0; font-weight: 400; white-space: nowrap; }
        .tagline strong { color: var(--text); font-weight: 600; }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            margin-left: 2rem;
        }

        .nav-tab {
            padding: 0.4rem 1rem;
            background: transparent;
            border: none;
            color: var(--dim);
            font: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.15s;
        }

        .nav-tab:hover { color: var(--text); background: var(--input); }
        .nav-tab.active { color: var(--accent); background: var(--input); }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.5rem 0.25rem;
            background: transparent;
            border: none;
            color: var(--dim);
            font: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.15s;
            border-bottom: 2px solid transparent;
        }

        .sidebar-tab:hover {
            color: var(--text);
            background: var(--panel);
        }

        .sidebar-tab.active {
            color: var(--accent);
            background: var(--panel);
            border-bottom-color: var(--accent);
        }

        .sidebar-panel {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-panel.active {
            display: flex;
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child { border-bottom: none; }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--dim);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title.collapsible {
            cursor: pointer;
            user-select: none;
        }

        .section-title.collapsible:hover {
            color: var(--text);
        }

        .section-title .toggle-icon {
            font-size: 0.6rem;
            display: inline-block;
            transition: transform 0.2s;
        }

        .section-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-title:not(.collapsed) .toggle-icon {
            transform: rotate(0deg);
        }

        .section-content {
            transition: max-height 0.2s ease-out;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0 !important;
            margin: 0;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }

        /* Config */
        textarea {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: none;
            line-height: 1.5;
        }

        textarea:focus { outline: none; border-color: var(--accent); }

        /* Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-zone:hover { border-color: var(--accent); background: rgba(88,166,255,0.05); }
        .upload-zone.has-file { border-color: var(--green); border-style: solid; }
        .upload-zone.dragover { border-color: var(--accent); background: rgba(88,166,255,0.1); }

        .upload-icon { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .upload-text { color: var(--dim); font-size: 0.75rem; }

        .file-info {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--input);
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        .file-info .name { color: var(--green); }
        .file-info .size { color: var(--dim); }

        /* Capabilities */
        .cap-list { display: flex; flex-direction: column; gap: 0.25rem; }

        .cap {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.5rem;
            background: var(--input);
            border-radius: 3px;
            font-size: 0.7rem;
            border-left: 2px solid var(--border);
        }

        .cap.ok { border-left-color: var(--green); }
        .cap.no { opacity: 0.35; }

        .cap input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .cap-name { flex: 1; }

        .lvl {
            font-size: 0.6rem;
            padding: 0.1rem 0.25rem;
            border-radius: 2px;
            background: var(--bg);
        }

        .lvl-0 { color: #58a6ff; } .lvl-1 { color: #56d4dd; }
        .lvl-2 { color: #d29922; } .lvl-3 { color: #bc8cff; }
        .lvl-4 { color: #f85149; }

        /* Buttons */
        .btn {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input);
            color: var(--text);
            font: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.15s;
        }

        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }

        /* Data Table */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            background: var(--panel);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            background: var(--input);
            color: var(--dim);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover td { background: rgba(88,166,255,0.05); }

        .null { color: var(--dim); font-style: italic; }
        .num { color: var(--green); }
        .str { color: var(--yellow); }

        /* Schema */
        .schema-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
        }

        .schema-name { flex: 1; }
        .schema-type {
            color: var(--purple);
            font-size: 0.7rem;
            background: var(--input);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        /* Query */
        .query-area {
            padding: 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .query-input {
            width: 100%;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: vertical;
            min-height: 80px;
        }

        .query-input:focus { outline: none; border-color: var(--accent); }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
        }

        .stat-card {
            background: var(--input);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .stat-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.1rem; font-weight: 500; margin-top: 0.25rem; }
        .stat-sub { font-size: 0.7rem; color: var(--dim); margin-top: 0.25rem; }

        /* Status Bar */
        #status {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 0.4rem 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .st { display: flex; align-items: center; gap: 0.4rem; }
        .st-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); }
        .st-dot.ok { background: var(--green); }
        .st-dot.warn { background: var(--yellow); }
        .st-dot.err { background: var(--red); }
        .st-label { color: var(--dim); }

        .level-bar { display: flex; gap: 2px; margin-left: auto; align-items: center; }
        .level-seg { width: 14px; height: 5px; background: var(--border); border-radius: 2px; }
        .level-seg.on { background: var(--accent); }
        .level-name { margin-left: 0.5rem; color: var(--dim); }

        #file-input { display: none; }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dim);
            gap: 0.5rem;
        }

        .empty-state-icon { font-size: 2.5rem; opacity: 0.3; }
        .empty-state-text { font-size: 0.85rem; }

        .toolbar {
            padding: 0.5rem 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toolbar-info { color: var(--dim); font-size: 0.75rem; margin-left: auto; }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--dim);
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Config Editor */
        .config-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }

        #config-editor {
            flex: 1;
            width: 100%;
            min-height: 400px;
            background: var(--input);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            line-height: 1.5;
            resize: none;
            tab-size: 2;
        }

        #config-editor:focus {
            outline: none;
            border-color: var(--accent);
        }

        .config-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .config-actions .btn-save {
            background: #1a6b3a;
            border-color: #2a8b4a;
        }

        .config-actions .btn-save:hover {
            background: #2a8b4a;
        }

        .validation-message {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .validation-message.valid {
            background: rgba(63, 185, 80, 0.15);
            color: var(--green);
        }

        .validation-message.invalid {
            background: rgba(248, 81, 73, 0.15);
            color: var(--red);
        }

        .validation-message.warning {
            background: rgba(210, 153, 34, 0.15);
            color: var(--yellow);
        }

        #config-file-input { display: none; }

        /* Pre-flight Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preflight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.4rem 0;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .preflight-item:last-child { border-bottom: none; }

        .preflight-icon { width: 16px; flex-shrink: 0; }
        .preflight-icon.ok { color: var(--green); }
        .preflight-icon.warn { color: var(--yellow); }
        .preflight-icon.err { color: var(--red); }

        .preflight-text { flex: 1; }
        .preflight-detail { color: var(--dim); font-size: 0.7rem; }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        .modal-actions .btn-danger {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        /* README styles */
        .readme-content {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text);
        }

        .readme-content h1 {
            font-size: 1.4rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin: 1.5rem 0 1rem 0;
            color: var(--text);
        }

        .readme-content h1:first-child {
            margin-top: 0;
        }

        .readme-content h2 {
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3rem;
            margin: 1.25rem 0 0.75rem 0;
            color: var(--text);
        }

        .readme-content h3 {
            font-size: 0.95rem;
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .readme-content p {
            margin: 0.5rem 0;
        }

        .readme-content code {
            background: var(--input);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
        }

        .readme-content pre {
            background: var(--input);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .readme-content pre code {
            background: none;
            padding: 0;
        }

        .readme-content ul, .readme-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .readme-content li {
            margin: 0.25rem 0;
        }

        .readme-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .readme-content a:hover {
            text-decoration: underline;
        }

        .readme-content blockquote {
            border-left: 3px solid var(--accent);
            margin: 0.75rem 0;
            padding: 0.5rem 1rem;
            background: var(--input);
            color: var(--dim);
        }

        .readme-content table {
            border-collapse: collapse;
            margin: 0.75rem 0;
            width: 100%;
        }

        .readme-content th, .readme-content td {
            border: 1px solid var(--border);
            padding: 0.4rem 0.6rem;
            text-align: left;
        }

        .readme-content th {
            background: var(--input);
        }

        /* Concierge Styles */
        .concierge-section {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05), rgba(188, 140, 255, 0.05));
            border-left: 2px solid var(--purple);
        }

        .concierge-panel {
            padding: 0.5rem;
            background: var(--input);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .concierge-report {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.7rem;
            line-height: 1.5;
        }

        .concierge-report h2 { font-size: 0.8rem; margin: 0.5rem 0 0.3rem 0; color: var(--accent); }
        .concierge-report h3 { font-size: 0.75rem; margin: 0.4rem 0 0.2rem 0; color: var(--text); }
        .concierge-report p { margin: 0.3rem 0; }
        .concierge-report ul { margin: 0.2rem 0; padding-left: 1rem; }
        .concierge-report li { margin: 0.1rem 0; }
        .concierge-report code { background: var(--bg); padding: 0.1rem 0.3rem; border-radius: 2px; }
        .concierge-report pre { background: var(--bg); padding: 0.5rem; border-radius: 4px; overflow-x: auto; margin: 0.3rem 0; }

        .concierge-chat {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .chat-message {
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            line-height: 1.4;
        }

        .chat-message.user {
            background: var(--accent);
            color: var(--bg);
            align-self: flex-end;
            max-width: 85%;
        }

        .chat-message.assistant {
            background: var(--input);
            color: var(--text);
            align-self: flex-start;
            max-width: 90%;
        }

        .chat-input-row {
            display: flex;
            gap: 0.3rem;
        }

        .chat-input {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.4rem 0.5rem;
            border-radius: 4px;
            font: inherit;
            font-size: 0.75rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--purple);
        }

        .concierge-loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--purple);
            font-size: 0.7rem;
        }

        .confidence-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.3rem;
        }

        .confidence-fill {
            height: 100%;
            background: var(--green);
            transition: width 0.3s;
        }

        .confidence-fill.medium { background: var(--yellow); }
        .confidence-fill.low { background: var(--red); }

        /* Tuning Section Styles */
        #sidebar-tuning .stat-card {
            background: var(--input);
            border-radius: 4px;
        }

        #sidebar-tuning .stat-label {
            font-size: 0.6rem;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        #sidebar-tuning .stat-value {
            font-size: 1rem;
            font-weight: 600;
        }

        #tuned-config-json {
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text);
            font-family: inherit;
        }

        .tuning-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo"><span>O</span><span>R</span><span>T</span><span>H</span><span>O</span><span>N</span></div>
            <div class="tagline">Not monitoring. <strong>Understanding.</strong></div>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('data')">Data</button>
            <button class="nav-tab" onclick="showView('config')">Config</button>
            <button class="nav-tab" onclick="showView('schema')">Schema</button>
            <button class="nav-tab" onclick="showView('query')">Query</button>
            <button class="nav-tab" onclick="showView('stats')">Stats</button>
            <button class="nav-tab" onclick="showView('readme')">README</button>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="showSidebarTab('inputs')">Inputs</button>
                <button class="sidebar-tab" onclick="showSidebarTab('analysis')">Analysis</button>
                <button class="sidebar-tab" onclick="showSidebarTab('results')">Results</button>
                <button class="sidebar-tab" onclick="showSidebarTab('tuning')" id="tuning-tab">Tuning</button>
                <button class="sidebar-tab" onclick="showSidebarTab('ai')" id="ai-tab" style="display: none;">AI</button>
            </div>

            <!-- INPUTS TAB -->
            <div class="sidebar-panel active" id="sidebar-inputs">
                <!-- Data File -->
                <div class="sidebar-section">
                    <div class="section-title">Data File</div>
                    <div class="upload-zone" id="dropzone" onclick="$('file-input').click()">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Drop file or click</div>
                    </div>
                    <input type="file" id="file-input" accept=".parquet,.csv,.xlsx,.txt,.tsv" onchange="onFile(this)">
                    <div id="file-info" class="file-info" style="display:none"></div>
                </div>

                <!-- Config File -->
                <div class="sidebar-section">
                    <div class="section-title">Config File <span style="color: var(--dim); font-weight: normal;">(optional)</span></div>
                    <div class="upload-zone" id="config-dropzone" onclick="$('config-file-input').click()" style="padding: 0.75rem;">
                        <div class="upload-text">Drop JSON/YAML or click</div>
                    </div>
                    <div id="config-file-info" class="file-info" style="display:none"></div>
                </div>

                <!-- Analysis Settings -->
                <div class="sidebar-section">
                    <div class="section-title">Analysis Settings</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="font-size: 0.65rem; color: var(--dim); display: block; margin-bottom: 0.2rem;">Window Size</label>
                                <input type="number" id="window-size" value="50" min="5" style="width: 100%; background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.65rem; color: var(--dim); display: block; margin-bottom: 0.2rem;">Stride</label>
                                <input type="number" id="window-stride" value="25" min="1" style="width: 100%; background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 0.65rem; color: var(--dim); display: block; margin-bottom: 0.2rem;">Discipline</label>
                            <select id="discipline-select" style="width: 100%; background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                                <option value="" selected>Core Analysis (no physics)</option>
                                <option value="thermodynamics">Thermodynamics</option>
                                <option value="transport">Transport Phenomena</option>
                                <option value="reaction">Reaction Engineering</option>
                                <option value="controls">Process Control</option>
                                <option value="mechanics">Mechanical Systems</option>
                                <option value="electrical">Electrical Systems</option>
                                <option value="fluid_dynamics">Fluid Dynamics</option>
                                <option value="separations">Separations</option>
                                <option value="phase_equilibria">Phase Equilibria</option>
                                <option value="balances">Material & Energy Balances</option>
                                <option value="electrochemistry">Electrochemistry</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Constants -->
                <div class="sidebar-section">
                    <div class="section-title">Constants <span style="color: var(--dim); font-weight: normal;">(optional)</span></div>
                    <div id="constants-panel" style="padding: 0.5rem; background: var(--input); border-radius: 4px;">
                        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 0.3rem; font-size: 0.7rem;">
                            <label style="color: var(--dim); align-self: center;">Density (kg/m¬≥)</label>
                            <input type="number" id="const-density" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Viscosity (Pa¬∑s)</label>
                            <input type="number" id="const-viscosity" placeholder="‚Äî" step="0.0001" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Diameter (m)</label>
                            <input type="number" id="const-diameter" placeholder="‚Äî" step="0.001" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Pipe Length (m)</label>
                            <input type="number" id="const-length" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Temperature (K)</label>
                            <input type="number" id="const-temperature" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Pressure (Pa)</label>
                            <input type="number" id="const-pressure" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.6rem; color: var(--dim);">
                            Constants unlock physics engines
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYSIS TAB -->
            <div class="sidebar-panel" id="sidebar-analysis">
                <!-- Detected Structure -->
                <div class="sidebar-section" id="inspection-section">
                    <div class="section-title">
                        Detected Structure
                        <span id="inspection-level" style="font-size: 0.65rem; padding: 0.1rem 0.3rem; background: var(--accent); color: var(--bg); border-radius: 3px; margin-left: 0.5rem;">‚Äî</span>
                    </div>
                    <div id="inspection-content" style="font-size: 0.7rem;">
                        <div style="color: var(--dim);">Load a data file to see structure</div>
                    </div>
                </div>

                <!-- Capabilities -->
                <div class="sidebar-section">
                    <div class="section-title">
                        Capabilities
                        <span id="cap-count" style="margin-left: 0.5rem;">‚Äî</span>
                    </div>
                    <div class="cap-list" id="caps"></div>
                </div>

                <!-- Analyze Button -->
                <div class="sidebar-section">
                    <button class="btn btn-primary" id="analyze-btn" onclick="analyzeWithPRISM()" disabled style="width: 100%;">Analyze with PRISM</button>
                    <div id="prism-progress" style="display: none; margin-top: 0.5rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span id="prism-progress-text">Sending to PRISM...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTS TAB -->
            <div class="sidebar-panel" id="sidebar-results">
                <!-- Load External Results -->
                <div class="sidebar-section">
                    <div class="section-title">Load External Results</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <input type="text" id="results-path-input" placeholder="/path/to/prism-results" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <button class="btn" onclick="loadExternalResults()" style="width: 100%;">Load Parquets</button>
                        <div id="load-results-status" style="font-size: 0.7rem; color: var(--dim);"></div>
                    </div>
                </div>

                <!-- Download Results -->
                <div class="sidebar-section" id="download-section" style="display: none;">
                    <div class="section-title">Download</div>
                    <button class="btn" onclick="downloadResults()" style="width: 100%;">Download Results (.zip)</button>
                </div>

                <!-- Create Markdowns -->
                <div class="sidebar-section">
                    <div class="section-title">
                        Create Markdowns
                        <span id="md-count" style="margin-left: 0.5rem; color: var(--dim);">0 selected</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn btn-sm" onclick="selectAllMarkdowns(true)" style="flex:1;">All</button>
                        <button class="btn btn-sm" onclick="selectAllMarkdowns(false)" style="flex:1;">None</button>
                    </div>
                    <div class="cap-list" id="markdown-list" style="max-height: 200px; overflow-y: auto;"></div>
                    <div class="actions" style="margin-top: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateMarkdowns()" style="width: 100%;">Generate Markdowns</button>
                    </div>
                    <div id="markdown-status" style="font-size: 0.7rem; color: var(--dim); margin-top: 0.5rem;"></div>
                </div>
            </div>

            <!-- TUNING TAB -->
            <div class="sidebar-panel" id="sidebar-tuning">
                <!-- Labels Detection -->
                <div class="sidebar-section">
                    <div class="section-title">
                        Ground Truth Labels
                        <span id="labels-count" style="margin-left: 0.5rem; color: var(--dim);">‚Äî</span>
                    </div>
                    <div id="labels-info" style="font-size: 0.7rem; color: var(--dim);">
                        Upload data with label columns (anomaly, changepoint, fault) to enable tuning.
                    </div>
                    <div id="labels-list" style="display: none; margin-top: 0.5rem;"></div>
                </div>

                <!-- Tuning Analysis -->
                <div class="sidebar-section">
                    <div class="section-title">
                        Tuning Analysis
                        <span id="tuning-status-badge" style="font-size: 0.6rem; padding: 0.1rem 0.3rem; background: var(--border); color: var(--dim); border-radius: 3px; margin-left: 0.5rem;">Not Run</span>
                    </div>
                    <button class="btn btn-primary" id="run-tuning-btn" onclick="runTuningAnalysis()" style="width: 100%;">
                        Run Tuning Analysis
                    </button>
                    <div id="tuning-progress" style="display: none; margin-top: 0.5rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Analyzing detection vs ground truth...</span>
                        </div>
                    </div>
                </div>

                <!-- Optimal Threshold -->
                <div class="sidebar-section" id="threshold-section" style="display: none;">
                    <div class="section-title">Optimal Threshold</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="stat-card" style="padding: 0.5rem;">
                            <div class="stat-label">Z-Warning</div>
                            <div class="stat-value" id="optimal-z-warning" style="color: var(--yellow);">‚Äî</div>
                        </div>
                        <div class="stat-card" style="padding: 0.5rem;">
                            <div class="stat-label">Z-Critical</div>
                            <div class="stat-value" id="optimal-z-critical" style="color: var(--red);">‚Äî</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="stat-card" style="padding: 0.5rem;">
                            <div class="stat-label">Detection Rate</div>
                            <div class="stat-value" id="detection-rate" style="color: var(--green);">‚Äî</div>
                        </div>
                        <div class="stat-card" style="padding: 0.5rem;">
                            <div class="stat-label">Avg Lead Time</div>
                            <div class="stat-value" id="avg-lead-time" style="color: var(--accent);">‚Äî</div>
                        </div>
                    </div>
                </div>

                <!-- Best Metrics by Fault Type -->
                <div class="sidebar-section" id="signatures-section" style="display: none;">
                    <div class="section-title">Best Metrics by Fault Type</div>
                    <div id="fault-signatures" style="font-size: 0.7rem;"></div>
                </div>

                <!-- Metric Rankings -->
                <div class="sidebar-section" id="rankings-section" style="display: none;">
                    <div class="section-title collapsible" onclick="toggleSection(this)">
                        Metric Rankings
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="metric-rankings" style="font-size: 0.7rem; max-height: 200px; overflow-y: auto;"></div>
                </div>

                <!-- Generate Config -->
                <div class="sidebar-section" id="generate-config-section" style="display: none;">
                    <div class="section-title">Apply Tuning</div>
                    <button class="btn" onclick="generateTunedConfig()" style="width: 100%;">
                        Generate Tuned Config
                    </button>
                    <div id="tuned-config-result" style="display: none; margin-top: 0.5rem;">
                        <pre id="tuned-config-json" style="background: var(--input); padding: 0.5rem; border-radius: 4px; font-size: 0.65rem; max-height: 150px; overflow: auto;"></pre>
                        <button class="btn btn-sm" onclick="copyTunedConfig()" style="margin-top: 0.3rem;">Copy Config</button>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="sidebar-section" id="recommendations-section" style="display: none;">
                    <div class="section-title collapsible" onclick="toggleSection(this)">
                        Recommendations
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content readme-content" id="tuning-recommendations" style="font-size: 0.7rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- AI TAB -->
            <div class="sidebar-panel" id="sidebar-ai">
                <div class="sidebar-section concierge-section" id="concierge-section">
                    <div class="section-title">
                        AI Concierge
                        <span id="concierge-badge" style="font-size: 0.6rem; padding: 0.1rem 0.3rem; background: var(--purple); color: var(--bg); border-radius: 3px; margin-left: 0.5rem;">AI</span>
                    </div>

                    <!-- Validation Report -->
                    <div id="concierge-validation-panel" class="concierge-panel" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                            <span style="font-size: 0.65rem; color: var(--dim); text-transform: uppercase;">Data Analysis</span>
                            <span id="concierge-confidence" style="font-size: 0.6rem; color: var(--green);"></span>
                        </div>
                        <div class="confidence-bar">
                            <div id="confidence-fill" class="confidence-fill" style="width: 0%;"></div>
                        </div>
                        <div id="concierge-report" class="concierge-report" style="margin-top: 0.5rem;"></div>
                    </div>

                    <!-- Suggested Config -->
                    <div id="concierge-config-panel" style="display: none; margin-bottom: 0.5rem;">
                        <button class="btn btn-sm" onclick="applyConciergeConfig()" style="width: 100%;">Apply Suggested Config</button>
                    </div>

                    <!-- Loading State -->
                    <div id="concierge-loading" class="concierge-loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Analyzing data...</span>
                    </div>

                    <!-- Chat Interface -->
                    <div id="concierge-chat" class="concierge-chat" style="display: none;">
                        <div style="font-size: 0.65rem; color: var(--dim); text-transform: uppercase; margin-bottom: 0.2rem;">Ask about your data</div>
                        <div id="chat-messages" class="chat-messages"></div>
                        <div class="chat-input-row">
                            <input type="text" id="chat-input" class="chat-input" placeholder="What patterns do you see?" onkeypress="if(event.key==='Enter') askConcierge()">
                            <button class="btn btn-sm" onclick="askConcierge()">Ask</button>
                        </div>
                        <button class="btn btn-sm" onclick="interpretResults()" style="margin-top: 0.3rem; width: 100%; background: rgba(188, 140, 255, 0.15); border-color: var(--purple); color: var(--purple);">Interpret Analysis Results</button>
                    </div>

                    <!-- Ready Message (shown when AI available but no file) -->
                    <div id="concierge-ready" style="font-size: 0.7rem; color: var(--dim);">
                        <span style="color: var(--green);">‚úì AI Ready</span>
                        <div style="margin-top: 0.3rem; font-size: 0.65rem;">Upload a file to analyze with AI</div>
                    </div>

                    <!-- No API Key Message -->
                    <div id="concierge-unavailable" style="font-size: 0.7rem; color: var(--dim); display: none;">
                        <span>AI assistance unavailable</span>
                        <div style="margin-top: 0.3rem; font-size: 0.65rem;">Set ANTHROPIC_API_KEY to enable</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Data View -->
            <div class="view active" id="view-data">
                <div class="toolbar">
                    <span style="color: var(--dim)">Table:</span>
                    <select id="table-select" onchange="loadTable(this.value)" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <option value="">‚Äî Select ‚Äî</option>
                    </select>
                    <button class="btn btn-sm" onclick="refreshTable()">Refresh</button>
                    <div class="toolbar-info" id="row-count"></div>
                </div>
                <div class="table-wrapper" id="table-wrapper">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Load a parquet file to view data</div>
                    </div>
                </div>
            </div>

            <!-- Config View -->
            <div class="view" id="view-config">
                <div class="config-editor-container">
                    <textarea id="config-editor" spellcheck="false"></textarea>
                    <div class="config-actions">
                        <label class="btn" style="cursor: pointer;">
                            Load File
                            <input type="file" id="config-file-input" accept=".json,.yaml,.yml">
                        </label>
                        <button class="btn btn-save" id="config-save">Save</button>
                        <button class="btn" id="config-reset">Reset to Example</button>
                    </div>
                    <div id="config-validation" class="validation-message"></div>
                </div>
            </div>

            <!-- Schema View -->
            <div class="view" id="view-schema">
                <div class="toolbar">
                    <span style="color: var(--dim)">Schema for loaded table</span>
                </div>
                <div id="schema-list" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Load a file to view schema</div>
                    </div>
                </div>
            </div>

            <!-- Query View -->
            <div class="view" id="view-query">
                <div class="query-area">
                    <div style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--dim); margin-right: 0.5rem;">Preset Queries:</label>
                        <select id="query-select" onchange="loadPresetQuery(this.value)" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.7rem; min-width: 200px;">
                            <option value="">-- Custom SQL --</option>
                        </select>
                    </div>
                    <textarea id="query-input" class="query-input" placeholder="SELECT * FROM data LIMIT 100"></textarea>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="runQuery()">Run Query</button>
                        <button class="btn" onclick="$('query-input').value = 'SELECT * FROM data LIMIT 100'; $('query-select').value = '';">Reset</button>
                    </div>
                </div>
                <div class="table-wrapper" id="query-results">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <div class="empty-state-text">Run a SQL query</div>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div class="view" id="view-stats">
                <div id="stats-container" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div class="empty-state-text">Load data to view statistics</div>
                    </div>
                </div>
            </div>

            <!-- README View -->
            <div class="view" id="view-readme">
                <div id="readme-container" style="overflow: auto; flex: 1; padding: 1rem;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <div class="empty-state-text">Loading README...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="status">
        <div class="st">
            <div class="st-dot" id="prism-dot"></div>
            <span class="st-label">PRISM:</span>
            <span id="prism-st">Checking...</span>
        </div>
        <div class="st">
            <div class="st-dot" id="cfg-dot"></div>
            <span class="st-label">Config:</span>
            <span id="cfg-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="data-dot"></div>
            <span class="st-label">Data:</span>
            <span id="data-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="db-dot"></div>
            <span class="st-label">DuckDB:</span>
            <span id="db-st">Loading...</span>
        </div>
        <div class="st">
            <div class="st-dot" id="concierge-dot"></div>
            <span class="st-label">AI:</span>
            <span id="concierge-st">‚Äî</span>
        </div>
        <div class="level-bar">
            <span class="st-label">Engines:</span>
            <span class="level-name" id="engine-count-status">‚Äî</span>
        </div>
    </div>

    <!-- Pre-flight Modal -->
    <div class="modal-overlay" id="preflight-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-title">Pre-flight Check</div>
            <div id="preflight-results"></div>

            <!-- Manifest Preview -->
            <div id="manifest-preview" style="margin-top: 12px; display: none;">
                <div class="section-title collapsible" onclick="toggleManifestPreview()" style="cursor: pointer; padding: 0.5rem; background: var(--input); border-radius: 4px;">
                    <span><span class="toggle-icon" id="manifest-toggle-icon">‚ñ∂</span> Engine Manifest</span>
                    <span id="manifest-engine-count" style="font-size: 0.65rem; padding: 0.1rem 0.3rem; background: var(--accent); color: var(--bg); border-radius: 3px;">‚Äî</span>
                </div>
                <div id="manifest-content" style="display: none; margin-top: 8px; max-height: 300px; overflow-y: auto;">
                    <!-- Filled by JS -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="closePreflightModal()">Cancel</button>
                <button class="btn" id="preflight-fix-btn" onclick="closePreflightModal(); showView('config');" style="display:none;">Fix Config</button>
                <button class="btn" id="preflight-ai-btn" onclick="autoFixWithAI()" style="background: rgba(188, 140, 255, 0.15); border-color: var(--purple); color: var(--purple);">ü§ñ Auto-fix with AI</button>
                <button class="btn btn-primary" id="preflight-submit-btn" onclick="submitToPRISM()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Unit Assignment Modal -->
    <div class="modal-overlay" id="unit-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-title">Assign Units to Sensors</div>
            <div style="margin-bottom: 12px; color: var(--dim);">
                Units are required for all sensors. Select from common units or enter custom.
            </div>
            <div id="unit-assignment-list" style="max-height: 400px; overflow-y: auto;"></div>
            <div id="llm-suggest-section" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: none;">
                <button class="btn" onclick="suggestUnitsWithLLM()">Suggest Units with AI</button>
                <span id="llm-status" style="margin-left: 8px; color: var(--dim);"></span>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeUnitModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyUnits()">Apply Units</button>
            </div>
        </div>
    </div>

<script src="/static/orthon-queries.js"></script>
<script type="module">
import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

const $ = id => document.getElementById(id);
window.$ = $;

// XSS prevention - escape HTML in user content
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Toggle collapsible sections
function toggleSection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    if (content.style.display === 'none' || content.classList.contains('collapsed')) {
        content.style.display = 'block';
        content.classList.remove('collapsed');
        if (icon) icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        content.classList.add('collapsed');
        if (icon) icon.textContent = '‚ñ∂';
    }
}
window.toggleSection = toggleSection;

// =====================================================================
// DUCKDB SETUP
// =====================================================================

let db = null;
let conn = null;

async function initDuckDB() {
    try {
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        const worker_url = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
        );

        const worker = new Worker(worker_url);
        const logger = new duckdb.ConsoleLogger();
        db = new duckdb.AsyncDuckDB(logger, worker);

        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        conn = await db.connect();

        setSt('db', 'Ready', 'ok');

        URL.revokeObjectURL(worker_url);
    } catch (e) {
        console.error('DuckDB init failed:', e);
        setSt('db', 'Error', 'err');
    }
}

// =====================================================================
// FILE HANDLING
// =====================================================================

let currentFile = null;
let currentTable = 'data';

window.onFile = async function(input) {
    const file = input.files[0];
    if (!file || !conn) return;

    currentFile = file;

    $('dropzone').classList.add('has-file');
    $('file-info').style.display = 'flex';
    $('file-info').innerHTML = `<span class="name">${escapeHtml(file.name)}</span><span class="size">${(file.size/1024).toFixed(1)} KB</span>`;
    setSt('data', file.name, 'ok');

    // Load into DuckDB
    try {
        const buffer = await file.arrayBuffer();
        await db.registerFileBuffer(file.name, new Uint8Array(buffer));

        if (file.name.endsWith('.parquet')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_parquet('${file.name}')`);
        } else if (file.name.endsWith('.csv')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_csv_auto('${file.name}')`);
        }

        // Update table select
        $('table-select').innerHTML = '<option value="data">data</option>';
        $('table-select').value = 'data';

        await loadTable('data');
        await loadSchema();
        await loadStats();

        // Enable analyze button
        updateAnalyzeButton();

        // Inspect file for capabilities
        await inspectFile(file);

    } catch (e) {
        console.error('File load error:', e);
        setSt('data', 'Error: ' + e.message, 'err');
    }
};

async function loadTable(tableName) {
    if (!conn || !tableName) return;

    currentTable = tableName;

    try {
        const result = await conn.query(`SELECT * FROM ${tableName} LIMIT 1000`);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('table-wrapper', columns, rows);
        $('row-count').textContent = `${rows.length} rows (limited)`;

    } catch (e) {
        console.error('Query error:', e);
        $('table-wrapper').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${escapeHtml(e.message)}</div></div>`;
    }
}
window.loadTable = loadTable;

async function loadSchema() {
    if (!conn) return;

    try {
        const result = await conn.query(`DESCRIBE ${currentTable}`);
        const rows = result.toArray();

        let html = '';
        for (const row of rows) {
            html += `
                <div class="schema-item">
                    <span class="schema-name">${escapeHtml(row.column_name)}</span>
                    <span class="schema-type">${escapeHtml(row.column_type)}</span>
                </div>
            `;
        }

        $('schema-list').innerHTML = html || '<div class="empty-state"><div class="empty-state-text">No columns</div></div>';

    } catch (e) {
        console.error('Schema error:', e);
    }
}

async function loadStats() {
    if (!conn) return;

    try {
        // Get row count
        const countResult = await conn.query(`SELECT COUNT(*) as cnt FROM ${currentTable}`);
        const rowCount = countResult.toArray()[0].cnt;

        // Get column stats
        const descResult = await conn.query(`DESCRIBE ${currentTable}`);
        const columns = descResult.toArray();

        let html = '<div class="stats-grid">';

        html += `
            <div class="stat-card">
                <div class="stat-label">Total Rows</div>
                <div class="stat-value">${Number(rowCount).toLocaleString()}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Columns</div>
                <div class="stat-value">${columns.length}</div>
            </div>
        `;

        // Index column info from inspection
        if (lastInspection) {
            const indexCol = lastInspection.sequence_column;
            const indexSignal = lastInspection.signals?.find(s => s.name === indexCol);
            const indexUnit = indexSignal?.unit || 'none';
            const indexQty = indexSignal?.quantity || 'sequence';

            html += `
                <div class="stat-card" style="border-left: 3px solid var(--accent);">
                    <div class="stat-label">Index Column</div>
                    <div class="stat-value">${escapeHtml(indexCol || 'auto')}</div>
                    <div class="stat-sub">Unit: ${escapeHtml(indexUnit)} (${escapeHtml(indexQty)})</div>
                </div>
            `;

            // Entity info
            if (lastInspection.entity_column) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Entity Column</div>
                        <div class="stat-value">${escapeHtml(lastInspection.entity_column)}</div>
                        <div class="stat-sub">${lastInspection.entities?.length || 1} entities</div>
                    </div>
                `;
            }

            // Quantities detected
            if (lastInspection.quantities_detected?.length > 0) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Quantities Detected</div>
                        <div class="stat-value">${lastInspection.quantities_detected.length}</div>
                        <div class="stat-sub">${escapeHtml(lastInspection.quantities_detected.slice(0, 3).join(', '))}${lastInspection.quantities_detected.length > 3 ? '...' : ''}</div>
                    </div>
                `;
            }

            // Constants
            const constCount = Object.keys(lastInspection.constants || {}).length;
            if (constCount > 0) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Constants</div>
                        <div class="stat-value">${constCount}</div>
                        <div class="stat-sub">${escapeHtml(Object.keys(lastInspection.constants).slice(0, 3).join(', '))}</div>
                    </div>
                `;
            }
        }

        // Get numeric column stats
        const numericCols = columns.filter(c =>
            c.column_type.includes('INT') ||
            c.column_type.includes('FLOAT') ||
            c.column_type.includes('DOUBLE') ||
            c.column_type.includes('DECIMAL')
        );

        for (const col of numericCols.slice(0, 8)) {
            try {
                const statsResult = await conn.query(`
                    SELECT
                        MIN("${col.column_name}") as min_val,
                        MAX("${col.column_name}") as max_val,
                        AVG("${col.column_name}") as avg_val,
                        COUNT(*) - COUNT("${col.column_name}") as null_count
                    FROM ${currentTable}
                `);
                const stats = statsResult.toArray()[0];

                html += `
                    <div class="stat-card">
                        <div class="stat-label">${escapeHtml(col.column_name)}</div>
                        <div class="stat-value">${formatNum(stats.avg_val)}</div>
                        <div class="stat-sub">${formatNum(stats.min_val)} ‚Üí ${formatNum(stats.max_val)}</div>
                    </div>
                `;
            } catch (e) {
                // Skip problematic columns
            }
        }

        html += '</div>';
        $('stats-container').innerHTML = html;

    } catch (e) {
        console.error('Stats error:', e);
    }
}

function formatNum(n) {
    if (n === null || n === undefined) return '‚Äî';
    if (typeof n === 'bigint') n = Number(n);
    if (Math.abs(n) > 1000000) return n.toExponential(2);
    if (Math.abs(n) < 0.01 && n !== 0) return n.toExponential(2);
    return Number(n).toLocaleString(undefined, { maximumFractionDigits: 4 });
}

window.runQuery = async function() {
    if (!conn) return;

    const query = $('query-input').value;

    try {
        const result = await conn.query(query);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('query-results', columns, rows);

    } catch (e) {
        $('query-results').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${escapeHtml(e.message)}</div></div>`;
    }
};

window.refreshTable = () => loadTable(currentTable);

function renderTable(containerId, columns, rows) {
    let html = '<table><thead><tr>';

    for (const col of columns) {
        html += `<th>${escapeHtml(col)}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
            const val = row[col];
            let cellClass = '';
            let display = '';

            if (val === null || val === undefined) {
                cellClass = 'null';
                display = 'NULL';
            } else if (typeof val === 'number' || typeof val === 'bigint') {
                cellClass = 'num';
                display = formatNum(val);
            } else {
                cellClass = 'str';
                display = escapeHtml(String(val).slice(0, 100));
            }

            html += `<td class="${cellClass}">${display}</td>`;
        }
        html += '</tr>';
    }

    html += '</tbody></table>';
    $(containerId).innerHTML = html;
}

// =====================================================================
// VIEW NAVIGATION
// =====================================================================

let readmeLoaded = false;

window.showView = function(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

    $('view-' + view).classList.add('active');
    event.target.classList.add('active');

    // Load README on first view
    if (view === 'readme' && !readmeLoaded) {
        loadReadme();
    }
};

// =====================================================================
// SIDEBAR TAB NAVIGATION
// =====================================================================

window.showSidebarTab = function(tab) {
    // Update tab buttons
    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    // Update panels
    document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
    const panel = $('sidebar-' + tab);
    if (panel) panel.classList.add('active');
};

// =====================================================================
// README
// =====================================================================

async function loadReadme() {
    const container = $('readme-container');

    try {
        // Try fetching from GitHub raw URL first (for repo README)
        const urls = [
            '/static/README.md',
            '/README.md',
            'https://raw.githubusercontent.com/prism-engines/orthon/main/README.md',
        ];

        let content = null;
        for (const url of urls) {
            try {
                const r = await fetch(url);
                if (r.ok) {
                    content = await r.text();
                    break;
                }
            } catch (e) {
                continue;
            }
        }

        if (!content) {
            // Fallback content
            content = `# ORTHON

Diagnostic interpreter for PRISM outputs.

## Overview

ORTHON is the intelligent orchestration layer for PRISM compute engines.

### Key Features

- **File Inspection**: Automatically detect units, constants, and sensor types
- **Pre-flight Validation**: Verify data before sending to PRISM
- **SQL Queries**: Run DuckDB queries against results
- **Physics Routing**: Route to appropriate engines based on detected quantities

## Usage

1. Upload a data file (CSV, Parquet, or Excel)
2. Review detected structure and constants
3. Configure window parameters
4. Click "Analyze with PRISM"
5. Explore results with SQL queries

## Architecture

\`\`\`
User ‚Üí ORTHON (gatekeeper) ‚Üí PRISM (compute) ‚Üí ORTHON (results)
\`\`\`

PRISM stays dumb, ORTHON does the thinking.
`;
        }

        // Simple markdown rendering
        const html = renderMarkdown(content);
        container.innerHTML = `<div class="readme-content">${html}</div>`;
        readmeLoaded = true;

    } catch (e) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error loading README: ${escapeHtml(e.message)}</div></div>`;
    }
}

function renderMarkdown(md) {
    // Simple markdown to HTML converter
    let html = escapeHtml(md);

    // Code blocks (``` ... ```)
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Headers
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

    // Bold and italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

    // Unordered lists
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

    // Blockquotes
    html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

    // Paragraphs (double newlines)
    html = html.replace(/\n\n+/g, '</p><p>');
    html = '<p>' + html + '</p>';

    // Clean up empty paragraphs and fix structure
    html = html.replace(/<p>\s*<(h[123]|ul|pre|blockquote)/g, '<$1');
    html = html.replace(/<\/(h[123]|ul|pre|blockquote)>\s*<\/p>/g, '</$1>');
    html = html.replace(/<p>\s*<\/p>/g, '');

    return html;
}

// =====================================================================
// ENGINES / CAPABILITIES (Manifest-Based)
// =====================================================================

// Friendly labels for engine names
const ENGINE_LABELS = {
    // Signal-level engines
    'rms': 'RMS',
    'peak': 'Peak Value',
    'kurtosis': 'Kurtosis',
    'skewness': 'Skewness',
    'hurst': 'Hurst (Memory)',
    'entropy': 'Entropy',
    'lyapunov': 'Lyapunov (Chaos)',
    'spectral': 'Spectral',
    'garch': 'Volatility (GARCH)',
    'fft': 'FFT',
    'envelope': 'Envelope',
    'crest_factor': 'Crest Factor',
    'pulsation_index': 'Pulsation Index',
    'rate_of_change': 'Rate of Change',
    'time_constant': 'Time Constant',
    'harmonics': 'Harmonics',
    'thd': 'THD',
    'order_analysis': 'Order Analysis',
    'trend': 'Trend',

    // Pair directional
    'granger': 'Granger Causality',
    'transfer_entropy': 'Transfer Entropy',

    // Pair symmetric
    'correlation': 'Correlation',
    'mutual_info': 'Mutual Information',
    'cointegration': 'Cointegration',

    // Windowed
    'derivatives': 'Derivatives',
    'stability': 'Stability',
    'manifold': 'Manifold',
    'rolling_mean': 'Rolling Mean',
    'rolling_std': 'Rolling Std',
    'rolling_rms': 'Rolling RMS',
    'rolling_range': 'Rolling Range',
    'rolling_pulsation': 'Rolling Pulsation',
    'rolling_peak': 'Rolling Peak',
    'rolling_crest': 'Rolling Crest',

    // SQL
    'zscore': 'Z-Score',
    'statistics': 'Statistics',
};

// Engine group metadata
const ENGINE_GROUPS = {
    signal: { label: 'Sensor', color: 'var(--green)', icon: '‚îÅ' },
    pair: { label: 'Pair ‚Üí', color: 'var(--accent)', icon: '‚Üí' },
    symmetric_pair: { label: 'Pair ‚Üî', color: 'var(--purple)', icon: '‚Üî' },
    windowed: { label: 'Windowed', color: 'var(--yellow)', icon: '‚ñ§' },
    sql: { label: 'SQL', color: 'var(--dim)', icon: '‚ñ¶' },
};

// Engine run status (updated after PRISM completes)
let engineStatus = {};  // { engineName: 'pending' | 'computed' | 'failed' | 'skipped' }

function getEngineLabel(name) {
    return ENGINE_LABELS[name] || name;
}

function renderEnginesFromManifest(manifest) {
    const el = $('caps');

    if (!manifest || !manifest.engines) {
        el.innerHTML = '<div style="color: var(--dim); font-size: 0.7rem;">Load data to see available engines</div>';
        $('cap-count').textContent = '‚Äî';
        return;
    }

    let html = '';
    let totalEngines = 0;
    let computedCount = 0;

    for (const [groupKey, groupInfo] of Object.entries(ENGINE_GROUPS)) {
        const engines = manifest.engines[groupKey] || [];
        if (engines.length === 0) continue;

        totalEngines += engines.length;

        html += `<div class="engine-group" style="margin-bottom: 0.5rem;">`;
        html += `<div style="font-size: 0.6rem; color: ${groupInfo.color}; margin-bottom: 0.2rem; text-transform: uppercase; letter-spacing: 0.05em;">`;
        html += `${groupInfo.icon} ${groupInfo.label} (${engines.length})`;
        html += `</div>`;

        for (const engine of engines) {
            const status = engineStatus[engine] || 'pending';
            const label = getEngineLabel(engine);

            let icon = '‚óã';
            let iconColor = 'var(--dim)';
            if (status === 'computed') {
                icon = '‚úì';
                iconColor = 'var(--green)';
                computedCount++;
            } else if (status === 'failed') {
                icon = '‚úó';
                iconColor = 'var(--red)';
            } else if (status === 'running') {
                icon = '‚ü≥';
                iconColor = 'var(--accent)';
            }

            html += `<div class="cap" style="padding: 0.15rem 0;">`;
            html += `<span style="width: 14px; color: ${iconColor};">${icon}</span>`;
            html += `<span class="cap-name" style="font-size: 0.7rem;">${escapeHtml(label)}</span>`;
            html += `</div>`;
        }

        html += `</div>`;
    }

    el.innerHTML = html;

    // Update sidebar count
    if (computedCount > 0) {
        $('cap-count').textContent = `${computedCount}/${totalEngines}`;
    } else {
        $('cap-count').textContent = totalEngines.toString();
    }

    // Update status bar engine count
    const statusEl = $('engine-count-status');
    if (statusEl) {
        if (computedCount > 0) {
            statusEl.textContent = `${computedCount}/${totalEngines} done`;
            statusEl.style.color = 'var(--green)';
        } else {
            statusEl.textContent = `${totalEngines} ready`;
            statusEl.style.color = 'var(--text)';
        }
    }
}

// Update engine status after PRISM completes
function updateEngineStatus(results) {
    engineStatus = {};
    if (!results) return;

    // Mark all engines in results
    for (const result of results) {
        if (result.engine) {
            engineStatus[result.engine] = result.status || 'computed';
        }
    }

    // Re-render if we have a manifest
    if (lastManifest) {
        renderEnginesFromManifest(lastManifest);
    }
}

// Mark all engines as computed (when PRISM returns successfully)
function markAllEnginesComputed() {
    if (!lastManifest || !lastManifest.engines) return;

    for (const groupKey of Object.keys(ENGINE_GROUPS)) {
        const engines = lastManifest.engines[groupKey] || [];
        for (const engine of engines) {
            engineStatus[engine] = 'computed';
        }
    }

    renderEnginesFromManifest(lastManifest);
}

function setSt(id, txt, state) {
    $(id + '-dot').className = 'st-dot' + (state ? ' ' + state : '');
    $(id + '-st').textContent = txt;
}
window.setSt = setSt;

window.checkCapabilities = function() {
    // Render engines from manifest (built during inspection)
    if (lastManifest) {
        renderEnginesFromManifest(lastManifest);
    } else {
        const el = $('caps');
        el.innerHTML = '<div style="color: var(--dim); font-size: 0.7rem;">Load data to see available engines</div>';
        $('cap-count').textContent = '‚Äî';
    }
};

// Drag and drop - Data
const dz = $('dropzone');
dz.ondragover = e => { e.preventDefault(); dz.classList.add('dragover'); };
dz.ondragleave = () => dz.classList.remove('dragover');
dz.ondrop = e => {
    e.preventDefault();
    dz.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
        $('file-input').files = e.dataTransfer.files;
        onFile($('file-input'));
    }
};

// Drag and drop - Config
const cdz = $('config-dropzone');
cdz.ondragover = e => { e.preventDefault(); cdz.classList.add('dragover'); };
cdz.ondragleave = () => cdz.classList.remove('dragover');
cdz.ondrop = e => {
    e.preventDefault();
    cdz.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
        cdz.classList.add('has-file');
        loadConfigFile(file);
    }
};

function loadConfigFile(file) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const content = event.target.result;
        let config;

        try {
            if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) {
                config = parseSimpleYAML(content);
            } else {
                config = JSON.parse(content);
            }

            const editor = $('config-editor');
            editor.value = JSON.stringify(config, null, 2);
            validateConfigEditor(editor.value);
            checkCapabilities();

            // Show file info and green border
            const cdz = $('config-dropzone');
            if (cdz) cdz.classList.add('has-file');
            $('config-file-info').style.display = 'flex';
            $('config-file-info').innerHTML = `<span class="name">${escapeHtml(file.name)}</span><span class="size">${(file.size/1024).toFixed(1)} KB</span>`;

            showConfigValidation('Loaded: ' + file.name, 'valid');

        } catch (err) {
            showConfigValidation('Parse error: ' + err.message, 'invalid');
        }
    };

    reader.readAsText(file);
}

// =====================================================================
// FILE INSPECTION
// =====================================================================

let lastInspection = null;
let lastCapabilities = null;

async function inspectFile(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);

        const r = await fetch('/api/inspect', {
            method: 'POST',
            body: formData,
        });

        if (!r.ok) {
            console.warn('Inspection failed');
            return;
        }

        const data = await r.json();
        lastInspection = data.inspection;
        lastCapabilities = data.capabilities;

        // Show inspection section
        $('inspection-section').style.display = 'block';
        const dataSignalCount = lastInspection.signals?.filter(s => !s.is_entity_id && !s.is_sequence).length || 0;
        $('inspection-level').textContent = `${dataSignalCount} sig`;
        $('inspection-level').style.background = 'var(--accent)';

        // Build inspection content
        let html = '';

        // Entities
        html += `<div style="margin-bottom: 0.5rem;">`;
        html += `<span style="color: var(--dim);">Entities:</span> `;
        html += `<span style="color: var(--green);">${lastInspection.entities?.length || 0}</span>`;
        if (lastInspection.entities?.length <= 5) {
            html += ` <span style="color: var(--dim);">(${lastInspection.entities?.map(e => escapeHtml(e)).join(', ')})</span>`;
        }
        html += `</div>`;

        // Signals
        const signals = lastInspection.signals?.filter(s => !s.is_entity_id && !s.is_sequence && !s.is_constant) || [];
        html += `<div style="margin-bottom: 0.5rem;">`;
        html += `<span style="color: var(--dim);">Sensors:</span> `;
        html += `<span style="color: var(--accent);">${signals.length}</span>`;
        html += `</div>`;

        // Show all signals
        if (signals.length > 0) {
            html += `<div style="margin-bottom: 0.5rem; padding-left: 0.5rem; border-left: 2px solid var(--border);">`;
            for (const sig of signals.slice(0, 6)) {
                html += `<div><span style="color: var(--text);">${escapeHtml(sig.name)}</span>`;
                if (sig.unit) html += ` <span style="color: var(--purple);">[${escapeHtml(sig.unit)}]</span>`;
                html += `</div>`;
            }
            if (signals.length > 6) {
                html += `<div id="signals-more" style="display: none;">`;
                for (const sig of signals.slice(6)) {
                    html += `<div><span style="color: var(--text);">${escapeHtml(sig.name)}</span>`;
                    if (sig.unit) html += ` <span style="color: var(--purple);">[${escapeHtml(sig.unit)}]</span>`;
                    html += `</div>`;
                }
                html += `</div>`;
                html += `<a href="#" id="signals-toggle" onclick="toggleSignals(); return false;" style="color: var(--accent); text-decoration: none; font-size: 0.7rem;">...and ${signals.length - 6} more</a>`;
            }
            html += `</div>`;
        }

        // Constants
        const constants = Object.keys(lastInspection.constants || {});
        if (constants.length > 0) {
            html += `<div style="margin-bottom: 0.5rem;">`;
            html += `<span style="color: var(--dim);">Constants:</span> `;
            html += `<span style="color: var(--yellow);">${constants.length}</span>`;
            html += ` <span style="color: var(--dim);">(${constants.slice(0, 3).map(c => escapeHtml(c)).join(', ')}${constants.length > 3 ? '...' : ''})</span>`;
            html += `</div>`;
        }

        // Unit categories detected
        const categories = lastInspection.quantities_detected || [];
        if (categories.length > 0) {
            html += `<div style="margin-bottom: 0.5rem;">`;
            html += `<span style="color: var(--dim);">Categories:</span> `;
            html += `<span style="color: var(--green);">${categories.slice(0, 4).join(', ')}${categories.length > 4 ? '...' : ''}</span>`;
            html += `</div>`;
        }

        // Warnings
        if (lastInspection.warnings?.length > 0) {
            html += `<div style="margin-top: 0.5rem; padding: 0.3rem 0.5rem; background: rgba(210, 153, 34, 0.1); border-radius: 3px;">`;
            for (const warn of lastInspection.warnings) {
                html += `<div style="color: var(--yellow); font-size: 0.65rem;">‚ö† ${escapeHtml(warn)}</div>`;
            }
            html += `</div>`;
        }


        $('inspection-content').innerHTML = html;

        // Build manifest from detected unit categories
        await buildManifestFromInspection();

        // Trigger AI concierge validation
        if (conciergeAvailable) {
            validateWithConcierge(file);
        }

    } catch (e) {
        console.warn('Inspection error:', e);
    }
}

// Build manifest from inspection data and render engines
async function buildManifestFromInspection() {
    if (!lastInspection) return;

    try {
        // Extract unit categories from inspection
        const dataSignals = lastInspection.signals?.filter(s => !s.is_entity_id && !s.is_sequence) || [];
        const unitCategories = new Set();

        for (const sig of dataSignals) {
            const qty = sig.quantity || sig.physical_quantity;
            if (qty) unitCategories.add(qty);
        }

        // Get window config
        const windowSize = parseInt($('window-size')?.value) || 100;
        const windowStride = parseInt($('window-stride')?.value) || windowSize / 2;

        // Call manifest builder API
        const r = await fetch('/api/manifest/from-units', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                unit_categories: Array.from(unitCategories),
                window_size: windowSize,
                stride: windowStride,
                include_universal: true,
                include_causality: dataSignals.length > 1
            })
        });

        if (r.ok) {
            lastManifest = await r.json();
            engineStatus = {};  // Reset status
            renderEnginesFromManifest(lastManifest);

            // Update inspection level badge to show engine count
            const totalEngines = Object.values(lastManifest.engines || {}).reduce((sum, arr) => sum + arr.length, 0);
            $('inspection-level').textContent = `${totalEngines}`;
            $('inspection-level').style.background = 'var(--green)';
        }

    } catch (e) {
        console.warn('Error building manifest:', e);
    }
}

// =====================================================================
// RESULTS VALIDATION
// =====================================================================

async function validateResults() {
    try {
        const r = await fetch('/api/validate-results', { method: 'POST' });
        if (!r.ok) return null;
        return await r.json();
    } catch (e) {
        console.warn('Validation error:', e);
        return null;
    }
}

function showValidationWarnings(validation) {
    if (!validation) return;

    let messages = [];

    if (validation.files_corrupted?.length > 0) {
        messages.push(`‚ùå Corrupted: ${validation.files_corrupted.join(', ')}`);
    }
    if (validation.files_empty?.length > 0) {
        messages.push(`‚ö†Ô∏è Empty: ${validation.files_empty.join(', ')}`);
    }

    if (messages.length > 0) {
        alert('Results Validation:\n\n' + messages.join('\n') + '\n\n' + validation.summary);
    }
}

// =====================================================================
// PRISM CONNECTIVITY
// =====================================================================

let prismAvailable = false;

async function checkPRISM() {
    try {
        const r = await fetch('/api/prism/health');
        const data = await r.json();
        prismAvailable = data.available;

        if (prismAvailable) {
            setSt('prism', 'Ready', 'ok');
            updateAnalyzeButton();
        } else {
            setSt('prism', 'Offline', 'warn');
        }
    } catch (e) {
        // If API not available, try direct PRISM connection
        try {
            const r = await fetch('http://localhost:8100/health');
            const data = await r.json();
            prismAvailable = data.status === 'ok';

            if (prismAvailable) {
                setSt('prism', 'Direct', 'ok');
                updateAnalyzeButton();
            }
        } catch (e2) {
            setSt('prism', 'Unavailable', 'err');
        }
    }
}

function updateAnalyzeButton() {
    const btn = $('analyze-btn');
    btn.disabled = !(prismAvailable && currentFile);
}

// =====================================================================
// PRE-FLIGHT VALIDATION
// =====================================================================

window.analyzeWithPRISM = async function() {
    if (!currentFile || !prismAvailable || !conn) return;

    // Run pre-flight checks
    const checks = await runPreflightChecks();
    showPreflightModal(checks);
};

async function runPreflightChecks() {
    const windowSize = parseInt($('window-size').value) || 50;
    const windowStride = parseInt($('window-stride').value) || 25;
    const minObservations = windowSize; // Need at least one full window

    const checks = [];

    try {
        // 1. Row count check
        const countResult = await conn.query(`SELECT COUNT(*) as cnt FROM data`);
        const rowCount = Number(countResult.toArray()[0].cnt);

        checks.push({
            name: 'Row count',
            status: rowCount >= minObservations ? 'ok' : 'err',
            detail: `${rowCount.toLocaleString()} rows (min: ${minObservations})`,
            message: rowCount < minObservations ? `Need at least ${minObservations} rows for window size ${windowSize}` : null
        });

        // 2. Window size vs data span
        // Try to find a numeric column that could be an index
        const descResult = await conn.query(`DESCRIBE data`);
        const columns = descResult.toArray();
        const numericCols = columns.filter(c =>
            c.column_type.includes('INT') ||
            c.column_type.includes('FLOAT') ||
            c.column_type.includes('DOUBLE')
        );

        if (numericCols.length > 0) {
            // Use first numeric column as proxy for data span
            const firstCol = numericCols[0].column_name;
            const spanResult = await conn.query(`SELECT MAX("${firstCol}") - MIN("${firstCol}") as span FROM data`);
            const dataSpan = Number(spanResult.toArray()[0].span);

            if (dataSpan > 0) {
                const windowsEstimate = Math.floor((dataSpan - windowSize) / windowStride) + 1;
                checks.push({
                    name: 'Window coverage',
                    status: windowSize <= dataSpan ? 'ok' : 'err',
                    detail: `~${Math.max(0, windowsEstimate)} windows (span: ${dataSpan.toFixed(1)}, size: ${windowSize})`,
                    message: windowSize > dataSpan ? `Window size (${windowSize}) > data span (${dataSpan.toFixed(1)})` : null
                });
            }
        }

        // 3. Stride vs size check
        if (windowStride > windowSize) {
            checks.push({
                name: 'Window stride',
                status: 'warn',
                detail: `Stride ${windowStride} > size ${windowSize}`,
                message: 'Stride larger than window size creates gaps in coverage'
            });
        } else {
            const overlap = ((windowSize - windowStride) / windowSize * 100).toFixed(0);
            checks.push({
                name: 'Window stride',
                status: 'ok',
                detail: `${overlap}% overlap (stride: ${windowStride}, size: ${windowSize})`
            });
        }

        // 4. Signal columns check
        const signalCols = numericCols.filter(c => {
            const name = c.column_name.toLowerCase();
            // Exclude likely index/id columns
            return !name.includes('id') && !name.includes('index') &&
                   !name.includes('time') && !name.includes('cycle') &&
                   name !== 't' && name !== 'ts';
        });

        checks.push({
            name: 'Sensor columns',
            status: signalCols.length > 0 ? 'ok' : 'warn',
            detail: `${signalCols.length} numeric sensor columns detected`,
            message: signalCols.length === 0 ? 'No sensor columns detected - check data format' : null
        });

        // 5. Null value check (sample first few columns)
        for (const col of signalCols.slice(0, 3)) {
            try {
                const nullResult = await conn.query(`
                    SELECT
                        COUNT(*)::DOUBLE as total,
                        SUM(CASE WHEN "${col.column_name}" IS NULL THEN 1 ELSE 0 END)::DOUBLE as nulls
                    FROM data
                `);
                const row = nullResult.toArray()[0];
                const total = Number(row.total) || 1;
                const nulls = Number(row.nulls) || 0;
                const nullPct = (nulls / total * 100);

                if (nullPct > 10 && !isNaN(nullPct) && isFinite(nullPct)) {
                    checks.push({
                        name: `Nulls in ${col.column_name}`,
                        status: nullPct > 50 ? 'error' : 'warn',
                        detail: `${nullPct.toFixed(1)}% null values`,
                        message: `High null rate may affect analysis quality`
                    });
                }
            } catch (e) {
                console.warn(`Null check failed for ${col.column_name}:`, e);
            }
        }

        // 6. Unit detection from inspection
        if (lastInspection?.signals) {
            const dataSignals = lastInspection.signals.filter(s => !s.is_entity_id && !s.is_sequence);
            // Signals with units OR explicitly marked as unknown (null in signalUnits)
            const withUnits = dataSignals.filter(s => s.unit || (s.name in signalUnits));
            const withoutUnits = dataSignals.filter(s => !s.unit && !(s.name in signalUnits));

            if (withUnits.length > 0) {
                checks.push({
                    name: 'Units detected',
                    status: 'ok',
                    detail: `${withUnits.length} sensors with units (${withUnits.slice(0, 3).map(s => s.unit).join(', ')}${withUnits.length > 3 ? '...' : ''})`
                });
            }

            // ERROR: Units are REQUIRED for all signals
            if (withoutUnits.length > 0 && lastInspection.units_detected === 0) {
                checks.push({
                    name: 'Missing units',
                    status: 'error',
                    detail: `${withoutUnits.length} sensor(s) without units`,
                    message: 'Units are required. Click "Assign Units" to add them.',
                    action: 'assign-units'
                });
            } else if (withoutUnits.length > 0 && lastInspection.units_detected > 0) {
                // Units detected in separate column - just informational
                checks.push({
                    name: 'Unit column',
                    status: 'ok',
                    detail: `${lastInspection.units_detected} unique units in dedicated column`
                });
            }
        }

        // 7. Check for missing metadata that could be warnings
        if (lastInspection?.signals) {
            const dataSignals = lastInspection.signals.filter(s => !s.is_entity_id && !s.is_sequence);
            const missingQuantity = dataSignals.filter(s => !s.quantity && !s.unit);

            if (missingQuantity.length > 0 && lastInspection.units_detected === 0) {
                checks.push({
                    name: 'Sensor metadata',
                    status: 'warn',
                    detail: `${missingQuantity.length} sensor(s) missing quantity/unit info`,
                    message: 'Consider adding units to column names (e.g., pressure_PSI)'
                });
            }
        }

        // 8. Entity/sequence column detection
        if (lastInspection) {
            if (!lastInspection.entity_column && !lastInspection.sequence_column) {
                checks.push({
                    name: 'Data structure',
                    status: 'warn',
                    detail: 'No entity or sequence column detected',
                    message: 'Data may be treated as single time series'
                });
            } else {
                const parts = [];
                if (lastInspection.entity_column) parts.push(`entity: ${lastInspection.entity_column}`);
                if (lastInspection.sequence_column) parts.push(`sequence: ${lastInspection.sequence_column}`);
                checks.push({
                    name: 'Data structure',
                    status: 'ok',
                    detail: parts.join(', ')
                });
            }
        }

    } catch (e) {
        checks.push({
            name: 'Validation error',
            status: 'warn',
            detail: e.message,
            message: 'Could not complete all pre-flight checks'
        });
    }

    return checks;
}

function showPreflightModal(checks) {
    const modal = $('preflight-modal');
    const results = $('preflight-results');
    const submitBtn = $('preflight-submit-btn');
    const fixBtn = $('preflight-fix-btn');

    // Render checks
    let html = '';
    let hasErrors = false;
    let hasWarnings = false;

    for (const check of checks) {
        const icon = check.status === 'ok' ? '‚úì' : check.status === 'warn' ? '‚ö†' : '‚úó';
        const iconClass = check.status === 'ok' ? 'ok' : check.status === 'warn' ? 'warn' : 'err';

        if (check.status === 'error') hasErrors = true;
        if (check.status === 'warn') hasWarnings = true;

        // Build action button if present
        const actionBtn = check.action === 'assign-units'
            ? `<button class="btn btn-small" onclick="showUnitAssignment()">Assign Units</button>`
            : '';

        html += `
            <div class="preflight-item">
                <span class="preflight-icon ${iconClass}">${icon}</span>
                <div class="preflight-text">
                    <div>${escapeHtml(check.name)}: ${escapeHtml(check.detail)}</div>
                    ${check.message ? `<div class="preflight-detail">${escapeHtml(check.message)} ${actionBtn}</div>` : ''}
                </div>
            </div>
        `;
    }

    results.innerHTML = html;

    // Configure buttons based on results
    if (hasErrors) {
        submitBtn.textContent = 'Fix Required Issues';
        submitBtn.className = 'btn btn-danger';
        submitBtn.disabled = true;
        fixBtn.style.display = 'inline-block';
    } else if (hasWarnings) {
        submitBtn.textContent = 'Submit Anyway';
        submitBtn.className = 'btn btn-primary';
        submitBtn.disabled = false;
        fixBtn.style.display = 'none';
    } else {
        submitBtn.textContent = 'Submit';
        submitBtn.className = 'btn btn-primary';
        submitBtn.disabled = false;
        fixBtn.style.display = 'none';
    }

    // Show AI fix button if concierge is available and there are warnings/errors
    const aiBtn = $('preflight-ai-btn');
    if (aiBtn) {
        aiBtn.style.display = (conciergeAvailable && (hasErrors || hasWarnings)) ? 'inline-block' : 'none';
    }

    // Build manifest preview (async, don't block modal)
    buildManifestPreview();

    modal.classList.add('visible');
}

window.closePreflightModal = function() {
    $('preflight-modal').classList.remove('visible');
};

// =====================================================================
// MANIFEST PREVIEW
// =====================================================================

let lastManifest = null;

window.toggleManifestPreview = function() {
    const content = $('manifest-content');
    const icon = $('manifest-toggle-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
};

async function buildManifestPreview() {
    if (!lastInspection) return;

    try {
        // Extract unit categories from inspection
        const dataSignals = lastInspection.signals?.filter(s => !s.is_entity_id && !s.is_sequence) || [];
        const unitCategories = new Set();

        for (const sig of dataSignals) {
            const qty = sig.quantity || sig.physical_quantity;
            if (qty) unitCategories.add(qty);
        }

        // Get window config
        const windowSize = parseInt($('window-size')?.value) || 100;
        const windowStride = parseInt($('window-stride')?.value) || windowSize / 2;

        // Call manifest builder API
        const r = await fetch('/api/manifest/from-units', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                unit_categories: Array.from(unitCategories),
                window_size: windowSize,
                stride: windowStride,
                include_universal: true,
                include_causality: dataSignals.length > 1
            })
        });

        if (!r.ok) {
            console.error('Manifest build failed:', await r.text());
            return;
        }

        lastManifest = await r.json();
        displayManifestPreview(lastManifest);

    } catch (e) {
        console.error('Error building manifest:', e);
    }
}

function displayManifestPreview(manifest) {
    const preview = $('manifest-preview');
    const content = $('manifest-content');
    const countBadge = $('manifest-engine-count');

    if (!manifest || !manifest.engines) {
        preview.style.display = 'none';
        return;
    }

    // Count total engines
    let totalEngines = 0;
    for (const type in manifest.engines) {
        totalEngines += manifest.engines[type].length;
    }

    countBadge.textContent = `${totalEngines} engines`;
    preview.style.display = 'block';

    // Build HTML
    let html = '';

    const typeLabels = {
        signal: { label: 'Sensor', color: 'var(--green)', desc: 'Per-sensor metrics' },
        pair: { label: 'Pair (Directional)', color: 'var(--accent)', desc: 'Causality analysis' },
        symmetric_pair: { label: 'Pair (Symmetric)', color: 'var(--purple)', desc: 'Correlation metrics' },
        windowed: { label: 'Windowed', color: 'var(--yellow)', desc: 'Rolling calculations' },
        sql: { label: 'SQL', color: 'var(--dim)', desc: 'Aggregate statistics' }
    };

    for (const [type, engines] of Object.entries(manifest.engines)) {
        if (engines.length === 0) continue;

        const info = typeLabels[type] || { label: type, color: 'var(--text)', desc: '' };

        html += `
            <div style="margin-bottom: 10px; padding: 8px; background: var(--input); border-radius: 4px; border-left: 3px solid ${info.color};">
                <div style="font-weight: 500; color: ${info.color}; margin-bottom: 4px;">
                    ${info.label} <span style="color: var(--dim); font-weight: normal;">(${engines.length})</span>
                </div>
                <div style="font-size: 0.7rem; color: var(--dim); margin-bottom: 6px;">${info.desc}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${engines.map(e => `<span style="font-size: 0.65rem; padding: 2px 6px; background: var(--panel); border-radius: 3px;">${escapeHtml(e)}</span>`).join('')}
                </div>
            </div>
        `;
    }

    // Show params if any
    const params = manifest.params || {};
    const paramCount = Object.keys(params).filter(k => !k.startsWith('_')).length;
    if (paramCount > 0) {
        html += `
            <div style="margin-top: 8px; font-size: 0.65rem; color: var(--dim);">
                <strong>Params:</strong> ${paramCount} engine${paramCount > 1 ? 's' : ''} configured
            </div>
        `;
    }

    content.innerHTML = html;
}

window.autoFixWithAI = async function() {
    closePreflightModal();

    if (!conciergeAvailable) {
        alert('AI not available. Please set ANTHROPIC_API_KEY.');
        return;
    }

    // Show loading state
    setSt('concierge', 'Auto-fixing...', 'warn');

    // If we already have AI suggestions from validation, apply them
    if (lastConciergeConfig) {
        // Apply the AI-suggested config
        applyConciergeConfig();

        // Also trigger unit suggestion with AI
        if (currentFile) {
            await suggestUnitsWithLLM();
        }

        setSt('concierge', 'Fixed', 'ok');

        // Show success message
        const configStatus = $('config-validation-status');
        if (configStatus) {
            configStatus.innerHTML = '<span style="color: var(--green);">‚úì AI auto-fix applied. Review config and unit assignments.</span>';
            configStatus.style.display = 'block';
        }

        // Switch to config view so user can review
        showView('config');

        // Open unit assignment if there are signals without units
        if (lastInspection && lastInspection.signals) {
            const needsUnits = lastInspection.signals.filter(s => !s.unit);
            if (needsUnits.length > 0) {
                showUnitAssignment();
            }
        }
    } else {
        // No AI suggestions yet, need to run validation first
        if (currentFile) {
            await validateWithConcierge(currentFile);
            // After validation completes, apply suggestions
            if (lastConciergeConfig) {
                applyConciergeConfig();
                await suggestUnitsWithLLM();
            }
        }
        setSt('concierge', 'Ready', 'ok');
        showView('config');
    }
};

// =====================================================================
// UNIT ASSIGNMENT
// =====================================================================

const COMMON_UNITS = [
    // Index/Sequence (first - for the primary axis column)
    { unit: 'index', quantity: 'index', label: 'INDEX (row/sequence number)' },
    // Pressure
    { unit: 'PSI', quantity: 'pressure', label: 'PSI (pressure)' },
    { unit: 'kPa', quantity: 'pressure', label: 'kPa (pressure)' },
    { unit: 'bar', quantity: 'pressure', label: 'bar (pressure)' },
    // Temperature
    { unit: 'degC', quantity: 'temperature', label: '¬∞C (temperature)' },
    { unit: 'degF', quantity: 'temperature', label: '¬∞F (temperature)' },
    { unit: 'K', quantity: 'temperature', label: 'K (temperature)' },
    // Flow
    { unit: 'gpm', quantity: 'flow', label: 'gpm (flow)' },
    { unit: 'lpm', quantity: 'flow', label: 'L/min (flow)' },
    { unit: 'm3/s', quantity: 'flow', label: 'm¬≥/s (flow)' },
    // Velocity
    { unit: 'rpm', quantity: 'angular_velocity', label: 'RPM (rotation)' },
    { unit: 'm/s', quantity: 'velocity', label: 'm/s (velocity)' },
    // Electrical
    { unit: 'V', quantity: 'voltage', label: 'V (voltage)' },
    { unit: 'A', quantity: 'current', label: 'A (current)' },
    { unit: 'kW', quantity: 'power', label: 'kW (power)' },
    { unit: 'Hz', quantity: 'frequency', label: 'Hz (frequency)' },
    // Digital/Binary
    { unit: 'state', quantity: 'binary', label: 'state (binary on/off)' },
    { unit: 'count', quantity: 'discrete', label: 'count (pulses/events)' },
    // Other
    { unit: '%', quantity: 'percentage', label: '% (percentage)' },
    { unit: 'kg', quantity: 'mass', label: 'kg (mass)' },
    { unit: 'm', quantity: 'length', label: 'm (length)' },
    { unit: 'ppm', quantity: 'concentration', label: 'ppm (concentration)' },
    { unit: 'unitless', quantity: 'dimensionless', label: 'unitless' },
    { unit: 'unknown', quantity: 'unknown', label: 'Unknown (NULL)' },
];

// Map alternative unit names to our standard values
const UNIT_ALIASES = {
    '¬∞C': 'degC', 'celsius': 'degC', 'C': 'degC',
    '¬∞F': 'degF', 'fahrenheit': 'degF', 'F': 'degF',
    'kelvin': 'K',
    'psi': 'PSI',
    'binary': 'state', 'boolean': 'state', 'on/off': 'state', 'digital': 'state',
    'pulse': 'count', 'pulses': 'count', 'impulse': 'count',
    'l/min': 'lpm', 'L/min': 'lpm',
    'percent': '%',
    'ampere': 'A', 'amp': 'A', 'amps': 'A',
    'volt': 'V', 'volts': 'V',
    'watt': 'kW', 'kilowatt': 'kW',
    'hertz': 'Hz',
    'meter': 'm', 'meters': 'm',
    'kilogram': 'kg',
    // Index types
    'REMOVE': 'index', 'remove': 'index', 'row_number': 'index', 'sequence': 'index',
};

let signalUnits = {}; // Store user-assigned units

window.showUnitAssignment = function() {
    closePreflightModal();
    const modal = $('unit-modal');
    const list = $('unit-assignment-list');

    if (!lastInspection?.signals) {
        list.innerHTML = '<div style="color: var(--red);">No sensors detected. Load a file first.</div>';
        modal.classList.add('visible');
        return;
    }

    const dataSignals = lastInspection.signals.filter(s => !s.is_entity_id && !s.is_sequence);

    let html = '';
    for (const sig of dataSignals) {
        const currentUnit = signalUnits[sig.name] || sig.unit || '';
        const options = COMMON_UNITS.map(u =>
            `<option value="${u.unit}" ${currentUnit === u.unit ? 'selected' : ''}>${u.label}</option>`
        ).join('');

        html += `
            <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 8px;">
                <span style="width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(sig.name)}</span>
                <select class="signal-unit-select" data-signal="${escapeHtml(sig.name)}" style="flex: 1; padding: 4px; background: var(--input); color: var(--text); border: 1px solid var(--border); border-radius: 4px;">
                    <option value="">-- Select Unit --</option>
                    ${options}
                    <option value="custom">Custom...</option>
                </select>
                <input type="text" class="signal-unit-custom" data-signal="${escapeHtml(sig.name)}" placeholder="Custom unit" style="width: 100px; padding: 4px; background: var(--input); color: var(--text); border: 1px solid var(--border); border-radius: 4px; display: ${currentUnit && !COMMON_UNITS.find(u => u.unit === currentUnit) ? 'block' : 'none'};" value="${currentUnit && !COMMON_UNITS.find(u => u.unit === currentUnit) ? currentUnit : ''}">
            </div>
        `;
    }

    list.innerHTML = html;

    // Add change listeners for custom unit toggle
    list.querySelectorAll('.signal-unit-select').forEach(select => {
        select.addEventListener('change', (e) => {
            const customInput = list.querySelector(`.signal-unit-custom[data-signal="${e.target.dataset.signal}"]`);
            customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
    });

    // Show LLM section if API might be available
    const llmSection = $('llm-suggest-section');
    llmSection.style.display = 'block'; // Always show, will fail gracefully

    modal.classList.add('visible');
};

window.closeUnitModal = function() {
    $('unit-modal').classList.remove('visible');
};

window.applyUnits = function() {
    const list = $('unit-assignment-list');

    // Collect all assigned units
    list.querySelectorAll('.signal-unit-select').forEach(select => {
        const signal = select.dataset.signal;
        let unit = select.value;

        if (unit === 'custom') {
            const customInput = list.querySelector(`.signal-unit-custom[data-signal="${signal}"]`);
            unit = customInput.value.trim();
        }

        if (unit && unit !== '') {
            // 'unknown' means user explicitly chose NULL
            const finalUnit = unit === 'unknown' ? null : unit;
            signalUnits[signal] = finalUnit;

            // Update lastInspection
            if (lastInspection?.signals) {
                const sig = lastInspection.signals.find(s => s.name === signal);
                if (sig) sig.unit = finalUnit;
            }
        }
    });

    // Check if all signals have units now (null = unknown is valid - user made a choice)
    const dataSignals = lastInspection?.signals?.filter(s => !s.is_entity_id && !s.is_sequence) || [];
    const missingUnits = dataSignals.filter(s => !s.unit && !(s.name in signalUnits));

    if (missingUnits.length > 0) {
        alert(`Still missing units for ${missingUnits.length} sensor(s): ${missingUnits.map(s => s.name).slice(0, 3).join(', ')}${missingUnits.length > 3 ? '...' : ''}`);
        return;
    }

    closeUnitModal();
    // Re-run preflight to update status
    analyzeWithPRISM();
};

window.suggestUnitsWithLLM = async function() {
    const status = $('llm-status');
    status.textContent = 'Analyzing sensors...';
    status.style.color = 'var(--accent)';

    try {
        const dataSignals = lastInspection?.signals?.filter(s => !s.is_entity_id && !s.is_sequence) || [];
        const signalNames = dataSignals.map(s => s.name);

        // Call API for suggestions
        const response = await fetch('/api/suggest-units', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ signals: signalNames })
        });

        if (!response.ok) {
            throw new Error('LLM service not available');
        }

        const suggestions = await response.json();
        console.log('AI unit suggestions:', suggestions);

        let appliedCount = 0;

        // Apply suggestions to dropdowns
        for (const [signal, rawUnit] of Object.entries(suggestions)) {
            // Skip REMOVE suggestions
            if (rawUnit === 'REMOVE' || rawUnit === 'remove' || rawUnit === 'index') {
                continue;
            }

            // Normalize unit using aliases
            let unit = UNIT_ALIASES[rawUnit] || rawUnit;

            const select = document.querySelector(`.signal-unit-select[data-signal="${CSS.escape(signal)}"]`);
            if (!select) {
                console.warn(`Select not found for signal: ${signal}`);
                continue;
            }

            // Check if unit exists in COMMON_UNITS
            const matchingOption = COMMON_UNITS.find(u => u.unit === unit || u.unit.toLowerCase() === unit.toLowerCase());
            if (matchingOption) {
                select.value = matchingOption.unit;
                appliedCount++;
                console.log(`Applied ${matchingOption.unit} to ${signal}`);
            } else {
                // Use custom input
                select.value = 'custom';
                const customInput = document.querySelector(`.signal-unit-custom[data-signal="${CSS.escape(signal)}"]`);
                if (customInput) {
                    customInput.value = unit;
                    customInput.style.display = 'block';
                    appliedCount++;
                    console.log(`Applied custom ${unit} to ${signal}`);
                }
            }
        }

        status.textContent = `Applied ${appliedCount} suggestions. Review and adjust.`;
        status.style.color = 'var(--green)';
    } catch (e) {
        console.error('LLM error:', e);
        status.textContent = 'LLM error: ' + e.message;
        status.style.color = 'var(--red)';
    }
};

window.submitToPRISM = async function() {
    closePreflightModal();

    if (!currentFile || !prismAvailable) return;

    const btn = $('analyze-btn');
    const progress = $('prism-progress');
    const progressText = $('prism-progress-text');

    btn.disabled = true;
    progress.style.display = 'block';
    progressText.textContent = 'Uploading to PRISM...';

    try {
        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('discipline', $('discipline-select').value);
        formData.append('window_size', $('window-size').value);
        formData.append('window_stride', $('window-stride').value);

        // Add user-assigned units for each column
        if (Object.keys(signalUnits).length > 0) {
            formData.append('units', JSON.stringify(signalUnits));
        }

        // Add user-entered constants
        const constants = getUserConstants();
        if (Object.keys(constants).length > 0) {
            formData.append('constants', JSON.stringify(constants));
        }

        progressText.textContent = 'Submitting job...';

        const r = await fetch('/api/prism/compute', {
            method: 'POST',
            body: formData,
        });

        let result = await r.json();

        if (!r.ok) {
            throw new Error(result.detail || 'PRISM computation failed');
        }

        // Handle queued jobs - poll until complete
        if (result.status === 'queued') {
            progressText.textContent = `Queued at position ${result.queue_position}. Waiting...`;

            // Poll for job completion
            const jobId = result.job_id;
            while (true) {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds

                const statusR = await fetch(`/api/prism/job/${jobId}`);
                const status = await statusR.json();

                if (status.status === 'complete') {
                    // Job done - get the results
                    result = {
                        status: 'complete',
                        job_id: jobId,
                        files: status.outputs || [],
                        file_urls: status.outputs?.map(f => `/api/prism/results/${status.results_path?.split('/').pop() || jobId}/${f}`) || [],
                    };
                    break;
                } else if (status.status === 'failed') {
                    throw new Error(status.error || 'Job failed');
                } else if (status.status === 'running') {
                    progressText.textContent = 'Computing...';
                } else {
                    const pos = status.queue_position || '?';
                    progressText.textContent = `Queued at position ${pos}. Waiting...`;
                }
            }
        }

        progressText.textContent = 'Loading results...';

        // Load result parquets into DuckDB
        const tableSelect = $('table-select');
        tableSelect.innerHTML = '<option value="data">data (original)</option>';

        // Handle both old format (parquet_urls) and new format (file_urls)
        const resultUrls = result.file_urls || result.parquet_urls || [];
        const jobId = result.job_id;

        for (const url of resultUrls) {
            // Use ORTHON proxy to fetch from PRISM (avoids CORS)
            // Convert /results/job_id/file.parquet to /api/prism/results/job_id/file.parquet
            let fullUrl;
            if (url.startsWith('/results/') && jobId) {
                fullUrl = `/api/prism${url}`;
            } else if (url.startsWith('http')) {
                fullUrl = url;
            } else {
                fullUrl = `/api/prism/results/${jobId}/${url.split('/').pop()}`;
            }
            const tableName = url.split('/').pop().replace('.parquet', '');

            try {
                // Fetch the parquet file
                const parquetResponse = await fetch(fullUrl);
                if (!parquetResponse.ok) {
                    console.warn(`Failed to fetch ${tableName}: ${parquetResponse.status}`);
                    continue;
                }
                const parquetBuffer = await parquetResponse.arrayBuffer();
                const filename = `${tableName}.parquet`;

                // Register in DuckDB
                await db.registerFileBuffer(filename, new Uint8Array(parquetBuffer));
                await conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${filename}')`);

                // Add to table selector
                const option = document.createElement('option');
                option.value = tableName;
                option.textContent = tableName;
                tableSelect.appendChild(option);

            } catch (e) {
                console.warn(`Failed to load ${tableName}:`, e);
            }
        }

        progress.style.display = 'none';
        const fileCount = result.files?.length || result.parquets?.length || resultUrls.length;
        setSt('prism', `Done: ${fileCount} tables`, 'ok');

        // Mark all engines as computed
        markAllEnginesComputed();

        // Store URLs and show download button
        lastParquetUrls = resultUrls;
        if (lastParquetUrls.length > 0) {
            $('download-section').style.display = 'block';
        }

        // Show first result table
        if (result.parquets?.length > 0) {
            const firstTable = result.parquets[0].replace('.parquet', '');
            tableSelect.value = firstTable;
            await loadTable(firstTable);
            await loadSchema();
        }

        // Validate results
        progressText.textContent = 'Validating results...';
        const validation = await validateResults();

        if (validation && (!validation.valid || validation.warnings?.length > 0)) {
            showValidationWarnings(validation);
        } else {
            alert(`PRISM analysis complete!\n\n${validation?.summary || `Loaded ${result.parquets?.length || 0} tables`}`);
        }

    } catch (e) {
        console.error('PRISM error:', e);
        progress.style.display = 'none';
        setSt('prism', 'Error', 'err');
        alert('PRISM Error: ' + e.message);
    } finally {
        btn.disabled = false;
        updateAnalyzeButton();
    }
};

// =====================================================================
// DOWNLOAD RESULTS
// =====================================================================

let lastParquetUrls = [];

window.downloadResults = async function() {
    if (lastParquetUrls.length === 0) return;

    // Download each parquet file
    for (const url of lastParquetUrls) {
        const filename = url.split('/').pop();
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
    }
};

window.loadExternalResults = async function() {
    const pathInput = $('results-path-input');
    const statusDiv = $('load-results-status');
    const path = pathInput.value.trim();

    if (!path) {
        statusDiv.innerHTML = '<span style="color: var(--red)">Please enter a path</span>';
        return;
    }

    statusDiv.innerHTML = '<span style="color: var(--blue)">Loading...</span>';

    try {
        const response = await fetch('/api/prism/load-results', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Failed to load results');
        }

        const result = await response.json();

        // Load parquets into DuckDB
        const tableSelect = $('table-select');
        const existingTables = new Set();
        for (const opt of tableSelect.options) {
            existingTables.add(opt.value);
        }

        let loadedCount = 0;
        for (const url of result.parquet_urls || []) {
            const tableName = url.split('/').pop().replace('.parquet', '');

            try {
                const parquetResponse = await fetch(url);
                const parquetBuffer = await parquetResponse.arrayBuffer();
                const filename = `${tableName}.parquet`;

                await db.registerFileBuffer(filename, new Uint8Array(parquetBuffer));
                await conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${filename}')`);

                if (!existingTables.has(tableName)) {
                    const option = document.createElement('option');
                    option.value = tableName;
                    option.textContent = tableName;
                    tableSelect.appendChild(option);
                }
                loadedCount++;
            } catch (e) {
                console.warn(`Failed to load ${tableName}:`, e);
            }
        }

        // Store URLs for download
        lastParquetUrls = result.parquet_urls || [];
        if (lastParquetUrls.length > 0) {
            $('download-section').style.display = 'block';
        }

        // Show first result table
        if (result.parquets?.length > 0) {
            const firstTable = result.parquets[0].replace('.parquet', '');
            tableSelect.value = firstTable;
            await loadTable(firstTable);
            showView('data');
        }

        setSt('prism', `Loaded: ${loadedCount} tables`, 'ok');
        statusDiv.innerHTML = `<span style="color: var(--green)">Loaded ${loadedCount} parquet files</span>`;

    } catch (e) {
        statusDiv.innerHTML = `<span style="color: var(--red)">${escapeHtml(e.message)}</span>`;
        console.error('Load results error:', e);
    }
};

// =====================================================================
// SIGNALS TOGGLE
// =====================================================================

window.toggleSignals = function() {
    const more = $('signals-more');
    const toggle = $('signals-toggle');

    if (more.style.display === 'none') {
        more.style.display = 'block';
        toggle.textContent = '‚àí show less';
    } else {
        more.style.display = 'none';
        const count = more.querySelectorAll('div').length;
        toggle.textContent = `...and ${count} more`;
    }
};

window.toggleSection = function(titleEl) {
    const content = titleEl.nextElementSibling;
    titleEl.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
};

function getUserConstants() {
    const constants = {};

    const density = $('const-density').value;
    const viscosity = $('const-viscosity').value;
    const diameter = $('const-diameter').value;
    const length = $('const-length').value;
    const temperature = $('const-temperature').value;
    const pressure = $('const-pressure').value;

    if (density) constants.density_kg_m3 = parseFloat(density);
    if (viscosity) constants.viscosity_Pa_s = parseFloat(viscosity);
    if (diameter) constants.diameter_m = parseFloat(diameter);
    if (length) constants.pipe_length_m = parseFloat(length);
    if (temperature) constants.temperature_K = parseFloat(temperature);
    if (pressure) constants.pressure_Pa = parseFloat(pressure);

    return constants;
};

// =====================================================================
// PRESET QUERIES
// =====================================================================

function populateQueryDropdown() {
    if (typeof ORTHON_QUERIES === 'undefined') {
        console.warn('ORTHON_QUERIES not loaded');
        return;
    }

    const select = $('query-select');

    for (const [sectionKey, section] of Object.entries(ORTHON_QUERIES)) {
        const group = document.createElement('optgroup');
        group.label = section.label;

        for (const query of section.queries) {
            const option = document.createElement('option');
            option.value = query.id;
            option.textContent = query.name;
            option.title = query.description;
            group.appendChild(option);
        }

        select.appendChild(group);
    }
}

window.loadPresetQuery = function(queryId) {
    if (!queryId) {
        $('query-input').value = 'SELECT * FROM data LIMIT 100';
        return;
    }

    // Find the query
    let selectedQuery = null;
    for (const section of Object.values(ORTHON_QUERIES)) {
        selectedQuery = section.queries.find(q => q.id === queryId);
        if (selectedQuery) break;
    }

    if (selectedQuery) {
        $('query-input').value = selectedQuery.sql.trim();
    }
};

// =====================================================================
// CONFIG TAB
// =====================================================================

const CONFIG_STORAGE_KEY = 'orthon_config';

const EXAMPLE_CONFIG = {
    index: {
        column: "timestamp",
        type: "temporal",
        unit: "seconds",
        monotonic: "increasing"
    },
    windows: {
        size: 100,
        stride: 50,
        min_observations: 10,
        boundary: "truncate"
    },
    signals: [
        { column: "signal_1", type: "continuous" },
        { column: "signal_2", type: "continuous" }
    ],
    layers: {
        typology: true,
        geometry: true,
        dynamics: true,
        mechanics: true
    },
    engines: {
        core: ["hurst", "entropy", "trend", "stationarity"],  // lyapunov in dynamics
        domain: []
    }
};

const CONFIG_REQUIRED_FIELDS = [
    'index.column',
    'index.type',
    'index.unit',
    'windows.size',
    'windows.stride'
];

function initConfigTab() {
    const editor = $('config-editor');
    const fileInput = $('config-file-input');
    const saveBtn = $('config-save');
    const resetBtn = $('config-reset');

    // Load saved config or example
    const saved = localStorage.getItem(CONFIG_STORAGE_KEY);
    if (saved) {
        editor.value = saved;
    } else {
        editor.value = JSON.stringify(EXAMPLE_CONFIG, null, 2);
    }

    // Validate on load and check capabilities
    validateConfigEditor(editor.value);
    checkCapabilities();

    // Event listeners
    editor.addEventListener('input', () => {
        validateConfigEditor(editor.value);
        checkCapabilities();
    });

    fileInput.addEventListener('change', handleConfigFileLoad);
    saveBtn.addEventListener('click', handleConfigSave);
    resetBtn.addEventListener('click', handleConfigReset);
}

function handleConfigFileLoad(e) {
    const file = e.target.files[0];
    if (!file) return;
    loadConfigFile(file);
    e.target.value = ''; // Reset for same file reload
}

function parseSimpleYAML(text) {
    // Simple YAML parser for basic key:value and arrays
    const result = {};
    const lines = text.split('\n');
    let currentKey = null;
    let currentArray = null;

    for (const line of lines) {
        if (line.trim().startsWith('#') || !line.trim()) continue;

        // Array item
        if (line.match(/^\s+-\s+/)) {
            const itemMatch = line.match(/^\s+-\s+(.+)/);
            if (itemMatch && currentArray) {
                const item = itemMatch[1].trim();
                // Check if it's a key:value or just a value
                if (item.includes(':')) {
                    const obj = {};
                    const pairs = item.split(/,\s*/);
                    for (const pair of pairs) {
                        const [k, v] = pair.split(':').map(s => s.trim());
                        obj[k] = isNaN(v) ? v : Number(v);
                    }
                    currentArray.push(obj);
                } else {
                    currentArray.push(isNaN(item) ? item : Number(item));
                }
            }
            continue;
        }

        // Key: value or Key:
        const match = line.match(/^(\s*)(\w+):\s*(.*)$/);
        if (match) {
            const [, indent, key, value] = match;
            const depth = indent.length;

            if (value) {
                // Simple key: value
                if (depth === 0) {
                    result[key] = isNaN(value) ? (value === 'true' ? true : value === 'false' ? false : value) : Number(value);
                } else if (currentKey && typeof result[currentKey] === 'object' && !Array.isArray(result[currentKey])) {
                    result[currentKey][key] = isNaN(value) ? (value === 'true' ? true : value === 'false' ? false : value) : Number(value);
                }
            } else {
                // Object or array start
                if (depth === 0) {
                    currentKey = key;
                    result[key] = {};
                    currentArray = null;
                } else if (currentKey) {
                    result[currentKey][key] = [];
                    currentArray = result[currentKey][key];
                }
            }
        }
    }

    return result;
}

function handleConfigSave() {
    const editor = $('config-editor');
    const content = editor.value;

    const validation = validateConfigEditor(content);

    if (validation.valid) {
        localStorage.setItem(CONFIG_STORAGE_KEY, content);
        showConfigValidation('Config saved', 'valid');
        setSt('cfg', 'Saved', 'ok');
    } else {
        localStorage.setItem(CONFIG_STORAGE_KEY, content);
        showConfigValidation('Saved with warnings: ' + validation.errors.join(', '), 'warning');
        setSt('cfg', 'Saved (warnings)', 'warn');
    }
}

function handleConfigReset() {
    if (confirm('Reset config to example? Your changes will be lost.')) {
        const editor = $('config-editor');
        editor.value = JSON.stringify(EXAMPLE_CONFIG, null, 2);
        localStorage.removeItem(CONFIG_STORAGE_KEY);
        validateConfigEditor(editor.value);
        checkCapabilities();
        showConfigValidation('Reset to example config', 'valid');
        setSt('cfg', 'Example', 'ok');
    }
}

function validateConfigEditor(content) {
    const result = { valid: true, errors: [], warnings: [] };

    let config;
    try {
        config = JSON.parse(content);
    } catch (err) {
        result.valid = false;
        result.errors.push('Invalid JSON: ' + err.message);
        showConfigValidation(result.errors[0], 'invalid');
        setSt('cfg', 'Invalid JSON', 'err');
        return result;
    }

    // Check required fields
    for (const field of CONFIG_REQUIRED_FIELDS) {
        const value = getNestedValue(config, field);
        if (value === undefined || value === null || value === '') {
            result.valid = false;
            result.errors.push(field);
        }
    }

    // Check valid enum values
    const validTypes = ['temporal', 'spatial', 'ordinal', 'spectral', 'continuous'];
    if (config.index?.type && !validTypes.includes(config.index.type)) {
        result.warnings.push('index.type should be: ' + validTypes.join(', '));
    }

    const validMonotonic = ['increasing', 'decreasing', 'none'];
    if (config.index?.monotonic && !validMonotonic.includes(config.index.monotonic)) {
        result.warnings.push('index.monotonic should be: ' + validMonotonic.join(', '));
    }

    const validBoundary = ['truncate', 'pad', 'error'];
    if (config.windows?.boundary && !validBoundary.includes(config.windows.boundary)) {
        result.warnings.push('windows.boundary should be: ' + validBoundary.join(', '));
    }

    // Check logical constraints
    if (config.windows?.stride > config.windows?.size) {
        result.warnings.push('stride > size creates gaps');
    }

    // Type validation for numeric fields
    if (config.windows?.size !== undefined && (typeof config.windows.size !== 'number' || config.windows.size <= 0)) {
        result.warnings.push('windows.size should be a positive number');
    }
    if (config.windows?.stride !== undefined && (typeof config.windows.stride !== 'number' || config.windows.stride <= 0)) {
        result.warnings.push('windows.stride should be a positive number');
    }
    if (config.windows?.min_observations !== undefined) {
        if (typeof config.windows.min_observations !== 'number' || config.windows.min_observations <= 0) {
            result.warnings.push('windows.min_observations should be a positive number');
        } else if (config.windows.min_observations > config.windows?.size) {
            result.warnings.push('min_observations > size (will have no valid windows)');
        }
    }

    // Check for recommended fields (warnings, not errors)
    if (!config.signals || !Array.isArray(config.signals)) {
        result.warnings.push('signals array missing - no signal columns defined');
    } else if (config.signals.length === 0) {
        result.warnings.push('signals array empty - define signal columns');
    } else {
        // Validate signal entries
        for (let i = 0; i < config.signals.length; i++) {
            const sig = config.signals[i];
            if (!sig.column) {
                result.warnings.push(`signals[${i}].column missing`);
            }
        }
    }

    if (!config.layers) {
        result.warnings.push('layers not defined - using defaults');
    }

    if (!config.engines) {
        result.warnings.push('engines not defined - using defaults');
    } else {
        if (!config.engines.core || !Array.isArray(config.engines.core) || config.engines.core.length === 0) {
            result.warnings.push('engines.core empty - no analyses will run');
        }
    }

    // Check if index column matches inspection data
    if (lastInspection && config.index?.column) {
        const colNames = lastInspection.signals?.map(s => s.name) || [];
        if (colNames.length > 0 && !colNames.includes(config.index.column)) {
            result.warnings.push(`index.column "${config.index.column}" not found in data`);
        }
    }

    // Check if signal columns match inspection data
    if (lastInspection && config.signals && Array.isArray(config.signals)) {
        const colNames = lastInspection.signals?.map(s => s.name) || [];
        if (colNames.length > 0) {
            for (const sig of config.signals) {
                if (sig.column && !colNames.includes(sig.column)) {
                    result.warnings.push(`signal "${sig.column}" not found in data`);
                }
            }
        }
    }

    // Display result
    if (result.errors.length > 0) {
        showConfigValidation('Missing required: ' + result.errors.join(', '), 'invalid');
        setSt('cfg', 'Missing fields', 'err');
    } else if (result.warnings.length > 0) {
        const warnCount = result.warnings.length;
        const preview = result.warnings.slice(0, 2).join('; ');
        const suffix = warnCount > 2 ? ` (+${warnCount - 2} more)` : '';
        showConfigValidation('‚ö† ' + preview + suffix, 'warning');
        setSt('cfg', `${warnCount} warning${warnCount > 1 ? 's' : ''}`, 'warn');
    } else {
        showConfigValidation('Config valid', 'valid');
        setSt('cfg', 'Valid', 'ok');
    }

    return result;
}

function getNestedValue(obj, path) {
    return path.split('.').reduce((o, k) => (o || {})[k], obj);
}

function showConfigValidation(message, type) {
    const el = $('config-validation');
    const icon = type === 'valid' ? '‚úì' : type === 'warning' ? '‚ö†' : '‚úó';
    el.textContent = icon + ' ' + message;
    el.className = 'validation-message ' + type;
}

function getConfig() {
    const editor = $('config-editor');
    try {
        return JSON.parse(editor.value);
    } catch {
        return null;
    }
}

// Export for PRISM integration
window.orthonConfig = {
    get: getConfig,
    validate: validateConfigEditor
};

// =====================================================================
// AI CONCIERGE
// =====================================================================

let conciergeAvailable = false;
let lastConciergeConfig = null;
let chatHistory = [];

async function checkConcierge() {
    try {
        const r = await fetch('/api/concierge/status');
        const data = await r.json();
        conciergeAvailable = data.available;

        // Show/hide AI tab in sidebar
        const aiTab = $('ai-tab');

        if (conciergeAvailable) {
            setSt('concierge', 'Ready', 'ok');
            if (aiTab) aiTab.style.display = 'block';
            $('concierge-unavailable').style.display = 'none';
            $('concierge-ready').style.display = 'block';
        } else {
            setSt('concierge', 'No API Key', 'warn');
            if (aiTab) aiTab.style.display = 'block';  // Still show tab, but with message
            $('concierge-unavailable').style.display = 'block';
            $('concierge-ready').style.display = 'none';
            $('concierge-chat').style.display = 'none';
        }
    } catch (e) {
        setSt('concierge', 'Unavailable', 'err');
        const aiTab = $('ai-tab');
        if (aiTab) aiTab.style.display = 'none';
    }
}

async function validateWithConcierge(file) {
    if (!conciergeAvailable) return;

    $('concierge-ready').style.display = 'none';
    $('concierge-loading').style.display = 'flex';
    $('concierge-validation-panel').style.display = 'none';
    $('concierge-config-panel').style.display = 'none';
    setSt('concierge', 'Analyzing...', 'warn');

    try {
        const formData = new FormData();
        formData.append('file', file);

        const r = await fetch('/api/concierge/validate', {
            method: 'POST',
            body: formData,
        });

        if (!r.ok) {
            throw new Error('Validation failed');
        }

        const data = await r.json();

        // Display validation report
        $('concierge-loading').style.display = 'none';
        $('concierge-validation-panel').style.display = 'block';

        // Render the markdown report
        const reportHtml = renderMarkdown(data.report || 'No analysis available');
        $('concierge-report').innerHTML = reportHtml;

        // Show confidence
        const confidence = data.confidence || 0;
        const confidencePct = Math.round(confidence * 100);
        $('concierge-confidence').textContent = `${confidencePct}% confidence`;

        const fill = $('confidence-fill');
        fill.style.width = `${confidencePct}%`;
        fill.className = 'confidence-fill' + (confidence < 0.5 ? ' low' : confidence < 0.8 ? ' medium' : '');

        // Store suggested config
        if (data.config && Object.keys(data.config).length > 0) {
            lastConciergeConfig = data.config;
            $('concierge-config-panel').style.display = 'block';
        }

        // Show chat interface
        $('concierge-chat').style.display = 'flex';

        setSt('concierge', 'Ready', 'ok');

    } catch (e) {
        console.warn('Concierge validation error:', e);
        $('concierge-loading').style.display = 'none';
        setSt('concierge', 'Error', 'err');
    }
}

window.applyConciergeConfig = function() {
    if (!lastConciergeConfig) return;

    // Build a config from the concierge suggestion
    const suggestion = lastConciergeConfig;
    const currentConfig = getConfig() || EXAMPLE_CONFIG;

    // Apply index settings
    if (suggestion.index_column) {
        currentConfig.index = currentConfig.index || {};
        currentConfig.index.column = suggestion.index_column;
    }
    if (suggestion.index_dimension) {
        currentConfig.index = currentConfig.index || {};
        const typeMap = { 'time': 'temporal', 'space': 'spatial', 'frequency': 'spectral', 'scale': 'ordinal' };
        currentConfig.index.type = typeMap[suggestion.index_dimension] || 'temporal';
    }

    // Apply signal settings
    if (suggestion.columns) {
        currentConfig.signals = [];
        for (const [colName, colConfig] of Object.entries(suggestion.columns)) {
            if (colName !== suggestion.index_column) {
                currentConfig.signals.push({
                    column: colName,
                    type: colConfig.signal_class || 'continuous',
                    unit: colConfig.unit,
                    physical_quantity: colConfig.quantity
                });
            }
        }
    }

    // Update the config editor
    $('config-editor').value = JSON.stringify(currentConfig, null, 2);
    validateConfigEditor($('config-editor').value);
    checkCapabilities();

    // Show confirmation
    showConfigValidation('Applied AI-suggested config', 'valid');
    setSt('cfg', 'AI Config', 'ok');

    // Switch to config tab
    showView('config');
};

window.askConcierge = async function() {
    if (!conciergeAvailable) return;

    const input = $('chat-input');
    const question = input.value.trim();
    if (!question) return;

    // Clear input
    input.value = '';

    // Add user message to chat
    const messagesDiv = $('chat-messages');
    messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(question)}</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Add loading indicator
    const loadingId = 'chat-loading-' + Date.now();
    messagesDiv.innerHTML += `<div id="${loadingId}" class="chat-message assistant" style="color: var(--dim);">Thinking...</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
        // Build context from inspection and results
        const signalSummaries = lastInspection?.signals || [];

        // Use FormData for the API
        const formData = new FormData();
        formData.append('question', question);
        formData.append('signals', JSON.stringify(signalSummaries));
        formData.append('history', JSON.stringify(chatHistory));

        const r = await fetch('/api/concierge/ask', {
            method: 'POST',
            body: formData
        });

        const data = await r.json();

        // Remove loading indicator
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        // Add assistant response
        const answerHtml = renderMarkdown(data.answer || 'I could not find an answer.');
        messagesDiv.innerHTML += `<div class="chat-message assistant">${answerHtml}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Update history
        chatHistory.push({ role: 'user', content: question });
        chatHistory.push({ role: 'assistant', content: data.answer });

        // Keep history manageable
        if (chatHistory.length > 10) {
            chatHistory = chatHistory.slice(-10);
        }

    } catch (e) {
        console.warn('Concierge ask error:', e);
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) {
            loadingEl.textContent = 'Error: Could not get response';
            loadingEl.style.color = 'var(--red)';
        }
    }
};

window.explainError = async function(errorMessage, context) {
    if (!conciergeAvailable) return null;

    try {
        const formData = new FormData();
        formData.append('error_message', errorMessage);
        formData.append('error_context', context || '');

        const r = await fetch('/api/concierge/explain-error', {
            method: 'POST',
            body: formData
        });

        if (!r.ok) return null;
        return await r.json();
    } catch (e) {
        console.warn('Error explanation failed:', e);
        return null;
    }
};

window.interpretResults = async function() {
    if (!conciergeAvailable) return;

    // Gather result summaries from loaded tables
    const summaries = {};

    try {
        // Try to get signal typology
        const typologyResult = await conn.query(`SELECT * FROM signal_typology LIMIT 50`);
        summaries.signals = typologyResult.toArray();
    } catch (e) { /* table may not exist */ }

    try {
        // Try to get causal mechanics
        const causalResult = await conn.query(`SELECT * FROM causal_mechanics LIMIT 20`);
        summaries.causal = causalResult.toArray();
    } catch (e) { /* table may not exist */ }

    if (Object.keys(summaries).length === 0) {
        alert('No analysis results to interpret. Run PRISM analysis first.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('system_summary', JSON.stringify(summaries));
        formData.append('signals', JSON.stringify(summaries.signals || []));
        formData.append('causal', JSON.stringify(summaries.causal || []));

        const r = await fetch('/api/concierge/interpret', {
            method: 'POST',
            body: formData
        });

        const data = await r.json();

        // Display interpretation in chat
        const messagesDiv = $('chat-messages');
        const interpretHtml = renderMarkdown(data.interpretation || 'No interpretation available.');
        messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-left: 2px solid var(--purple); padding-left: 0.5rem;">${interpretHtml}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Ensure chat is visible
        $('concierge-chat').style.display = 'flex';

    } catch (e) {
        console.warn('Interpretation failed:', e);
    }
};

// =====================================================================
// MARKDOWN GENERATION
// =====================================================================

const SQL_DOCS = [
    { id: '00_load', name: 'Load Data', desc: 'Load observations into database' },
    { id: '01_calculus', name: 'Calculus', desc: 'Derivatives, curvature, arc length' },
    { id: '02_statistics', name: 'Statistics', desc: 'Rolling stats, z-scores, ACF' },
    { id: '03_signal_class', name: 'Sensor Class', desc: 'Sensor classification' },
    { id: '04_typology', name: 'Typology', desc: 'Behavioral type detection' },
    { id: '05_geometry', name: 'Geometry', desc: 'Correlations, coupling network' },
    { id: '06_dynamics', name: 'Dynamics', desc: 'Regime detection, transitions' },
    { id: '07_causality', name: 'Causality', desc: 'Granger, transfer entropy' },
    { id: '08_entropy', name: 'Entropy', desc: 'Information measures' },
    { id: '09_physics', name: 'Physics', desc: 'Domain-specific physics' },
    { id: '10_manifold', name: 'Manifold', desc: 'Final assembly, export' },
    { id: '00_index_detection', name: 'Index Detection', desc: 'Time/space index detection' },
    { id: '00_observations', name: 'Observations', desc: 'Canonical schema creation' },
    { id: '01_classification_units', name: 'Unit Classification', desc: 'Unit-based sensor classes' },
    { id: '06_general_views', name: 'General Views', desc: 'Dashboard views' },
    { id: '11_ml_features', name: 'ML Features', desc: 'Machine learning feature extraction' },
];

function initMarkdownList() {
    const list = $('markdown-list');
    list.innerHTML = '';

    for (const doc of SQL_DOCS) {
        const div = document.createElement('div');
        div.className = 'cap ok';
        div.innerHTML = `
            <input type="checkbox" id="md-${doc.id}" data-doc="${doc.id}" onchange="updateMarkdownCount()">
            <label for="md-${doc.id}" style="flex:1; cursor:pointer;">
                <span class="cap-name">${doc.name}</span>
                <span class="lvl" style="display:block; font-size:0.6rem; color:var(--dim);">${doc.desc}</span>
            </label>
        `;
        list.appendChild(div);
    }
    updateMarkdownCount();
}

function updateMarkdownCount() {
    const checked = document.querySelectorAll('#markdown-list input[type="checkbox"]:checked').length;
    $('md-count').textContent = `${checked} selected`;
}

function selectAllMarkdowns(selectAll) {
    document.querySelectorAll('#markdown-list input[type="checkbox"]').forEach(cb => {
        cb.checked = selectAll;
    });
    updateMarkdownCount();
}

async function generateMarkdowns() {
    const selected = [];
    document.querySelectorAll('#markdown-list input[type="checkbox"]:checked').forEach(cb => {
        selected.push(cb.dataset.doc);
    });

    if (selected.length === 0) {
        $('markdown-status').innerHTML = '<span style="color:var(--yellow);">Select at least one document</span>';
        return;
    }

    $('markdown-status').innerHTML = '<span style="color:var(--accent);">Generating...</span>';

    try {
        const response = await fetch('/api/generate-markdowns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ documents: selected })
        });

        const result = await response.json();

        if (result.status === 'complete') {
            $('markdown-status').innerHTML = `<span style="color:var(--green);">‚úì Generated ${result.files.length} files</span>`;
        } else {
            $('markdown-status').innerHTML = `<span style="color:var(--red);">Error: ${result.message}</span>`;
        }
    } catch (e) {
        $('markdown-status').innerHTML = `<span style="color:var(--red);">Error: ${e.message}</span>`;
    }
}

// =====================================================================
// AI-GUIDED TUNING
// =====================================================================

let tuningResult = null;  // Store last tuning result

async function runTuningAnalysis() {
    const progress = $('tuning-progress');
    const btn = $('run-tuning-btn');
    const badge = $('tuning-status-badge');

    progress.style.display = 'block';
    btn.disabled = true;
    badge.textContent = 'Running...';
    badge.style.background = 'var(--yellow)';

    try {
        const resp = await fetch('/api/tuning/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });

        if (!resp.ok) {
            const error = await resp.json();
            throw new Error(error.detail || 'Tuning analysis failed');
        }

        tuningResult = await resp.json();
        displayTuningResults(tuningResult);

        badge.textContent = 'Complete';
        badge.style.background = 'var(--green)';

    } catch (e) {
        badge.textContent = 'Error';
        badge.style.background = 'var(--red)';
        alert('Tuning error: ' + e.message);
    } finally {
        progress.style.display = 'none';
        btn.disabled = false;
    }
}

function displayTuningResults(result) {
    // Show optimal threshold section
    $('threshold-section').style.display = 'block';
    $('optimal-z-warning').textContent = result.optimal_z_threshold?.toFixed(1) || '‚Äî';
    $('optimal-z-critical').textContent = ((result.optimal_z_threshold || 2.5) + 1.0).toFixed(1);
    $('detection-rate').textContent = (result.detection_rate?.toFixed(1) || '‚Äî') + '%';
    $('avg-lead-time').textContent = (result.avg_lead_time?.toFixed(1) || '‚Äî') + ' samples';

    // Show fault signatures
    if (result.best_metrics_by_fault_type && Object.keys(result.best_metrics_by_fault_type).length > 0) {
        $('signatures-section').style.display = 'block';
        const sigHtml = Object.entries(result.best_metrics_by_fault_type)
            .map(([fault, metric]) => `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid var(--border);">
                    <span style="color: var(--dim);">${fault}</span>
                    <span style="color: var(--accent); font-weight: 500;">${metric}</span>
                </div>
            `).join('');
        $('fault-signatures').innerHTML = sigHtml;
    }

    // Show metric rankings
    if (result.metric_rankings && result.metric_rankings.length > 0) {
        $('rankings-section').style.display = 'block';
        const rankHtml = result.metric_rankings.map((m, i) => `
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                <span style="color: var(--dim); width: 1rem;">${i + 1}.</span>
                <span style="flex: 1;">${m.metric_name}</span>
                <span style="color: var(--green); font-size: 0.65rem;">${m.detection_rate_pct?.toFixed(0) || '‚Äî'}%</span>
                <span style="color: var(--accent); font-size: 0.65rem;">${m.avg_lead_time?.toFixed(0) || '‚Äî'}</span>
            </div>
        `).join('');
        $('metric-rankings').innerHTML = `
            <div style="display: flex; gap: 0.5rem; padding: 0.25rem 0; font-size: 0.6rem; color: var(--dim); text-transform: uppercase;">
                <span style="width: 1rem;">#</span>
                <span style="flex: 1;">Metric</span>
                <span>Det%</span>
                <span>Lead</span>
            </div>
            ${rankHtml}
        `;
    }

    // Show recommendations
    if (result.recommendations) {
        $('recommendations-section').style.display = 'block';
        $('tuning-recommendations').innerHTML = renderMarkdown(result.recommendations);
    }

    // Show generate config button
    $('generate-config-section').style.display = 'block';
}

async function generateTunedConfig() {
    try {
        const resp = await fetch('/api/tuning/generate-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });

        if (!resp.ok) {
            const error = await resp.json();
            throw new Error(error.detail || 'Config generation failed');
        }

        const config = await resp.json();
        $('tuned-config-json').textContent = JSON.stringify(config, null, 2);
        $('tuned-config-result').style.display = 'block';

    } catch (e) {
        alert('Error generating config: ' + e.message);
    }
}

function copyTunedConfig() {
    const configText = $('tuned-config-json').textContent;
    navigator.clipboard.writeText(configText).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 1500);
    });
}

function toggleSection(titleElement) {
    titleElement.classList.toggle('collapsed');
    const content = titleElement.nextElementSibling;
    content.classList.toggle('collapsed');
}

async function checkLabels() {
    // Check if labels are available in loaded data
    try {
        const resp = await fetch('/api/tuning/labels');
        if (resp.ok) {
            const data = await resp.json();
            if (data.labels && data.labels.length > 0) {
                $('labels-count').textContent = `${data.labels.length} found`;
                $('labels-info').style.display = 'none';
                $('labels-list').style.display = 'block';
                $('labels-list').innerHTML = data.labels.map(l => `
                    <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; font-size: 0.7rem; border-bottom: 1px solid var(--border);">
                        <span style="color: var(--accent);">${l.label_name}</span>
                        <span style="color: var(--dim);">${l.n_entities} entities</span>
                    </div>
                `).join('');
            }
        }
    } catch (e) {
        // Labels not available, show default message
    }
}

// Init
setSt('cfg', '‚Äî', '');
setSt('data', '‚Äî', '');
setSt('prism', 'Checking...', '');
setSt('concierge', '‚Äî', '');
initDuckDB();
checkPRISM();
checkConcierge();
populateQueryDropdown();
initConfigTab();
initMarkdownList();
</script>
</body>
</html>
