<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√òrthon</title>
    <script src="https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/dist/duckdb-browser-blocking.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
            --purple: #bc8cff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: ui-monospace, 'Cascadia Code', 'SF Mono', Consolas, monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .logo { font-size: 1.25rem; font-weight: 600; }
        .logo span { color: var(--accent); }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            margin-left: 2rem;
        }

        .nav-tab {
            padding: 0.4rem 1rem;
            background: transparent;
            border: none;
            color: var(--dim);
            font: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.15s;
        }

        .nav-tab:hover { color: var(--text); background: var(--input); }
        .nav-tab.active { color: var(--accent); background: var(--input); }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child { border-bottom: none; flex: 1; overflow: auto; }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--dim);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }

        /* Config */
        textarea {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: none;
            line-height: 1.5;
        }

        textarea:focus { outline: none; border-color: var(--accent); }

        /* Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-zone:hover { border-color: var(--accent); background: rgba(88,166,255,0.05); }
        .upload-zone.has-file { border-color: var(--green); border-style: solid; }
        .upload-zone.dragover { border-color: var(--accent); background: rgba(88,166,255,0.1); }

        .upload-icon { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .upload-text { color: var(--dim); font-size: 0.75rem; }

        .file-info {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--input);
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        .file-info .name { color: var(--green); }
        .file-info .size { color: var(--dim); }

        /* Capabilities */
        .cap-list { display: flex; flex-direction: column; gap: 0.25rem; }

        .cap {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.5rem;
            background: var(--input);
            border-radius: 3px;
            font-size: 0.7rem;
            border-left: 2px solid var(--border);
        }

        .cap.ok { border-left-color: var(--green); }
        .cap.no { opacity: 0.35; }

        .cap-name { flex: 1; }

        .lvl {
            font-size: 0.6rem;
            padding: 0.1rem 0.25rem;
            border-radius: 2px;
            background: var(--bg);
        }

        .lvl-0 { color: #58a6ff; } .lvl-1 { color: #56d4dd; }
        .lvl-2 { color: #d29922; } .lvl-3 { color: #bc8cff; }
        .lvl-4 { color: #f85149; }

        /* Buttons */
        .btn {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input);
            color: var(--text);
            font: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.15s;
        }

        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }

        /* Data Table */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            background: var(--panel);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            background: var(--input);
            color: var(--dim);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover td { background: rgba(88,166,255,0.05); }

        .null { color: var(--dim); font-style: italic; }
        .num { color: var(--green); }
        .str { color: var(--yellow); }

        /* Schema */
        .schema-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
        }

        .schema-name { flex: 1; }
        .schema-type {
            color: var(--purple);
            font-size: 0.7rem;
            background: var(--input);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        /* Query */
        .query-area {
            padding: 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .query-input {
            width: 100%;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: vertical;
            min-height: 80px;
        }

        .query-input:focus { outline: none; border-color: var(--accent); }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
        }

        .stat-card {
            background: var(--input);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .stat-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.1rem; font-weight: 500; margin-top: 0.25rem; }
        .stat-sub { font-size: 0.7rem; color: var(--dim); margin-top: 0.25rem; }

        /* Status Bar */
        #status {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 0.4rem 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .st { display: flex; align-items: center; gap: 0.4rem; }
        .st-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); }
        .st-dot.ok { background: var(--green); }
        .st-dot.warn { background: var(--yellow); }
        .st-dot.err { background: var(--red); }
        .st-label { color: var(--dim); }

        .level-bar { display: flex; gap: 2px; margin-left: auto; align-items: center; }
        .level-seg { width: 14px; height: 5px; background: var(--border); border-radius: 2px; }
        .level-seg.on { background: var(--accent); }
        .level-name { margin-left: 0.5rem; color: var(--dim); }

        #file-input { display: none; }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dim);
            gap: 0.5rem;
        }

        .empty-state-icon { font-size: 2.5rem; opacity: 0.3; }
        .empty-state-text { font-size: 0.85rem; }

        .toolbar {
            padding: 0.5rem 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toolbar-info { color: var(--dim); font-size: 0.75rem; margin-left: auto; }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--dim);
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="logo"><span>√ò</span>rthon</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('data')">Data</button>
            <button class="nav-tab" onclick="showView('schema')">Schema</button>
            <button class="nav-tab" onclick="showView('query')">Query</button>
            <button class="nav-tab" onclick="showView('stats')">Stats</button>
        </div>
        <div class="header-right">
            <div id="db-status" class="loading">
                <div class="spinner"></div>
                <span>Loading DuckDB...</span>
            </div>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <!-- Upload -->
            <div class="sidebar-section">
                <div class="section-title">Data File</div>
                <div class="upload-zone" id="dropzone" onclick="$('file-input').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop parquet or click</div>
                </div>
                <input type="file" id="file-input" accept=".parquet,.csv" onchange="onFile(this)">
                <div id="file-info" class="file-info" style="display:none"></div>
            </div>

            <!-- Config -->
            <div class="sidebar-section">
                <div class="section-title">
                    Config
                    <button class="btn btn-sm" onclick="loadExample()">Example</button>
                </div>
                <textarea id="config" rows="10" placeholder="# YAML config...
window_size: 50
window_stride: 25

signals:
  - name: sensor_1
"></textarea>
                <div class="actions">
                    <button class="btn btn-primary" onclick="check()">Check</button>
                </div>
            </div>

            <!-- Capabilities -->
            <div class="sidebar-section">
                <div class="section-title">
                    Capabilities
                    <span id="cap-count">‚Äî</span>
                </div>
                <div class="cap-list" id="caps"></div>
            </div>
        </div>

        <div class="content">
            <!-- Data View -->
            <div class="view active" id="view-data">
                <div class="toolbar">
                    <span style="color: var(--dim)">Table:</span>
                    <select id="table-select" onchange="loadTable(this.value)" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <option value="">‚Äî Select ‚Äî</option>
                    </select>
                    <button class="btn btn-sm" onclick="refreshTable()">Refresh</button>
                    <div class="toolbar-info" id="row-count"></div>
                </div>
                <div class="table-wrapper" id="table-wrapper">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Load a parquet file to view data</div>
                    </div>
                </div>
            </div>

            <!-- Schema View -->
            <div class="view" id="view-schema">
                <div class="toolbar">
                    <span style="color: var(--dim)">Schema for loaded table</span>
                </div>
                <div id="schema-list" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Load a file to view schema</div>
                    </div>
                </div>
            </div>

            <!-- Query View -->
            <div class="view" id="view-query">
                <div class="query-area">
                    <textarea id="query-input" class="query-input" placeholder="SELECT * FROM data LIMIT 100"></textarea>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="runQuery()">Run Query</button>
                        <button class="btn" onclick="$('query-input').value = 'SELECT * FROM data LIMIT 100'">Reset</button>
                    </div>
                </div>
                <div class="table-wrapper" id="query-results">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <div class="empty-state-text">Run a SQL query</div>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div class="view" id="view-stats">
                <div id="stats-container" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div class="empty-state-text">Load data to view statistics</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="status">
        <div class="st">
            <div class="st-dot" id="cfg-dot"></div>
            <span class="st-label">Config:</span>
            <span id="cfg-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="data-dot"></div>
            <span class="st-label">Data:</span>
            <span id="data-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="db-dot"></div>
            <span class="st-label">DuckDB:</span>
            <span id="db-st">Loading...</span>
        </div>
        <div class="level-bar">
            <span class="st-label">Level:</span>
            <div class="level-seg" id="l0"></div>
            <div class="level-seg" id="l1"></div>
            <div class="level-seg" id="l2"></div>
            <div class="level-seg" id="l3"></div>
            <div class="level-seg" id="l4"></div>
            <span class="level-name" id="lvl-name">‚Äî</span>
        </div>
    </div>

<script type="module">
import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

const $ = id => document.getElementById(id);
window.$ = $;

// =====================================================================
// DUCKDB SETUP
// =====================================================================

let db = null;
let conn = null;

async function initDuckDB() {
    try {
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        const worker_url = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
        );

        const worker = new Worker(worker_url);
        const logger = new duckdb.ConsoleLogger();
        db = new duckdb.AsyncDuckDB(logger, worker);

        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        conn = await db.connect();

        $('db-status').innerHTML = '<span style="color: var(--green)">‚úì DuckDB Ready</span>';
        setSt('db', 'Ready', 'ok');

        URL.revokeObjectURL(worker_url);
    } catch (e) {
        console.error('DuckDB init failed:', e);
        $('db-status').innerHTML = '<span style="color: var(--red)">‚úó DuckDB Failed</span>';
        setSt('db', 'Error', 'err');
    }
}

// =====================================================================
// FILE HANDLING
// =====================================================================

let currentFile = null;
let currentTable = 'data';

window.onFile = async function(input) {
    const file = input.files[0];
    if (!file || !conn) return;

    currentFile = file;

    $('dropzone').classList.add('has-file');
    $('file-info').style.display = 'flex';
    $('file-info').innerHTML = `<span class="name">${file.name}</span><span class="size">${(file.size/1024).toFixed(1)} KB</span>`;
    setSt('data', file.name, 'ok');

    // Load into DuckDB
    try {
        const buffer = await file.arrayBuffer();
        await db.registerFileBuffer(file.name, new Uint8Array(buffer));

        if (file.name.endsWith('.parquet')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_parquet('${file.name}')`);
        } else if (file.name.endsWith('.csv')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_csv_auto('${file.name}')`);
        }

        // Update table select
        $('table-select').innerHTML = '<option value="data">data</option>';
        $('table-select').value = 'data';

        await loadTable('data');
        await loadSchema();
        await loadStats();

    } catch (e) {
        console.error('File load error:', e);
        setSt('data', 'Error: ' + e.message, 'err');
    }
};

async function loadTable(tableName) {
    if (!conn || !tableName) return;

    currentTable = tableName;

    try {
        const result = await conn.query(`SELECT * FROM ${tableName} LIMIT 1000`);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('table-wrapper', columns, rows);
        $('row-count').textContent = `${rows.length} rows (limited)`;

    } catch (e) {
        console.error('Query error:', e);
        $('table-wrapper').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${e.message}</div></div>`;
    }
}
window.loadTable = loadTable;

async function loadSchema() {
    if (!conn) return;

    try {
        const result = await conn.query(`DESCRIBE ${currentTable}`);
        const rows = result.toArray();

        let html = '';
        for (const row of rows) {
            html += `
                <div class="schema-item">
                    <span class="schema-name">${row.column_name}</span>
                    <span class="schema-type">${row.column_type}</span>
                </div>
            `;
        }

        $('schema-list').innerHTML = html || '<div class="empty-state"><div class="empty-state-text">No columns</div></div>';

    } catch (e) {
        console.error('Schema error:', e);
    }
}

async function loadStats() {
    if (!conn) return;

    try {
        // Get row count
        const countResult = await conn.query(`SELECT COUNT(*) as cnt FROM ${currentTable}`);
        const rowCount = countResult.toArray()[0].cnt;

        // Get column stats
        const descResult = await conn.query(`DESCRIBE ${currentTable}`);
        const columns = descResult.toArray();

        let html = '<div class="stats-grid">';

        html += `
            <div class="stat-card">
                <div class="stat-label">Total Rows</div>
                <div class="stat-value">${Number(rowCount).toLocaleString()}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Columns</div>
                <div class="stat-value">${columns.length}</div>
            </div>
        `;

        // Get numeric column stats
        const numericCols = columns.filter(c =>
            c.column_type.includes('INT') ||
            c.column_type.includes('FLOAT') ||
            c.column_type.includes('DOUBLE') ||
            c.column_type.includes('DECIMAL')
        );

        for (const col of numericCols.slice(0, 8)) {
            try {
                const statsResult = await conn.query(`
                    SELECT
                        MIN("${col.column_name}") as min_val,
                        MAX("${col.column_name}") as max_val,
                        AVG("${col.column_name}") as avg_val,
                        COUNT(*) - COUNT("${col.column_name}") as null_count
                    FROM ${currentTable}
                `);
                const stats = statsResult.toArray()[0];

                html += `
                    <div class="stat-card">
                        <div class="stat-label">${col.column_name}</div>
                        <div class="stat-value">${formatNum(stats.avg_val)}</div>
                        <div class="stat-sub">${formatNum(stats.min_val)} ‚Üí ${formatNum(stats.max_val)}</div>
                    </div>
                `;
            } catch (e) {
                // Skip problematic columns
            }
        }

        html += '</div>';
        $('stats-container').innerHTML = html;

    } catch (e) {
        console.error('Stats error:', e);
    }
}

function formatNum(n) {
    if (n === null || n === undefined) return '‚Äî';
    if (typeof n === 'bigint') n = Number(n);
    if (Math.abs(n) > 1000000) return n.toExponential(2);
    if (Math.abs(n) < 0.01 && n !== 0) return n.toExponential(2);
    return Number(n).toLocaleString(undefined, { maximumFractionDigits: 4 });
}

window.runQuery = async function() {
    if (!conn) return;

    const query = $('query-input').value;

    try {
        const result = await conn.query(query);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('query-results', columns, rows);

    } catch (e) {
        $('query-results').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${e.message}</div></div>`;
    }
};

window.refreshTable = () => loadTable(currentTable);

function renderTable(containerId, columns, rows) {
    let html = '<table><thead><tr>';

    for (const col of columns) {
        html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
            const val = row[col];
            let cellClass = '';
            let display = '';

            if (val === null || val === undefined) {
                cellClass = 'null';
                display = 'NULL';
            } else if (typeof val === 'number' || typeof val === 'bigint') {
                cellClass = 'num';
                display = formatNum(val);
            } else {
                cellClass = 'str';
                display = String(val).slice(0, 100);
            }

            html += `<td class="${cellClass}">${display}</td>`;
        }
        html += '</tr>';
    }

    html += '</tbody></table>';
    $(containerId).innerHTML = html;
}

// =====================================================================
// VIEW NAVIGATION
// =====================================================================

window.showView = function(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

    $('view-' + view).classList.add('active');
    event.target.classList.add('active');
};

// =====================================================================
// CAPABILITIES
// =====================================================================

const CAPS = {
    STATISTICS:        { l: 0, n: 'Statistics', r: [] },
    ENTROPY:           { l: 0, n: 'Entropy', r: [] },
    MEMORY:            { l: 0, n: 'Memory', r: [] },
    SPECTRAL:          { l: 0, n: 'Spectral', r: [] },
    RECURRENCE:        { l: 0, n: 'Recurrence', r: [] },
    CHAOS:             { l: 0, n: 'Lyapunov', r: [] },
    GEOMETRY:          { l: 0, n: 'Geometry', r: [] },
    DYNAMICS:          { l: 0, n: 'Dynamics', r: [] },

    DERIVATIVES:       { l: 1, n: 'Derivatives', r: ['labeled'] },
    SPECIFIC_KE:       { l: 1, n: 'Specific KE', r: ['velocity'] },

    KINETIC_ENERGY:    { l: 2, n: 'Kinetic Energy', r: ['velocity', 'mass'] },
    POTENTIAL_ENERGY:  { l: 2, n: 'Potential Energy', r: ['position', 'spring_constant'] },
    HAMILTONIAN:       { l: 2, n: 'Hamiltonian', r: ['position', 'velocity', 'mass', 'spring_constant'] },
    LAGRANGIAN:        { l: 2, n: 'Lagrangian', r: ['position', 'velocity', 'mass', 'spring_constant'] },
    MOMENTUM:          { l: 2, n: 'Momentum', r: ['velocity', 'mass'] },

    GIBBS:             { l: 3, n: 'Gibbs Energy', r: ['temperature', 'pressure', 'volume', 'Cp'] },
    TRANSFER_FN:       { l: 3, n: 'Transfer Fn', r: ['input', 'output'] },

    VORTICITY:         { l: 4, n: 'Vorticity', r: ['velocity_field'] },
    TKE:               { l: 4, n: 'Turbulent KE', r: ['velocity_field'] },
    ENERGY_SPECTRUM:   { l: 4, n: 'E(k)', r: ['velocity_field'] },
};

const LEVELS = ['Raw Series', 'Labeled', 'Constants', 'Related', 'Spatial'];

function parseYAML(txt) {
    const c = { signals: [], constants: {}, spatial: {} };
    let section = null, sig = null;

    for (let line of txt.split('\n')) {
        if (line.trim().startsWith('#') || !line.trim()) continue;

        const m = line.match(/^(\w+):\s*(.*)$/);
        if (m) {
            const [, k, v] = m;
            if (v) c[k] = isNaN(v) ? v : +v;
            else section = k;
        } else if (line.match(/^\s+-\s+name:\s*(.+)/)) {
            sig = { name: RegExp.$1 };
            c.signals.push(sig);
        } else if (sig && line.match(/^\s+physical_quantity:\s*(.+)/)) {
            sig.pq = RegExp.$1;
        } else if (section === 'constants' && line.match(/^\s+(\w+):\s*([\d.]+)/)) {
            c.constants[RegExp.$1] = +RegExp.$2;
        } else if (section === 'spatial' && line.match(/^\s+type:\s*(.+)/)) {
            c.spatial.type = RegExp.$1;
        } else if (section === 'relationships') {
            if (line.match(/temperature|pressure|volume/)) c.thermo = true;
            if (line.match(/input|output/)) c.control = true;
        }
    }
    return c;
}

function detect(cfg) {
    const has = new Set();

    if (cfg.signals.length >= 2) has.add('multi');
    for (const s of cfg.signals) {
        if (s.pq) { has.add('labeled'); has.add(s.pq); }
    }
    for (const k in cfg.constants) has.add(k);
    if (cfg.thermo) ['temperature', 'pressure', 'volume'].forEach(x => has.add(x));
    if (cfg.control) { has.add('input'); has.add('output'); }
    if (cfg.spatial?.type === 'velocity_field') has.add('velocity_field');

    const ok = [], no = {};
    for (const [k, cap] of Object.entries(CAPS)) {
        const miss = cap.r.filter(r => !has.has(r));
        if (miss.length === 0) ok.push(k);
        else no[k] = miss;
    }

    let lvl = 0;
    if (has.has('velocity_field')) lvl = 4;
    else if (has.has('temperature') || has.has('input')) lvl = 3;
    else if (has.has('mass') || has.has('spring_constant')) lvl = 2;
    else if (has.has('labeled')) lvl = 1;

    return { ok, no, lvl };
}

function renderCaps(res) {
    const el = $('caps');
    el.innerHTML = '';

    const all = Object.entries(CAPS).sort((a,b) => {
        const aOk = res.ok.includes(a[0]) ? 0 : 1;
        const bOk = res.ok.includes(b[0]) ? 0 : 1;
        return aOk - bOk || a[1].l - b[1].l;
    });

    for (const [k, cap] of all) {
        const isOk = res.ok.includes(k);
        const div = document.createElement('div');
        div.className = `cap ${isOk ? 'ok' : 'no'}`;
        div.innerHTML = `
            <span style="width:14px">${isOk ? '‚úì' : '‚óã'}</span>
            <span class="cap-name">${cap.n}</span>
            <span class="lvl lvl-${cap.l}">L${cap.l}</span>
        `;
        if (!isOk) div.title = 'Need: ' + res.no[k].join(', ');
        el.appendChild(div);
    }

    $('cap-count').textContent = `${res.ok.length}/${Object.keys(CAPS).length}`;
}

function setLevel(lvl) {
    for (let i = 0; i <= 4; i++) {
        $('l' + i).className = 'level-seg' + (i <= lvl ? ' on' : '');
    }
    $('lvl-name').textContent = LEVELS[lvl];
}

function setSt(id, txt, state) {
    $(id + '-dot').className = 'st-dot' + (state ? ' ' + state : '');
    $(id + '-st').textContent = txt;
}
window.setSt = setSt;

window.check = function() {
    const txt = $('config').value;
    try {
        const cfg = parseYAML(txt);
        const res = detect(cfg);

        renderCaps(res);
        setLevel(res.lvl);
        setSt('cfg', `Valid (${cfg.signals.length} sig)`, 'ok');
    } catch (e) {
        setSt('cfg', 'Invalid', 'err');
    }
};

window.loadExample = function() {
    $('config').value = `# Level 2: Mechanical
window_size: 100
window_stride: 50

signals:
  - name: position
    physical_quantity: position
  - name: velocity
    physical_quantity: velocity

constants:
  mass: 2.0
  spring_constant: 50.0
`;
    check();
};

// Drag and drop
const dz = $('dropzone');
dz.ondragover = e => { e.preventDefault(); dz.classList.add('dragover'); };
dz.ondragleave = () => dz.classList.remove('dragover');
dz.ondrop = e => {
    e.preventDefault();
    dz.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
        $('file-input').files = e.dataTransfer.files;
        onFile($('file-input'));
    }
};

// Init
setSt('cfg', '‚Äî', '');
setSt('data', '‚Äî', '');
initDuckDB();
</script>
</body>
</html>
