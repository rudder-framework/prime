<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√òRTHON</title>
    <script src="https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/dist/duckdb-browser-blocking.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
            --purple: #bc8cff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: ui-monospace, 'Cascadia Code', 'SF Mono', Consolas, monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .logo { font-size: 1.25rem; font-weight: 600; }
        .logo span { color: var(--accent); }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            margin-left: 2rem;
        }

        .nav-tab {
            padding: 0.4rem 1rem;
            background: transparent;
            border: none;
            color: var(--dim);
            font: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.15s;
        }

        .nav-tab:hover { color: var(--text); background: var(--input); }
        .nav-tab.active { color: var(--accent); background: var(--input); }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child { border-bottom: none; }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--dim);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title.collapsible {
            cursor: pointer;
            user-select: none;
        }

        .section-title.collapsible:hover {
            color: var(--text);
        }

        .section-title .toggle-icon {
            font-size: 0.6rem;
            display: inline-block;
            transition: transform 0.2s;
        }

        .section-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-title:not(.collapsed) .toggle-icon {
            transform: rotate(0deg);
        }

        .section-content {
            transition: max-height 0.2s ease-out;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0 !important;
            margin: 0;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }

        /* Config */
        textarea {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: none;
            line-height: 1.5;
        }

        textarea:focus { outline: none; border-color: var(--accent); }

        /* Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-zone:hover { border-color: var(--accent); background: rgba(88,166,255,0.05); }
        .upload-zone.has-file { border-color: var(--green); border-style: solid; }
        .upload-zone.dragover { border-color: var(--accent); background: rgba(88,166,255,0.1); }

        .upload-icon { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .upload-text { color: var(--dim); font-size: 0.75rem; }

        .file-info {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--input);
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        .file-info .name { color: var(--green); }
        .file-info .size { color: var(--dim); }

        /* Capabilities */
        .cap-list { display: flex; flex-direction: column; gap: 0.25rem; }

        .cap {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.5rem;
            background: var(--input);
            border-radius: 3px;
            font-size: 0.7rem;
            border-left: 2px solid var(--border);
        }

        .cap.ok { border-left-color: var(--green); }
        .cap.no { opacity: 0.35; }

        .cap-name { flex: 1; }

        .lvl {
            font-size: 0.6rem;
            padding: 0.1rem 0.25rem;
            border-radius: 2px;
            background: var(--bg);
        }

        .lvl-0 { color: #58a6ff; } .lvl-1 { color: #56d4dd; }
        .lvl-2 { color: #d29922; } .lvl-3 { color: #bc8cff; }
        .lvl-4 { color: #f85149; }

        /* Buttons */
        .btn {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input);
            color: var(--text);
            font: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.15s;
        }

        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }

        /* Data Table */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            background: var(--panel);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            background: var(--input);
            color: var(--dim);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover td { background: rgba(88,166,255,0.05); }

        .null { color: var(--dim); font-style: italic; }
        .num { color: var(--green); }
        .str { color: var(--yellow); }

        /* Schema */
        .schema-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
        }

        .schema-name { flex: 1; }
        .schema-type {
            color: var(--purple);
            font-size: 0.7rem;
            background: var(--input);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        /* Query */
        .query-area {
            padding: 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .query-input {
            width: 100%;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: vertical;
            min-height: 80px;
        }

        .query-input:focus { outline: none; border-color: var(--accent); }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
        }

        .stat-card {
            background: var(--input);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .stat-label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.1rem; font-weight: 500; margin-top: 0.25rem; }
        .stat-sub { font-size: 0.7rem; color: var(--dim); margin-top: 0.25rem; }

        /* Status Bar */
        #status {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 0.4rem 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .st { display: flex; align-items: center; gap: 0.4rem; }
        .st-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); }
        .st-dot.ok { background: var(--green); }
        .st-dot.warn { background: var(--yellow); }
        .st-dot.err { background: var(--red); }
        .st-label { color: var(--dim); }

        .level-bar { display: flex; gap: 2px; margin-left: auto; align-items: center; }
        .level-seg { width: 14px; height: 5px; background: var(--border); border-radius: 2px; }
        .level-seg.on { background: var(--accent); }
        .level-name { margin-left: 0.5rem; color: var(--dim); }

        #file-input { display: none; }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dim);
            gap: 0.5rem;
        }

        .empty-state-icon { font-size: 2.5rem; opacity: 0.3; }
        .empty-state-text { font-size: 0.85rem; }

        .toolbar {
            padding: 0.5rem 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toolbar-info { color: var(--dim); font-size: 0.75rem; margin-left: auto; }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--dim);
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Config Editor */
        .config-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }

        #config-editor {
            flex: 1;
            width: 100%;
            min-height: 400px;
            background: var(--input);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            line-height: 1.5;
            resize: none;
            tab-size: 2;
        }

        #config-editor:focus {
            outline: none;
            border-color: var(--accent);
        }

        .config-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .config-actions .btn-save {
            background: #1a6b3a;
            border-color: #2a8b4a;
        }

        .config-actions .btn-save:hover {
            background: #2a8b4a;
        }

        .validation-message {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .validation-message.valid {
            background: rgba(63, 185, 80, 0.15);
            color: var(--green);
        }

        .validation-message.invalid {
            background: rgba(248, 81, 73, 0.15);
            color: var(--red);
        }

        .validation-message.warning {
            background: rgba(210, 153, 34, 0.15);
            color: var(--yellow);
        }

        #config-file-input { display: none; }

        /* Pre-flight Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preflight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.4rem 0;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .preflight-item:last-child { border-bottom: none; }

        .preflight-icon { width: 16px; flex-shrink: 0; }
        .preflight-icon.ok { color: var(--green); }
        .preflight-icon.warn { color: var(--yellow); }
        .preflight-icon.err { color: var(--red); }

        .preflight-text { flex: 1; }
        .preflight-detail { color: var(--dim); font-size: 0.7rem; }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        .modal-actions .btn-danger {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        /* README styles */
        .readme-content {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text);
        }

        .readme-content h1 {
            font-size: 1.4rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin: 1.5rem 0 1rem 0;
            color: var(--text);
        }

        .readme-content h1:first-child {
            margin-top: 0;
        }

        .readme-content h2 {
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3rem;
            margin: 1.25rem 0 0.75rem 0;
            color: var(--text);
        }

        .readme-content h3 {
            font-size: 0.95rem;
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .readme-content p {
            margin: 0.5rem 0;
        }

        .readme-content code {
            background: var(--input);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
        }

        .readme-content pre {
            background: var(--input);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .readme-content pre code {
            background: none;
            padding: 0;
        }

        .readme-content ul, .readme-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .readme-content li {
            margin: 0.25rem 0;
        }

        .readme-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .readme-content a:hover {
            text-decoration: underline;
        }

        .readme-content blockquote {
            border-left: 3px solid var(--accent);
            margin: 0.75rem 0;
            padding: 0.5rem 1rem;
            background: var(--input);
            color: var(--dim);
        }

        .readme-content table {
            border-collapse: collapse;
            margin: 0.75rem 0;
            width: 100%;
        }

        .readme-content th, .readme-content td {
            border: 1px solid var(--border);
            padding: 0.4rem 0.6rem;
            text-align: left;
        }

        .readme-content th {
            background: var(--input);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><span>√ò</span>RTHON</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('data')">Data</button>
            <button class="nav-tab" onclick="showView('config')">Config</button>
            <button class="nav-tab" onclick="showView('schema')">Schema</button>
            <button class="nav-tab" onclick="showView('query')">Query</button>
            <button class="nav-tab" onclick="showView('stats')">Stats</button>
            <button class="nav-tab" onclick="showView('readme')">README</button>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <!-- Upload -->
            <div class="sidebar-section">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñº</span> Data File</span>
                </div>
                <div class="section-content">
                    <div class="upload-zone" id="dropzone" onclick="$('file-input').click()">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Drop parquet or click</div>
                    </div>
                    <input type="file" id="file-input" accept=".parquet,.csv,.xlsx" onchange="onFile(this)">
                    <div id="file-info" class="file-info" style="display:none"></div>
                </div>
            </div>

            <!-- Config File -->
            <div class="sidebar-section">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñº</span> Config File</span>
                </div>
                <div class="section-content">
                    <div class="upload-zone" id="config-dropzone" onclick="$('config-file-input').click()">
                        <div class="upload-icon">‚öôÔ∏è</div>
                        <div class="upload-text">Drop JSON/YAML or click</div>
                    </div>
                    <div id="config-file-info" class="file-info" style="display:none"></div>
                </div>
            </div>

            <!-- Inspection Results -->
            <div class="sidebar-section" id="inspection-section" style="display: none;">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñº</span> Detected Structure</span>
                    <span id="inspection-level" style="font-size: 0.65rem; padding: 0.1rem 0.3rem; background: var(--accent); color: var(--bg); border-radius: 3px;">‚Äî</span>
                </div>
                <div class="section-content">
                    <a href="#" onclick="toggleConstants(); return false;" id="constants-toggle" style="font-size: 0.65rem; color: var(--accent); text-decoration: none; display: block; margin-bottom: 0.4rem;">+ Add Constants</a>
                    <div id="constants-panel" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem; background: var(--input); border-radius: 4px;">
                        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 0.3rem; font-size: 0.7rem;">
                            <label style="color: var(--dim); align-self: center;">Density (kg/m¬≥)</label>
                            <input type="number" id="const-density" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Viscosity (Pa¬∑s)</label>
                            <input type="number" id="const-viscosity" placeholder="‚Äî" step="0.0001" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Diameter (m)</label>
                            <input type="number" id="const-diameter" placeholder="‚Äî" step="0.001" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Pipe Length (m)</label>
                            <input type="number" id="const-length" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Temperature (K)</label>
                            <input type="number" id="const-temperature" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">

                            <label style="color: var(--dim); align-self: center;">Pressure (Pa)</label>
                            <input type="number" id="const-pressure" placeholder="‚Äî" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.25rem; border-radius: 3px; font: inherit; font-size: 0.7rem;">
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.6rem; color: var(--dim);">
                            Constants unlock physics engines (Reynolds, pressure drop, etc.)
                        </div>
                    </div>
                    <div id="inspection-content" style="font-size: 0.7rem;">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- Load External Results -->
            <div class="sidebar-section">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñ∂</span> Load Results</span>
                </div>
                <div class="section-content" style="display: none;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--dim);">Results Directory Path</label>
                        <input type="text" id="results-path-input" placeholder="/Users/.../prism-inbox" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <button class="btn" onclick="loadExternalResults()" style="width: 100%;">Load Parquets</button>
                        <div id="load-results-status" style="font-size: 0.7rem; color: var(--dim);"></div>
                    </div>
                </div>
            </div>

            <!-- Download Results -->
            <div class="sidebar-section" id="download-section" style="display: none;">
                <button class="btn" onclick="downloadResults()" style="width: 100%;">Download Results (.zip)</button>
            </div>

            <!-- PRISM Analysis -->
            <div class="sidebar-section">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñº</span> PRISM Analysis</span>
                </div>
                <div class="section-content">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--dim);">Discipline</label>
                        <select id="discipline-select" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                            <option value="core" selected>Core Analysis</option>
                            <option value="thermodynamics">Thermodynamics</option>
                            <option value="transport">Transport Phenomena</option>
                            <option value="reaction">Reaction Engineering</option>
                            <option value="process_control">Process Control</option>
                            <option value="mechanical">Mechanical Systems</option>
                            <option value="electrical">Electrical Systems</option>
                            <option value="fluid_dynamics">Fluid Dynamics</option>
                        </select>
                        <label style="font-size: 0.7rem; color: var(--dim);">Window Size</label>
                        <input type="number" id="window-size" value="50" min="5" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <label style="font-size: 0.7rem; color: var(--dim);">Window Stride</label>
                        <input type="number" id="window-stride" value="25" min="1" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" id="analyze-btn" onclick="analyzeWithPRISM()" disabled>Analyze with PRISM</button>
                    </div>
                    <div id="prism-progress" style="display: none; margin-top: 0.5rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span id="prism-progress-text">Sending to PRISM...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capabilities -->
            <div class="sidebar-section">
                <div class="section-title collapsible" onclick="toggleSection(this)">
                    <span><span class="toggle-icon">‚ñº</span> Capabilities</span>
                    <span id="cap-count">‚Äî</span>
                </div>
                <div class="section-content">
                    <div class="cap-list" id="caps"></div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Data View -->
            <div class="view active" id="view-data">
                <div class="toolbar">
                    <span style="color: var(--dim)">Table:</span>
                    <select id="table-select" onchange="loadTable(this.value)" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.75rem;">
                        <option value="">‚Äî Select ‚Äî</option>
                    </select>
                    <button class="btn btn-sm" onclick="refreshTable()">Refresh</button>
                    <div class="toolbar-info" id="row-count"></div>
                </div>
                <div class="table-wrapper" id="table-wrapper">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Load a parquet file to view data</div>
                    </div>
                </div>
            </div>

            <!-- Config View -->
            <div class="view" id="view-config">
                <div class="config-editor-container">
                    <textarea id="config-editor" spellcheck="false"></textarea>
                    <div class="config-actions">
                        <label class="btn" style="cursor: pointer;">
                            Load File
                            <input type="file" id="config-file-input" accept=".json,.yaml,.yml">
                        </label>
                        <button class="btn btn-save" id="config-save">Save</button>
                        <button class="btn" id="config-reset">Reset to Example</button>
                    </div>
                    <div id="config-validation" class="validation-message"></div>
                </div>
            </div>

            <!-- Schema View -->
            <div class="view" id="view-schema">
                <div class="toolbar">
                    <span style="color: var(--dim)">Schema for loaded table</span>
                </div>
                <div id="schema-list" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Load a file to view schema</div>
                    </div>
                </div>
            </div>

            <!-- Query View -->
            <div class="view" id="view-query">
                <div class="query-area">
                    <div style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--dim); margin-right: 0.5rem;">Preset Queries:</label>
                        <select id="query-select" onchange="loadPresetQuery(this.value)" style="background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px; font: inherit; font-size: 0.7rem; min-width: 200px;">
                            <option value="">-- Custom SQL --</option>
                        </select>
                    </div>
                    <textarea id="query-input" class="query-input" placeholder="SELECT * FROM data LIMIT 100"></textarea>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="runQuery()">Run Query</button>
                        <button class="btn" onclick="$('query-input').value = 'SELECT * FROM data LIMIT 100'; $('query-select').value = '';">Reset</button>
                    </div>
                </div>
                <div class="table-wrapper" id="query-results">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <div class="empty-state-text">Run a SQL query</div>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div class="view" id="view-stats">
                <div id="stats-container" style="overflow: auto; flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div class="empty-state-text">Load data to view statistics</div>
                    </div>
                </div>
            </div>

            <!-- README View -->
            <div class="view" id="view-readme">
                <div id="readme-container" style="overflow: auto; flex: 1; padding: 1rem;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <div class="empty-state-text">Loading README...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="status">
        <div class="st">
            <div class="st-dot" id="prism-dot"></div>
            <span class="st-label">PRISM:</span>
            <span id="prism-st">Checking...</span>
        </div>
        <div class="st">
            <div class="st-dot" id="cfg-dot"></div>
            <span class="st-label">Config:</span>
            <span id="cfg-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="data-dot"></div>
            <span class="st-label">Data:</span>
            <span id="data-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="db-dot"></div>
            <span class="st-label">DuckDB:</span>
            <span id="db-st">Loading...</span>
        </div>
        <div class="level-bar">
            <span class="st-label">Level:</span>
            <div class="level-seg" id="l0"></div>
            <div class="level-seg" id="l1"></div>
            <div class="level-seg" id="l2"></div>
            <div class="level-seg" id="l3"></div>
            <div class="level-seg" id="l4"></div>
            <span class="level-name" id="lvl-name">‚Äî</span>
        </div>
    </div>

    <!-- Pre-flight Modal -->
    <div class="modal-overlay" id="preflight-modal">
        <div class="modal">
            <div class="modal-title">Pre-flight Check</div>
            <div id="preflight-results"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closePreflightModal()">Cancel</button>
                <button class="btn" id="preflight-fix-btn" onclick="closePreflightModal(); showView('config');" style="display:none;">Fix Config</button>
                <button class="btn btn-primary" id="preflight-submit-btn" onclick="submitToPRISM()">Submit</button>
            </div>
        </div>
    </div>

<script src="/static/orthon-queries.js"></script>
<script type="module">
import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

const $ = id => document.getElementById(id);
window.$ = $;

// XSS prevention - escape HTML in user content
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// =====================================================================
// DUCKDB SETUP
// =====================================================================

let db = null;
let conn = null;

async function initDuckDB() {
    try {
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        const worker_url = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
        );

        const worker = new Worker(worker_url);
        const logger = new duckdb.ConsoleLogger();
        db = new duckdb.AsyncDuckDB(logger, worker);

        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        conn = await db.connect();

        setSt('db', 'Ready', 'ok');

        URL.revokeObjectURL(worker_url);
    } catch (e) {
        console.error('DuckDB init failed:', e);
        setSt('db', 'Error', 'err');
    }
}

// =====================================================================
// FILE HANDLING
// =====================================================================

let currentFile = null;
let currentTable = 'data';

window.onFile = async function(input) {
    const file = input.files[0];
    if (!file || !conn) return;

    currentFile = file;

    $('dropzone').classList.add('has-file');
    $('file-info').style.display = 'flex';
    $('file-info').innerHTML = `<span class="name">${escapeHtml(file.name)}</span><span class="size">${(file.size/1024).toFixed(1)} KB</span>`;
    setSt('data', file.name, 'ok');

    // Load into DuckDB
    try {
        const buffer = await file.arrayBuffer();
        await db.registerFileBuffer(file.name, new Uint8Array(buffer));

        if (file.name.endsWith('.parquet')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_parquet('${file.name}')`);
        } else if (file.name.endsWith('.csv')) {
            await conn.query(`CREATE OR REPLACE TABLE data AS SELECT * FROM read_csv_auto('${file.name}')`);
        }

        // Update table select
        $('table-select').innerHTML = '<option value="data">data</option>';
        $('table-select').value = 'data';

        await loadTable('data');
        await loadSchema();
        await loadStats();

        // Enable analyze button
        updateAnalyzeButton();

        // Inspect file for capabilities
        await inspectFile(file);

    } catch (e) {
        console.error('File load error:', e);
        setSt('data', 'Error: ' + e.message, 'err');
    }
};

async function loadTable(tableName) {
    if (!conn || !tableName) return;

    currentTable = tableName;

    try {
        const result = await conn.query(`SELECT * FROM ${tableName} LIMIT 1000`);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('table-wrapper', columns, rows);
        $('row-count').textContent = `${rows.length} rows (limited)`;

    } catch (e) {
        console.error('Query error:', e);
        $('table-wrapper').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${escapeHtml(e.message)}</div></div>`;
    }
}
window.loadTable = loadTable;

async function loadSchema() {
    if (!conn) return;

    try {
        const result = await conn.query(`DESCRIBE ${currentTable}`);
        const rows = result.toArray();

        let html = '';
        for (const row of rows) {
            html += `
                <div class="schema-item">
                    <span class="schema-name">${escapeHtml(row.column_name)}</span>
                    <span class="schema-type">${escapeHtml(row.column_type)}</span>
                </div>
            `;
        }

        $('schema-list').innerHTML = html || '<div class="empty-state"><div class="empty-state-text">No columns</div></div>';

    } catch (e) {
        console.error('Schema error:', e);
    }
}

async function loadStats() {
    if (!conn) return;

    try {
        // Get row count
        const countResult = await conn.query(`SELECT COUNT(*) as cnt FROM ${currentTable}`);
        const rowCount = countResult.toArray()[0].cnt;

        // Get column stats
        const descResult = await conn.query(`DESCRIBE ${currentTable}`);
        const columns = descResult.toArray();

        let html = '<div class="stats-grid">';

        html += `
            <div class="stat-card">
                <div class="stat-label">Total Rows</div>
                <div class="stat-value">${Number(rowCount).toLocaleString()}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Columns</div>
                <div class="stat-value">${columns.length}</div>
            </div>
        `;

        // Index column info from inspection
        if (lastInspection) {
            const indexCol = lastInspection.sequence_column;
            const indexSignal = lastInspection.signals?.find(s => s.name === indexCol);
            const indexUnit = indexSignal?.unit || 'none';
            const indexQty = indexSignal?.quantity || 'sequence';

            html += `
                <div class="stat-card" style="border-left: 3px solid var(--accent);">
                    <div class="stat-label">Index Column</div>
                    <div class="stat-value">${escapeHtml(indexCol || 'auto')}</div>
                    <div class="stat-sub">Unit: ${escapeHtml(indexUnit)} (${escapeHtml(indexQty)})</div>
                </div>
            `;

            // Entity info
            if (lastInspection.entity_column) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Entity Column</div>
                        <div class="stat-value">${escapeHtml(lastInspection.entity_column)}</div>
                        <div class="stat-sub">${lastInspection.entities?.length || 1} entities</div>
                    </div>
                `;
            }

            // Quantities detected
            if (lastInspection.quantities_detected?.length > 0) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Quantities Detected</div>
                        <div class="stat-value">${lastInspection.quantities_detected.length}</div>
                        <div class="stat-sub">${escapeHtml(lastInspection.quantities_detected.slice(0, 3).join(', '))}${lastInspection.quantities_detected.length > 3 ? '...' : ''}</div>
                    </div>
                `;
            }

            // Constants
            const constCount = Object.keys(lastInspection.constants || {}).length;
            if (constCount > 0) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">Constants</div>
                        <div class="stat-value">${constCount}</div>
                        <div class="stat-sub">${escapeHtml(Object.keys(lastInspection.constants).slice(0, 3).join(', '))}</div>
                    </div>
                `;
            }
        }

        // Get numeric column stats
        const numericCols = columns.filter(c =>
            c.column_type.includes('INT') ||
            c.column_type.includes('FLOAT') ||
            c.column_type.includes('DOUBLE') ||
            c.column_type.includes('DECIMAL')
        );

        for (const col of numericCols.slice(0, 8)) {
            try {
                const statsResult = await conn.query(`
                    SELECT
                        MIN("${col.column_name}") as min_val,
                        MAX("${col.column_name}") as max_val,
                        AVG("${col.column_name}") as avg_val,
                        COUNT(*) - COUNT("${col.column_name}") as null_count
                    FROM ${currentTable}
                `);
                const stats = statsResult.toArray()[0];

                html += `
                    <div class="stat-card">
                        <div class="stat-label">${escapeHtml(col.column_name)}</div>
                        <div class="stat-value">${formatNum(stats.avg_val)}</div>
                        <div class="stat-sub">${formatNum(stats.min_val)} ‚Üí ${formatNum(stats.max_val)}</div>
                    </div>
                `;
            } catch (e) {
                // Skip problematic columns
            }
        }

        html += '</div>';
        $('stats-container').innerHTML = html;

    } catch (e) {
        console.error('Stats error:', e);
    }
}

function formatNum(n) {
    if (n === null || n === undefined) return '‚Äî';
    if (typeof n === 'bigint') n = Number(n);
    if (Math.abs(n) > 1000000) return n.toExponential(2);
    if (Math.abs(n) < 0.01 && n !== 0) return n.toExponential(2);
    return Number(n).toLocaleString(undefined, { maximumFractionDigits: 4 });
}

window.runQuery = async function() {
    if (!conn) return;

    const query = $('query-input').value;

    try {
        const result = await conn.query(query);
        const columns = result.schema.fields.map(f => f.name);
        const rows = result.toArray();

        renderTable('query-results', columns, rows);

    } catch (e) {
        $('query-results').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error: ${escapeHtml(e.message)}</div></div>`;
    }
};

window.refreshTable = () => loadTable(currentTable);

function renderTable(containerId, columns, rows) {
    let html = '<table><thead><tr>';

    for (const col of columns) {
        html += `<th>${escapeHtml(col)}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
            const val = row[col];
            let cellClass = '';
            let display = '';

            if (val === null || val === undefined) {
                cellClass = 'null';
                display = 'NULL';
            } else if (typeof val === 'number' || typeof val === 'bigint') {
                cellClass = 'num';
                display = formatNum(val);
            } else {
                cellClass = 'str';
                display = escapeHtml(String(val).slice(0, 100));
            }

            html += `<td class="${cellClass}">${display}</td>`;
        }
        html += '</tr>';
    }

    html += '</tbody></table>';
    $(containerId).innerHTML = html;
}

// =====================================================================
// VIEW NAVIGATION
// =====================================================================

let readmeLoaded = false;

window.showView = function(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

    $('view-' + view).classList.add('active');
    event.target.classList.add('active');

    // Load README on first view
    if (view === 'readme' && !readmeLoaded) {
        loadReadme();
    }
};

// =====================================================================
// README
// =====================================================================

async function loadReadme() {
    const container = $('readme-container');

    try {
        // Try fetching from GitHub raw URL first (for repo README)
        const urls = [
            '/static/README.md',
            '/README.md',
            'https://raw.githubusercontent.com/prism-engines/orthon/main/README.md',
        ];

        let content = null;
        for (const url of urls) {
            try {
                const r = await fetch(url);
                if (r.ok) {
                    content = await r.text();
                    break;
                }
            } catch (e) {
                continue;
            }
        }

        if (!content) {
            // Fallback content
            content = `# ORTHON

Diagnostic interpreter for PRISM outputs.

## Overview

ORTHON is the intelligent orchestration layer for PRISM compute engines.

### Key Features

- **File Inspection**: Automatically detect units, constants, and signal types
- **Pre-flight Validation**: Verify data before sending to PRISM
- **SQL Queries**: Run DuckDB queries against results
- **Physics Routing**: Route to appropriate engines based on detected quantities

## Usage

1. Upload a data file (CSV, Parquet, or Excel)
2. Review detected structure and constants
3. Configure window parameters
4. Click "Analyze with PRISM"
5. Explore results with SQL queries

## Architecture

\`\`\`
User ‚Üí ORTHON (gatekeeper) ‚Üí PRISM (compute) ‚Üí ORTHON (results)
\`\`\`

PRISM stays dumb, ORTHON does the thinking.
`;
        }

        // Simple markdown rendering
        const html = renderMarkdown(content);
        container.innerHTML = `<div class="readme-content">${html}</div>`;
        readmeLoaded = true;

    } catch (e) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--red)">Error loading README: ${escapeHtml(e.message)}</div></div>`;
    }
}

function renderMarkdown(md) {
    // Simple markdown to HTML converter
    let html = escapeHtml(md);

    // Code blocks (``` ... ```)
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Headers
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

    // Bold and italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

    // Unordered lists
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

    // Blockquotes
    html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

    // Paragraphs (double newlines)
    html = html.replace(/\n\n+/g, '</p><p>');
    html = '<p>' + html + '</p>';

    // Clean up empty paragraphs and fix structure
    html = html.replace(/<p>\s*<(h[123]|ul|pre|blockquote)/g, '<$1');
    html = html.replace(/<\/(h[123]|ul|pre|blockquote)>\s*<\/p>/g, '</$1>');
    html = html.replace(/<p>\s*<\/p>/g, '');

    return html;
}

// =====================================================================
// CAPABILITIES
// =====================================================================

const CAPS = {
    STATISTICS:        { l: 0, n: 'Statistics', r: [] },
    ENTROPY:           { l: 0, n: 'Entropy', r: [] },
    MEMORY:            { l: 0, n: 'Memory', r: [] },
    SPECTRAL:          { l: 0, n: 'Spectral', r: [] },
    RECURRENCE:        { l: 0, n: 'Recurrence', r: [] },
    CHAOS:             { l: 0, n: 'Lyapunov', r: [] },
    GEOMETRY:          { l: 0, n: 'Geometry', r: [] },
    DYNAMICS:          { l: 0, n: 'Dynamics', r: [] },

    DERIVATIVES:       { l: 1, n: 'Derivatives', r: ['labeled'] },
    SPECIFIC_KE:       { l: 1, n: 'Specific KE', r: ['velocity'] },

    KINETIC_ENERGY:    { l: 2, n: 'Kinetic Energy', r: ['velocity', 'mass'] },
    POTENTIAL_ENERGY:  { l: 2, n: 'Potential Energy', r: ['position', 'spring_constant'] },
    HAMILTONIAN:       { l: 2, n: 'Hamiltonian', r: ['position', 'velocity', 'mass', 'spring_constant'] },
    LAGRANGIAN:        { l: 2, n: 'Lagrangian', r: ['position', 'velocity', 'mass', 'spring_constant'] },
    MOMENTUM:          { l: 2, n: 'Momentum', r: ['velocity', 'mass'] },

    GIBBS:             { l: 3, n: 'Gibbs Energy', r: ['temperature', 'pressure', 'volume', 'Cp'] },
    TRANSFER_FN:       { l: 3, n: 'Transfer Fn', r: ['input', 'output'] },

    VORTICITY:         { l: 4, n: 'Vorticity', r: ['velocity_field'] },
    TKE:               { l: 4, n: 'Turbulent KE', r: ['velocity_field'] },
    ENERGY_SPECTRUM:   { l: 4, n: 'E(k)', r: ['velocity_field'] },
};

const LEVELS = ['Raw Series', 'Labeled', 'Constants', 'Related', 'Spatial'];

function detectFromConfig(cfg) {
    // Detect capabilities from JSON config
    const has = new Set();

    // Check signals
    const signals = cfg.signals || [];
    if (signals.length >= 2) has.add('multi');
    for (const s of signals) {
        if (s.type) has.add('labeled');
        if (s.physical_quantity) has.add(s.physical_quantity);
    }

    // Check engines/layers for domain capabilities
    const layers = cfg.layers || {};
    const engines = cfg.engines || {};

    // Check for constants from user input panel
    const userConstants = getUserConstants();
    for (const k of Object.keys(userConstants)) {
        // Map constant names to capability requirements
        if (k.includes('density')) has.add('density');
        if (k.includes('viscosity')) has.add('viscosity');
        if (k.includes('temperature')) has.add('temperature');
        if (k.includes('pressure')) has.add('pressure');
    }

    const ok = [], no = {};
    for (const [k, cap] of Object.entries(CAPS)) {
        const miss = cap.r.filter(r => !has.has(r));
        if (miss.length === 0) ok.push(k);
        else no[k] = miss;
    }

    let lvl = 0;
    if (has.has('velocity_field')) lvl = 4;
    else if (has.has('temperature') || has.has('input')) lvl = 3;
    else if (has.has('mass') || has.has('spring_constant')) lvl = 2;
    else if (has.has('labeled')) lvl = 1;

    return { ok, no, lvl };
}

function renderCaps(res) {
    const el = $('caps');
    el.innerHTML = '';

    const all = Object.entries(CAPS).sort((a,b) => {
        const aOk = res.ok.includes(a[0]) ? 0 : 1;
        const bOk = res.ok.includes(b[0]) ? 0 : 1;
        return aOk - bOk || a[1].l - b[1].l;
    });

    for (const [k, cap] of all) {
        const isOk = res.ok.includes(k);
        const div = document.createElement('div');
        div.className = `cap ${isOk ? 'ok' : 'no'}`;
        div.innerHTML = `
            <span style="width:14px">${isOk ? '‚úì' : '‚óã'}</span>
            <span class="cap-name">${cap.n}</span>
            <span class="lvl lvl-${cap.l}">L${cap.l}</span>
        `;
        if (!isOk) div.title = 'Need: ' + res.no[k].join(', ');
        el.appendChild(div);
    }

    $('cap-count').textContent = `${res.ok.length}/${Object.keys(CAPS).length}`;
}

function setLevel(lvl) {
    for (let i = 0; i <= 4; i++) {
        $('l' + i).className = 'level-seg' + (i <= lvl ? ' on' : '');
    }
    $('lvl-name').textContent = LEVELS[lvl];
}

function setSt(id, txt, state) {
    $(id + '-dot').className = 'st-dot' + (state ? ' ' + state : '');
    $(id + '-st').textContent = txt;
}
window.setSt = setSt;

window.checkCapabilities = function() {
    // Check capabilities from config tab
    const cfg = getConfig();
    if (!cfg) {
        renderCaps({ ok: [], no: {}, lvl: 0 });
        setLevel(0);
        return;
    }

    try {
        const res = detectFromConfig(cfg);
        renderCaps(res);
        setLevel(res.lvl);
    } catch (e) {
        console.error('Capability detection error:', e);
    }
};

// Drag and drop - Data
const dz = $('dropzone');
dz.ondragover = e => { e.preventDefault(); dz.classList.add('dragover'); };
dz.ondragleave = () => dz.classList.remove('dragover');
dz.ondrop = e => {
    e.preventDefault();
    dz.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
        $('file-input').files = e.dataTransfer.files;
        onFile($('file-input'));
    }
};

// Drag and drop - Config
const cdz = $('config-dropzone');
cdz.ondragover = e => { e.preventDefault(); cdz.classList.add('dragover'); };
cdz.ondragleave = () => cdz.classList.remove('dragover');
cdz.ondrop = e => {
    e.preventDefault();
    cdz.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
        cdz.classList.add('has-file');
        loadConfigFile(file);
    }
};

function loadConfigFile(file) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const content = event.target.result;
        let config;

        try {
            if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) {
                config = parseSimpleYAML(content);
            } else {
                config = JSON.parse(content);
            }

            const editor = $('config-editor');
            editor.value = JSON.stringify(config, null, 2);
            validateConfigEditor(editor.value);
            checkCapabilities();

            // Show file info and green border
            const cdz = $('config-dropzone');
            if (cdz) cdz.classList.add('has-file');
            $('config-file-info').style.display = 'flex';
            $('config-file-info').innerHTML = `<span class="name">${escapeHtml(file.name)}</span><span class="size">${(file.size/1024).toFixed(1)} KB</span>`;

            showConfigValidation('Loaded: ' + file.name, 'valid');

        } catch (err) {
            showConfigValidation('Parse error: ' + err.message, 'invalid');
        }
    };

    reader.readAsText(file);
}

// =====================================================================
// FILE INSPECTION
// =====================================================================

let lastInspection = null;
let lastCapabilities = null;

async function inspectFile(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);

        const r = await fetch('/api/inspect', {
            method: 'POST',
            body: formData,
        });

        if (!r.ok) {
            console.warn('Inspection failed');
            return;
        }

        const data = await r.json();
        lastInspection = data.inspection;
        lastCapabilities = data.capabilities;

        // Show inspection section
        $('inspection-section').style.display = 'block';
        $('inspection-level').textContent = `L${lastCapabilities.level}`;
        $('inspection-level').style.background = ['var(--dim)', 'var(--green)', 'var(--accent)', 'var(--purple)', 'var(--yellow)'][lastCapabilities.level] || 'var(--dim)';

        // Build inspection content
        let html = '';

        // Entities
        html += `<div style="margin-bottom: 0.5rem;">`;
        html += `<span style="color: var(--dim);">Entities:</span> `;
        html += `<span style="color: var(--green);">${lastInspection.entities?.length || 0}</span>`;
        if (lastInspection.entities?.length <= 5) {
            html += ` <span style="color: var(--dim);">(${lastInspection.entities?.map(e => escapeHtml(e)).join(', ')})</span>`;
        }
        html += `</div>`;

        // Signals
        const signals = lastInspection.signals?.filter(s => !s.is_entity_id && !s.is_sequence && !s.is_constant) || [];
        html += `<div style="margin-bottom: 0.5rem;">`;
        html += `<span style="color: var(--dim);">Signals:</span> `;
        html += `<span style="color: var(--accent);">${signals.length}</span>`;
        html += `</div>`;

        // Show all signals
        if (signals.length > 0) {
            html += `<div style="margin-bottom: 0.5rem; padding-left: 0.5rem; border-left: 2px solid var(--border);">`;
            for (const sig of signals.slice(0, 6)) {
                html += `<div><span style="color: var(--text);">${escapeHtml(sig.name)}</span>`;
                if (sig.unit) html += ` <span style="color: var(--purple);">[${escapeHtml(sig.unit)}]</span>`;
                html += `</div>`;
            }
            if (signals.length > 6) {
                html += `<div id="signals-more" style="display: none;">`;
                for (const sig of signals.slice(6)) {
                    html += `<div><span style="color: var(--text);">${escapeHtml(sig.name)}</span>`;
                    if (sig.unit) html += ` <span style="color: var(--purple);">[${escapeHtml(sig.unit)}]</span>`;
                    html += `</div>`;
                }
                html += `</div>`;
                html += `<a href="#" id="signals-toggle" onclick="toggleSignals(); return false;" style="color: var(--accent); text-decoration: none; font-size: 0.7rem;">...and ${signals.length - 6} more</a>`;
            }
            html += `</div>`;
        }

        // Constants
        const constants = Object.keys(lastInspection.constants || {});
        if (constants.length > 0) {
            html += `<div style="margin-bottom: 0.5rem;">`;
            html += `<span style="color: var(--dim);">Constants:</span> `;
            html += `<span style="color: var(--yellow);">${constants.length}</span>`;
            html += ` <span style="color: var(--dim);">(${constants.slice(0, 3).map(c => escapeHtml(c)).join(', ')}${constants.length > 3 ? '...' : ''})</span>`;
            html += `</div>`;
        }

        // Available engines
        html += `<div style="margin-bottom: 0.5rem;">`;
        html += `<span style="color: var(--dim);">Engines:</span> `;
        html += `<span style="color: var(--green);">${lastCapabilities.available_engines?.length || 0}</span>`;
        html += `</div>`;

        // Warnings
        if (lastInspection.warnings?.length > 0) {
            html += `<div style="margin-top: 0.5rem; padding: 0.3rem 0.5rem; background: rgba(210, 153, 34, 0.1); border-radius: 3px;">`;
            for (const warn of lastInspection.warnings) {
                html += `<div style="color: var(--yellow); font-size: 0.65rem;">‚ö† ${escapeHtml(warn)}</div>`;
            }
            html += `</div>`;
        }

        // Missing for next level
        if (lastCapabilities.missing_for_next_level?.length > 0) {
            html += `<div style="margin-top: 0.5rem; padding: 0.3rem 0.5rem; background: rgba(88, 166, 255, 0.1); border-radius: 3px;">`;
            html += `<div style="color: var(--accent); font-size: 0.65rem;">To unlock more:</div>`;
            for (const tip of lastCapabilities.missing_for_next_level) {
                html += `<div style="color: var(--dim); font-size: 0.65rem;">‚Ä¢ ${escapeHtml(tip)}</div>`;
            }
            html += `</div>`;
        }

        $('inspection-content').innerHTML = html;

    } catch (e) {
        console.warn('Inspection error:', e);
    }
}

// =====================================================================
// RESULTS VALIDATION
// =====================================================================

async function validateResults() {
    try {
        const r = await fetch('/api/validate-results', { method: 'POST' });
        if (!r.ok) return null;
        return await r.json();
    } catch (e) {
        console.warn('Validation error:', e);
        return null;
    }
}

function showValidationWarnings(validation) {
    if (!validation) return;

    let messages = [];

    if (validation.files_corrupted?.length > 0) {
        messages.push(`‚ùå Corrupted: ${validation.files_corrupted.join(', ')}`);
    }
    if (validation.files_empty?.length > 0) {
        messages.push(`‚ö†Ô∏è Empty: ${validation.files_empty.join(', ')}`);
    }

    if (messages.length > 0) {
        alert('Results Validation:\n\n' + messages.join('\n') + '\n\n' + validation.summary);
    }
}

// =====================================================================
// PRISM CONNECTIVITY
// =====================================================================

let prismAvailable = false;

async function checkPRISM() {
    try {
        const r = await fetch('/api/prism/health');
        const data = await r.json();
        prismAvailable = data.available;

        if (prismAvailable) {
            setSt('prism', 'Ready', 'ok');
            updateAnalyzeButton();
        } else {
            setSt('prism', 'Offline', 'warn');
        }
    } catch (e) {
        // If API not available, try direct PRISM connection
        try {
            const r = await fetch('http://localhost:8100/health');
            const data = await r.json();
            prismAvailable = data.status === 'ok';

            if (prismAvailable) {
                setSt('prism', 'Direct', 'ok');
                updateAnalyzeButton();
            }
        } catch (e2) {
            setSt('prism', 'Unavailable', 'err');
        }
    }
}

function updateAnalyzeButton() {
    const btn = $('analyze-btn');
    btn.disabled = !(prismAvailable && currentFile);
}

// =====================================================================
// PRE-FLIGHT VALIDATION
// =====================================================================

window.analyzeWithPRISM = async function() {
    if (!currentFile || !prismAvailable || !conn) return;

    // Run pre-flight checks
    const checks = await runPreflightChecks();
    showPreflightModal(checks);
};

async function runPreflightChecks() {
    const windowSize = parseInt($('window-size').value) || 50;
    const windowStride = parseInt($('window-stride').value) || 25;
    const minObservations = windowSize; // Need at least one full window

    const checks = [];

    try {
        // 1. Row count check
        const countResult = await conn.query(`SELECT COUNT(*) as cnt FROM data`);
        const rowCount = Number(countResult.toArray()[0].cnt);

        checks.push({
            name: 'Row count',
            status: rowCount >= minObservations ? 'ok' : 'err',
            detail: `${rowCount.toLocaleString()} rows (min: ${minObservations})`,
            message: rowCount < minObservations ? `Need at least ${minObservations} rows for window size ${windowSize}` : null
        });

        // 2. Window size vs data span
        // Try to find a numeric column that could be an index
        const descResult = await conn.query(`DESCRIBE data`);
        const columns = descResult.toArray();
        const numericCols = columns.filter(c =>
            c.column_type.includes('INT') ||
            c.column_type.includes('FLOAT') ||
            c.column_type.includes('DOUBLE')
        );

        if (numericCols.length > 0) {
            // Use first numeric column as proxy for data span
            const firstCol = numericCols[0].column_name;
            const spanResult = await conn.query(`SELECT MAX("${firstCol}") - MIN("${firstCol}") as span FROM data`);
            const dataSpan = Number(spanResult.toArray()[0].span);

            if (dataSpan > 0) {
                const windowsEstimate = Math.floor((dataSpan - windowSize) / windowStride) + 1;
                checks.push({
                    name: 'Window coverage',
                    status: windowSize <= dataSpan ? 'ok' : 'err',
                    detail: `~${Math.max(0, windowsEstimate)} windows (span: ${dataSpan.toFixed(1)}, size: ${windowSize})`,
                    message: windowSize > dataSpan ? `Window size (${windowSize}) > data span (${dataSpan.toFixed(1)})` : null
                });
            }
        }

        // 3. Stride vs size check
        if (windowStride > windowSize) {
            checks.push({
                name: 'Window stride',
                status: 'warn',
                detail: `Stride ${windowStride} > size ${windowSize}`,
                message: 'Stride larger than window size creates gaps in coverage'
            });
        } else {
            const overlap = ((windowSize - windowStride) / windowSize * 100).toFixed(0);
            checks.push({
                name: 'Window stride',
                status: 'ok',
                detail: `${overlap}% overlap (stride: ${windowStride}, size: ${windowSize})`
            });
        }

        // 4. Signal columns check
        const signalCols = numericCols.filter(c => {
            const name = c.column_name.toLowerCase();
            // Exclude likely index/id columns
            return !name.includes('id') && !name.includes('index') &&
                   !name.includes('time') && !name.includes('cycle') &&
                   name !== 't' && name !== 'ts';
        });

        checks.push({
            name: 'Signal columns',
            status: signalCols.length > 0 ? 'ok' : 'warn',
            detail: `${signalCols.length} numeric signal columns detected`,
            message: signalCols.length === 0 ? 'No signal columns detected - check data format' : null
        });

        // 5. Null value check (sample first few columns)
        for (const col of signalCols.slice(0, 3)) {
            const nullResult = await conn.query(`
                SELECT
                    COUNT(*) as total,
                    SUM(CASE WHEN "${col.column_name}" IS NULL THEN 1 ELSE 0 END) as nulls
                FROM data
            `);
            const { total, nulls } = nullResult.toArray()[0];
            const nullPct = (Number(nulls) / Number(total) * 100);

            if (nullPct > 10) {
                checks.push({
                    name: `Nulls in ${col.column_name}`,
                    status: nullPct > 50 ? 'err' : 'warn',
                    detail: `${nullPct.toFixed(1)}% null values`,
                    message: `High null rate may affect analysis quality`
                });
            }
        }

        // 6. Unit detection from inspection
        if (lastInspection?.signals) {
            const dataSignals = lastInspection.signals.filter(s => !s.is_entity_id && !s.is_sequence);
            const withUnits = dataSignals.filter(s => s.unit);
            const withoutUnits = dataSignals.filter(s => !s.unit);

            if (withUnits.length > 0) {
                checks.push({
                    name: 'Units detected',
                    status: 'ok',
                    detail: `${withUnits.length} signals with units (${withUnits.slice(0, 3).map(s => s.unit).join(', ')}${withUnits.length > 3 ? '...' : ''})`
                });
            }

            // Warn about signals missing units (but not if units are in separate column)
            if (withoutUnits.length > 0 && lastInspection.units_detected === 0) {
                checks.push({
                    name: 'Missing units',
                    status: 'warn',
                    detail: `${withoutUnits.length} signal(s) without units`,
                    message: 'Unit metadata helps with signal classification'
                });
            } else if (withoutUnits.length > 0 && lastInspection.units_detected > 0) {
                // Units detected in separate column - just informational
                checks.push({
                    name: 'Unit column',
                    status: 'ok',
                    detail: `${lastInspection.units_detected} unique units in dedicated column`
                });
            }
        }

        // 7. Check for missing metadata that could be warnings
        if (lastInspection?.signals) {
            const dataSignals = lastInspection.signals.filter(s => !s.is_entity_id && !s.is_sequence);
            const missingQuantity = dataSignals.filter(s => !s.quantity && !s.unit);

            if (missingQuantity.length > 0 && lastInspection.units_detected === 0) {
                checks.push({
                    name: 'Signal metadata',
                    status: 'warn',
                    detail: `${missingQuantity.length} signal(s) missing quantity/unit info`,
                    message: 'Consider adding units to column names (e.g., pressure_PSI)'
                });
            }
        }

        // 8. Entity/sequence column detection
        if (lastInspection) {
            if (!lastInspection.entity_column && !lastInspection.sequence_column) {
                checks.push({
                    name: 'Data structure',
                    status: 'warn',
                    detail: 'No entity or sequence column detected',
                    message: 'Data may be treated as single time series'
                });
            } else {
                const parts = [];
                if (lastInspection.entity_column) parts.push(`entity: ${lastInspection.entity_column}`);
                if (lastInspection.sequence_column) parts.push(`sequence: ${lastInspection.sequence_column}`);
                checks.push({
                    name: 'Data structure',
                    status: 'ok',
                    detail: parts.join(', ')
                });
            }
        }

    } catch (e) {
        checks.push({
            name: 'Validation error',
            status: 'warn',
            detail: e.message,
            message: 'Could not complete all pre-flight checks'
        });
    }

    return checks;
}

function showPreflightModal(checks) {
    const modal = $('preflight-modal');
    const results = $('preflight-results');
    const submitBtn = $('preflight-submit-btn');
    const fixBtn = $('preflight-fix-btn');

    // Render checks
    let html = '';
    let hasErrors = false;
    let hasWarnings = false;

    for (const check of checks) {
        const icon = check.status === 'ok' ? '‚úì' : check.status === 'warn' ? '‚ö†' : '‚úó';
        const iconClass = check.status === 'ok' ? 'ok' : check.status === 'warn' ? 'warn' : 'err';

        if (check.status === 'err') hasErrors = true;
        if (check.status === 'warn') hasWarnings = true;

        html += `
            <div class="preflight-item">
                <span class="preflight-icon ${iconClass}">${icon}</span>
                <div class="preflight-text">
                    <div>${escapeHtml(check.name)}: ${escapeHtml(check.detail)}</div>
                    ${check.message ? `<div class="preflight-detail">${escapeHtml(check.message)}</div>` : ''}
                </div>
            </div>
        `;
    }

    results.innerHTML = html;

    // Configure buttons based on results
    if (hasErrors) {
        submitBtn.textContent = 'Submit Anyway';
        submitBtn.className = 'btn btn-danger';
        fixBtn.style.display = 'inline-block';
    } else if (hasWarnings) {
        submitBtn.textContent = 'Submit';
        submitBtn.className = 'btn btn-primary';
        fixBtn.style.display = 'none';
    } else {
        submitBtn.textContent = 'Submit';
        submitBtn.className = 'btn btn-primary';
        fixBtn.style.display = 'none';
    }

    modal.classList.add('visible');
}

window.closePreflightModal = function() {
    $('preflight-modal').classList.remove('visible');
};

window.submitToPRISM = async function() {
    closePreflightModal();

    if (!currentFile || !prismAvailable) return;

    const btn = $('analyze-btn');
    const progress = $('prism-progress');
    const progressText = $('prism-progress-text');

    btn.disabled = true;
    progress.style.display = 'block';
    progressText.textContent = 'Uploading to PRISM...';

    try {
        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('discipline', $('discipline-select').value);
        formData.append('window_size', $('window-size').value);
        formData.append('window_stride', $('window-stride').value);

        // Add user-entered constants
        const constants = getUserConstants();
        if (Object.keys(constants).length > 0) {
            formData.append('constants', JSON.stringify(constants));
        }

        progressText.textContent = 'Computing...';

        const r = await fetch('/api/prism/compute', {
            method: 'POST',
            body: formData,
        });

        const result = await r.json();

        if (!r.ok) {
            throw new Error(result.detail || 'PRISM computation failed');
        }

        progressText.textContent = 'Loading results...';

        // Load result parquets into DuckDB
        const tableSelect = $('table-select');
        tableSelect.innerHTML = '<option value="data">data (original)</option>';

        for (const url of result.parquet_urls || []) {
            const tableName = url.split('/').pop().replace('.parquet', '');

            try {
                // Fetch the parquet file
                const parquetResponse = await fetch(url);
                const parquetBuffer = await parquetResponse.arrayBuffer();
                const filename = `${tableName}.parquet`;

                // Register in DuckDB
                await db.registerFileBuffer(filename, new Uint8Array(parquetBuffer));
                await conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${filename}')`);

                // Add to table selector
                const option = document.createElement('option');
                option.value = tableName;
                option.textContent = tableName;
                tableSelect.appendChild(option);

            } catch (e) {
                console.warn(`Failed to load ${tableName}:`, e);
            }
        }

        progress.style.display = 'none';
        setSt('prism', `Done: ${result.parquets?.length || 0} tables`, 'ok');

        // Store URLs and show download button
        lastParquetUrls = result.parquet_urls || [];
        if (lastParquetUrls.length > 0) {
            $('download-section').style.display = 'block';
        }

        // Show first result table
        if (result.parquets?.length > 0) {
            const firstTable = result.parquets[0].replace('.parquet', '');
            tableSelect.value = firstTable;
            await loadTable(firstTable);
            await loadSchema();
        }

        // Validate results
        progressText.textContent = 'Validating results...';
        const validation = await validateResults();

        if (validation && (!validation.valid || validation.warnings?.length > 0)) {
            showValidationWarnings(validation);
        } else {
            alert(`PRISM analysis complete!\n\n${validation?.summary || `Loaded ${result.parquets?.length || 0} tables`}`);
        }

    } catch (e) {
        console.error('PRISM error:', e);
        progress.style.display = 'none';
        setSt('prism', 'Error', 'err');
        alert('PRISM Error: ' + e.message);
    } finally {
        btn.disabled = false;
        updateAnalyzeButton();
    }
};

// =====================================================================
// DOWNLOAD RESULTS
// =====================================================================

let lastParquetUrls = [];

window.downloadResults = async function() {
    if (lastParquetUrls.length === 0) return;

    // Download each parquet file
    for (const url of lastParquetUrls) {
        const filename = url.split('/').pop();
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
    }
};

window.loadExternalResults = async function() {
    const pathInput = $('results-path-input');
    const statusDiv = $('load-results-status');
    const path = pathInput.value.trim();

    if (!path) {
        statusDiv.innerHTML = '<span style="color: var(--red)">Please enter a path</span>';
        return;
    }

    statusDiv.innerHTML = '<span style="color: var(--blue)">Loading...</span>';

    try {
        const response = await fetch('/api/prism/load-results', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Failed to load results');
        }

        const result = await response.json();

        // Load parquets into DuckDB
        const tableSelect = $('table-select');
        const existingTables = new Set();
        for (const opt of tableSelect.options) {
            existingTables.add(opt.value);
        }

        let loadedCount = 0;
        for (const url of result.parquet_urls || []) {
            const tableName = url.split('/').pop().replace('.parquet', '');

            try {
                const parquetResponse = await fetch(url);
                const parquetBuffer = await parquetResponse.arrayBuffer();
                const filename = `${tableName}.parquet`;

                await db.registerFileBuffer(filename, new Uint8Array(parquetBuffer));
                await conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${filename}')`);

                if (!existingTables.has(tableName)) {
                    const option = document.createElement('option');
                    option.value = tableName;
                    option.textContent = tableName;
                    tableSelect.appendChild(option);
                }
                loadedCount++;
            } catch (e) {
                console.warn(`Failed to load ${tableName}:`, e);
            }
        }

        // Store URLs for download
        lastParquetUrls = result.parquet_urls || [];
        if (lastParquetUrls.length > 0) {
            $('download-section').style.display = 'block';
        }

        // Show first result table
        if (result.parquets?.length > 0) {
            const firstTable = result.parquets[0].replace('.parquet', '');
            tableSelect.value = firstTable;
            await loadTable(firstTable);
            showView('data');
        }

        setSt('prism', `Loaded: ${loadedCount} tables`, 'ok');
        statusDiv.innerHTML = `<span style="color: var(--green)">Loaded ${loadedCount} parquet files</span>`;

    } catch (e) {
        statusDiv.innerHTML = `<span style="color: var(--red)">${escapeHtml(e.message)}</span>`;
        console.error('Load results error:', e);
    }
};

// =====================================================================
// CONSTANTS PANEL
// =====================================================================

window.toggleConstants = function() {
    const panel = $('constants-panel');
    const toggle = $('constants-toggle');

    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        toggle.textContent = '‚àí Hide Constants';
    } else {
        panel.style.display = 'none';
        toggle.textContent = '+ Add Constants';
    }
};

window.toggleSignals = function() {
    const more = $('signals-more');
    const toggle = $('signals-toggle');

    if (more.style.display === 'none') {
        more.style.display = 'block';
        toggle.textContent = '‚àí show less';
    } else {
        more.style.display = 'none';
        const count = more.querySelectorAll('div').length;
        toggle.textContent = `...and ${count} more`;
    }
};

window.toggleSection = function(titleEl) {
    const content = titleEl.nextElementSibling;
    titleEl.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
};

function getUserConstants() {
    const constants = {};

    const density = $('const-density').value;
    const viscosity = $('const-viscosity').value;
    const diameter = $('const-diameter').value;
    const length = $('const-length').value;
    const temperature = $('const-temperature').value;
    const pressure = $('const-pressure').value;

    if (density) constants.density_kg_m3 = parseFloat(density);
    if (viscosity) constants.viscosity_Pa_s = parseFloat(viscosity);
    if (diameter) constants.diameter_m = parseFloat(diameter);
    if (length) constants.pipe_length_m = parseFloat(length);
    if (temperature) constants.temperature_K = parseFloat(temperature);
    if (pressure) constants.pressure_Pa = parseFloat(pressure);

    return constants;
};

// =====================================================================
// PRESET QUERIES
// =====================================================================

function populateQueryDropdown() {
    if (typeof ORTHON_QUERIES === 'undefined') {
        console.warn('ORTHON_QUERIES not loaded');
        return;
    }

    const select = $('query-select');

    for (const [sectionKey, section] of Object.entries(ORTHON_QUERIES)) {
        const group = document.createElement('optgroup');
        group.label = section.label;

        for (const query of section.queries) {
            const option = document.createElement('option');
            option.value = query.id;
            option.textContent = query.name;
            option.title = query.description;
            group.appendChild(option);
        }

        select.appendChild(group);
    }
}

window.loadPresetQuery = function(queryId) {
    if (!queryId) {
        $('query-input').value = 'SELECT * FROM data LIMIT 100';
        return;
    }

    // Find the query
    let selectedQuery = null;
    for (const section of Object.values(ORTHON_QUERIES)) {
        selectedQuery = section.queries.find(q => q.id === queryId);
        if (selectedQuery) break;
    }

    if (selectedQuery) {
        $('query-input').value = selectedQuery.sql.trim();
    }
};

// =====================================================================
// CONFIG TAB
// =====================================================================

const CONFIG_STORAGE_KEY = 'orthon_config';

const EXAMPLE_CONFIG = {
    index: {
        column: "timestamp",
        type: "temporal",
        unit: "seconds",
        monotonic: "increasing"
    },
    windows: {
        size: 100,
        stride: 50,
        min_observations: 10,
        boundary: "truncate"
    },
    signals: [
        { column: "signal_1", type: "continuous" },
        { column: "signal_2", type: "continuous" }
    ],
    layers: {
        typology: true,
        geometry: true,
        dynamics: true,
        mechanics: true
    },
    engines: {
        core: ["hurst", "entropy", "lyapunov", "trend", "stationarity"],
        domain: []
    }
};

const CONFIG_REQUIRED_FIELDS = [
    'index.column',
    'index.type',
    'index.unit',
    'windows.size',
    'windows.stride'
];

function initConfigTab() {
    const editor = $('config-editor');
    const fileInput = $('config-file-input');
    const saveBtn = $('config-save');
    const resetBtn = $('config-reset');

    // Load saved config or example
    const saved = localStorage.getItem(CONFIG_STORAGE_KEY);
    if (saved) {
        editor.value = saved;
    } else {
        editor.value = JSON.stringify(EXAMPLE_CONFIG, null, 2);
    }

    // Validate on load and check capabilities
    validateConfigEditor(editor.value);
    checkCapabilities();

    // Event listeners
    editor.addEventListener('input', () => {
        validateConfigEditor(editor.value);
        checkCapabilities();
    });

    fileInput.addEventListener('change', handleConfigFileLoad);
    saveBtn.addEventListener('click', handleConfigSave);
    resetBtn.addEventListener('click', handleConfigReset);
}

function handleConfigFileLoad(e) {
    const file = e.target.files[0];
    if (!file) return;
    loadConfigFile(file);
    e.target.value = ''; // Reset for same file reload
}

function parseSimpleYAML(text) {
    // Simple YAML parser for basic key:value and arrays
    const result = {};
    const lines = text.split('\n');
    let currentKey = null;
    let currentArray = null;

    for (const line of lines) {
        if (line.trim().startsWith('#') || !line.trim()) continue;

        // Array item
        if (line.match(/^\s+-\s+/)) {
            const itemMatch = line.match(/^\s+-\s+(.+)/);
            if (itemMatch && currentArray) {
                const item = itemMatch[1].trim();
                // Check if it's a key:value or just a value
                if (item.includes(':')) {
                    const obj = {};
                    const pairs = item.split(/,\s*/);
                    for (const pair of pairs) {
                        const [k, v] = pair.split(':').map(s => s.trim());
                        obj[k] = isNaN(v) ? v : Number(v);
                    }
                    currentArray.push(obj);
                } else {
                    currentArray.push(isNaN(item) ? item : Number(item));
                }
            }
            continue;
        }

        // Key: value or Key:
        const match = line.match(/^(\s*)(\w+):\s*(.*)$/);
        if (match) {
            const [, indent, key, value] = match;
            const depth = indent.length;

            if (value) {
                // Simple key: value
                if (depth === 0) {
                    result[key] = isNaN(value) ? (value === 'true' ? true : value === 'false' ? false : value) : Number(value);
                } else if (currentKey && typeof result[currentKey] === 'object' && !Array.isArray(result[currentKey])) {
                    result[currentKey][key] = isNaN(value) ? (value === 'true' ? true : value === 'false' ? false : value) : Number(value);
                }
            } else {
                // Object or array start
                if (depth === 0) {
                    currentKey = key;
                    result[key] = {};
                    currentArray = null;
                } else if (currentKey) {
                    result[currentKey][key] = [];
                    currentArray = result[currentKey][key];
                }
            }
        }
    }

    return result;
}

function handleConfigSave() {
    const editor = $('config-editor');
    const content = editor.value;

    const validation = validateConfigEditor(content);

    if (validation.valid) {
        localStorage.setItem(CONFIG_STORAGE_KEY, content);
        showConfigValidation('Config saved', 'valid');
        setSt('cfg', 'Saved', 'ok');
    } else {
        localStorage.setItem(CONFIG_STORAGE_KEY, content);
        showConfigValidation('Saved with warnings: ' + validation.errors.join(', '), 'warning');
        setSt('cfg', 'Saved (warnings)', 'warn');
    }
}

function handleConfigReset() {
    if (confirm('Reset config to example? Your changes will be lost.')) {
        const editor = $('config-editor');
        editor.value = JSON.stringify(EXAMPLE_CONFIG, null, 2);
        localStorage.removeItem(CONFIG_STORAGE_KEY);
        validateConfigEditor(editor.value);
        checkCapabilities();
        showConfigValidation('Reset to example config', 'valid');
        setSt('cfg', 'Example', 'ok');
    }
}

function validateConfigEditor(content) {
    const result = { valid: true, errors: [], warnings: [] };

    let config;
    try {
        config = JSON.parse(content);
    } catch (err) {
        result.valid = false;
        result.errors.push('Invalid JSON: ' + err.message);
        showConfigValidation(result.errors[0], 'invalid');
        setSt('cfg', 'Invalid JSON', 'err');
        return result;
    }

    // Check required fields
    for (const field of CONFIG_REQUIRED_FIELDS) {
        const value = getNestedValue(config, field);
        if (value === undefined || value === null || value === '') {
            result.valid = false;
            result.errors.push(field);
        }
    }

    // Check valid enum values
    const validTypes = ['temporal', 'spatial', 'ordinal', 'spectral', 'continuous'];
    if (config.index?.type && !validTypes.includes(config.index.type)) {
        result.warnings.push('index.type should be: ' + validTypes.join(', '));
    }

    const validMonotonic = ['increasing', 'decreasing', 'none'];
    if (config.index?.monotonic && !validMonotonic.includes(config.index.monotonic)) {
        result.warnings.push('index.monotonic should be: ' + validMonotonic.join(', '));
    }

    const validBoundary = ['truncate', 'pad', 'error'];
    if (config.windows?.boundary && !validBoundary.includes(config.windows.boundary)) {
        result.warnings.push('windows.boundary should be: ' + validBoundary.join(', '));
    }

    // Check logical constraints
    if (config.windows?.stride > config.windows?.size) {
        result.warnings.push('stride > size creates gaps');
    }

    // Display result
    if (result.errors.length > 0) {
        showConfigValidation('Missing required: ' + result.errors.join(', '), 'invalid');
        setSt('cfg', 'Missing fields', 'err');
    } else if (result.warnings.length > 0) {
        showConfigValidation('Warnings: ' + result.warnings.join('; '), 'warning');
        setSt('cfg', 'Valid (warnings)', 'warn');
    } else {
        showConfigValidation('Config valid', 'valid');
        setSt('cfg', 'Valid', 'ok');
    }

    return result;
}

function getNestedValue(obj, path) {
    return path.split('.').reduce((o, k) => (o || {})[k], obj);
}

function showConfigValidation(message, type) {
    const el = $('config-validation');
    const icon = type === 'valid' ? '‚úì' : type === 'warning' ? '‚ö†' : '‚úó';
    el.textContent = icon + ' ' + message;
    el.className = 'validation-message ' + type;
}

function getConfig() {
    const editor = $('config-editor');
    try {
        return JSON.parse(editor.value);
    } catch {
        return null;
    }
}

// Export for PRISM integration
window.orthonConfig = {
    get: getConfig,
    validate: validateConfigEditor
};

// Init
setSt('cfg', '‚Äî', '');
setSt('data', '‚Äî', '');
setSt('prism', 'Checking...', '');
initDuckDB();
checkPRISM();
populateQueryDropdown();
initConfigTab();
</script>
</body>
</html>
