<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rudder ‚Äî Data Transformer</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
            --purple: #bc8cff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-family: ui-monospace, monospace;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .logo span { color: var(--accent); }
        .subtitle { color: var(--dim); }

        /* Progress Steps */
        .progress {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            color: var(--dim);
            font-size: 0.875rem;
        }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step.active { color: var(--accent); }
        .step.active .step-num { background: var(--accent); color: var(--bg); }
        .step.done { color: var(--green); }
        .step.done .step-num { background: var(--green); color: var(--bg); }

        .step-line {
            width: 40px;
            height: 2px;
            background: var(--border);
            align-self: center;
        }
        .step-line.done { background: var(--green); }

        /* Cards */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-desc {
            color: var(--dim);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.05);
        }

        .upload-zone.has-file {
            border-color: var(--green);
            border-style: solid;
            background: rgba(63, 185, 80, 0.05);
        }

        .upload-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .upload-text { color: var(--dim); }
        .upload-text strong { color: var(--accent); }

        .file-info {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--input);
            border-radius: 6px;
        }

        .file-name { color: var(--green); font-weight: 500; }
        .file-meta { color: var(--dim); font-size: 0.875rem; margin-top: 0.25rem; }

        /* Column Mapper */
        .column-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .column-row {
            display: grid;
            grid-template-columns: 1fr 120px 150px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .column-row:last-child { border-bottom: none; }

        .column-row:hover {
            background: rgba(88, 166, 255, 0.03);
        }

        .column-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .column-name {
            font-family: ui-monospace, monospace;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .column-meta {
            font-size: 0.75rem;
            color: var(--dim);
        }

        .column-dtype {
            font-family: ui-monospace, monospace;
            font-size: 0.75rem;
            color: var(--purple);
        }

        .role-select {
            padding: 0.5rem;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font: inherit;
            font-size: 0.8rem;
        }

        .role-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .role-select option { background: var(--panel); }

        /* Role badges */
        .role-signal { color: var(--green); }
        .role-index { color: var(--accent); }
        .role-cohort { color: var(--yellow); }
        .role-ignore { color: var(--dim); }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: var(--input);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--dim);
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.yellow { color: var(--yellow); }

        /* Preview Table */
        .preview-container {
            max-height: 300px;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            font-family: ui-monospace, monospace;
        }

        .preview-table th {
            background: var(--input);
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            border-bottom: 1px solid var(--border);
        }

        .preview-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .preview-table tr:hover td {
            background: rgba(88, 166, 255, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--input);
            color: var(--text);
            font: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.15s;
        }

        .btn:hover { border-color: var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .btn-primary:hover:not(:disabled) {
            background: #4c9aed;
        }

        .btn-success {
            background: var(--green);
            border-color: var(--green);
            color: var(--bg);
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }

        /* Schema display */
        .schema-box {
            background: var(--input);
            border-radius: 8px;
            padding: 1rem;
            font-family: ui-monospace, monospace;
            font-size: 0.8rem;
        }

        .schema-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .schema-col { color: var(--text); }
        .schema-type { color: var(--purple); }

        /* Validation */
        .validation-result {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .validation-result.valid {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--green);
        }

        .validation-result.invalid {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--red);
        }

        .validation-result h4 {
            margin-bottom: 0.5rem;
        }

        .validation-result.valid h4 { color: var(--green); }
        .validation-result.invalid h4 { color: var(--red); }

        .validation-list {
            margin-left: 1rem;
            font-size: 0.875rem;
        }

        .validation-list li { margin: 0.25rem 0; }
        .error-item { color: var(--red); }
        .warning-item { color: var(--yellow); }

        /* Hidden */
        .hidden { display: none !important; }

        #file-input { display: none; }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--dim);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/v2" style="text-decoration: none; color: inherit;">
                <div class="logo"><span>√ò</span>rthon</div>
            </a>
            <div class="subtitle">Transform Data ‚Üí observations.parquet</div>
            <a href="/v2" style="font-size: 0.8rem; color: var(--accent); margin-top: 0.5rem;">‚Üê Back to Dashboard</a>
        </header>

        <!-- Progress -->
        <div class="progress">
            <div class="step active" id="step1">
                <div class="step-num">1</div>
                <span>Upload</span>
            </div>
            <div class="step-line" id="line1"></div>
            <div class="step" id="step2">
                <div class="step-num">2</div>
                <span>Map Columns</span>
            </div>
            <div class="step-line" id="line2"></div>
            <div class="step" id="step3">
                <div class="step-num">3</div>
                <span>Preview & Download</span>
            </div>
        </div>

        <!-- Step 1: Upload -->
        <div id="panel1" class="card">
            <div class="card-title">Upload Your Data</div>
            <div class="card-desc">
                Upload a CSV or Parquet file. Wide format (one column per signal) will be transformed to long format.
            </div>

            <div class="upload-zone" id="dropzone" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    <strong>Click to upload</strong> or drag and drop<br>
                    <small>.csv, .tsv, .parquet</small>
                </div>
            </div>
            <input type="file" id="file-input" accept=".parquet,.csv,.tsv,.txt">
            <div id="file-info" class="file-info hidden"></div>

            <div class="actions">
                <div></div>
                <button class="btn btn-primary" id="btn-next-1" disabled onclick="goToStep(2)">
                    Next: Map Columns ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Column Mapping -->
        <div id="panel2" class="card hidden">
            <div class="card-title">Classify Your Columns</div>
            <div class="card-desc">
                Tell us what each column represents. <strong>SIGNAL</strong> columns will become separate time series.
                <strong>INDEX</strong> column defines the ordering. <strong>COHORT</strong> is optional metadata.
            </div>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">Signals</div>
                    <div class="stat-value green" id="stat-signals">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Index</div>
                    <div class="stat-value" id="stat-index">‚Äî</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Cohort</div>
                    <div class="stat-value" id="stat-cohort">‚Äî</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Ignored</div>
                    <div class="stat-value" id="stat-ignored">0</div>
                </div>
            </div>

            <div class="column-list" id="column-list">
                <!-- Populated dynamically -->
            </div>

            <div class="actions">
                <button class="btn" onclick="goToStep(1)">‚Üê Back</button>
                <button class="btn btn-primary" id="btn-next-2" onclick="goToStep(3)">
                    Next: Preview ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Preview & Download -->
        <div id="panel3" class="card hidden">
            <div class="card-title">Preview & Download</div>
            <div class="card-desc">
                Review the transformed data before downloading.
            </div>

            <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Target Schema</h4>
            <div class="schema-box">
                <div class="schema-row">
                    <span class="schema-col">cohort</span>
                    <span class="schema-type">String (optional)</span>
                </div>
                <div class="schema-row">
                    <span class="schema-col">signal_id</span>
                    <span class="schema-type">String</span>
                </div>
                <div class="schema-row">
                    <span class="schema-col">signal_0</span>
                    <span class="schema-type">UInt32 (sequential per signal)</span>
                </div>
                <div class="schema-row">
                    <span class="schema-col">value</span>
                    <span class="schema-type">Float64</span>
                </div>
            </div>

            <h4 style="font-size: 0.875rem; margin: 1.5rem 0 0.5rem;">Transformation Summary</h4>
            <div class="stats-bar" id="transform-summary">
                <div class="stat">
                    <div class="stat-label">Input Rows</div>
                    <div class="stat-value" id="sum-input-rows">‚Äî</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Signals</div>
                    <div class="stat-value green" id="sum-signals">‚Äî</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Output Rows</div>
                    <div class="stat-value" id="sum-output-rows">‚Äî</div>
                </div>
            </div>

            <div id="preview-loading" class="loading hidden">
                <div class="spinner"></div>
                Generating preview...
            </div>

            <div id="preview-container" class="preview-container hidden">
                <table class="preview-table" id="preview-table">
                    <!-- Populated dynamically -->
                </table>
            </div>

            <div class="actions">
                <button class="btn" onclick="goToStep(2)">‚Üê Back</button>
                <button class="btn btn-success" id="btn-download" onclick="downloadParquet()">
                    ‚¨á Download observations.parquet
                </button>
            </div>
        </div>
    </div>

<script>
// =====================================================================
// STATE
// =====================================================================

const state = {
    file: null,
    fileInfo: null,
    columns: [],
    mappings: {},  // column_name -> {role: 'signal'|'index'|'cohort'|'ignore'}
};

// =====================================================================
// NAVIGATION
// =====================================================================

function goToStep(step) {
    // Update progress indicators
    for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById('step' + i);
        const lineEl = document.getElementById('line' + (i - 1));

        stepEl.classList.remove('active', 'done');
        if (i < step) {
            stepEl.classList.add('done');
            if (lineEl) lineEl.classList.add('done');
        } else if (i === step) {
            stepEl.classList.add('active');
        }
        if (lineEl && i >= step) lineEl.classList.remove('done');
    }

    // Show/hide panels
    for (let i = 1; i <= 3; i++) {
        document.getElementById('panel' + i).classList.toggle('hidden', i !== step);
    }

    // Step-specific actions
    if (step === 3) {
        showPreview();
    }
}

// =====================================================================
// STEP 1: FILE UPLOAD
// =====================================================================

const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('file-input');

dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = 'var(--accent)';
});

dropzone.addEventListener('dragleave', () => {
    dropzone.style.borderColor = '';
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = '';
    if (e.dataTransfer.files[0]) {
        handleFile(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files[0]) {
        handleFile(e.target.files[0]);
    }
});

async function handleFile(file) {
    state.file = file;

    dropzone.classList.add('has-file');

    const fileInfo = document.getElementById('file-info');
    fileInfo.classList.remove('hidden');
    fileInfo.innerHTML = `
        <div class="file-name">${file.name}</div>
        <div class="file-meta">${(file.size / 1024).toFixed(1)} KB ‚Äî Analyzing...</div>
    `;

    // Send to backend for column detection
    const formData = new FormData();
    formData.append('file', file);

    try {
        const resp = await fetch('/api/schema/detect', {
            method: 'POST',
            body: formData,
        });

        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Upload failed');
        }

        const data = await resp.json();
        state.fileInfo = data;
        state.columns = data.columns;

        // Initialize mappings from suggestions
        state.mappings = {};
        for (const col of data.columns) {
            state.mappings[col.name] = { role: col.suggested_role };
        }

        fileInfo.innerHTML = `
            <div class="file-name">${file.name}</div>
            <div class="file-meta">${data.n_rows.toLocaleString()} rows √ó ${data.n_cols} columns</div>
        `;

        buildColumnMapper();
        document.getElementById('btn-next-1').disabled = false;

    } catch (e) {
        fileInfo.innerHTML = `
            <div class="file-name" style="color: var(--red);">Error</div>
            <div class="file-meta">${e.message}</div>
        `;
    }
}

// =====================================================================
// STEP 2: COLUMN MAPPING
// =====================================================================

function buildColumnMapper() {
    const listEl = document.getElementById('column-list');
    listEl.innerHTML = '';

    for (const col of state.columns) {
        const role = state.mappings[col.name]?.role || 'ignore';

        const row = document.createElement('div');
        row.className = 'column-row';
        row.innerHTML = `
            <div class="column-info">
                <span class="column-name">${escapeHtml(col.name)}</span>
                <span class="column-meta">
                    ${col.n_unique.toLocaleString()} unique, ${col.n_null} nulls
                    ${col.sample.length > 0 ? ' ‚Äî ' + col.sample.map(v => String(v).substring(0, 20)).join(', ') : ''}
                </span>
            </div>
            <span class="column-dtype">${col.dtype}</span>
            <select class="role-select" data-column="${escapeHtml(col.name)}" onchange="updateMapping(this)">
                <option value="signal" ${role === 'signal' ? 'selected' : ''}>üü¢ SIGNAL</option>
                <option value="index" ${role === 'index' ? 'selected' : ''}>üîµ INDEX</option>
                <option value="cohort" ${role === 'cohort' ? 'selected' : ''}>üü° COHORT</option>
                <option value="ignore" ${role === 'ignore' ? 'selected' : ''}>‚ö´ IGNORE</option>
            </select>
        `;
        listEl.appendChild(row);
    }

    updateStats();
}

function updateMapping(selectEl) {
    const col = selectEl.dataset.column;
    const role = selectEl.value;

    // If setting INDEX or COHORT, unset any previous one (only one allowed)
    if (role === 'index' || role === 'cohort') {
        for (const [c, m] of Object.entries(state.mappings)) {
            if (m.role === role && c !== col) {
                state.mappings[c].role = 'ignore';
            }
        }
        // Update all select dropdowns
        document.querySelectorAll('.role-select').forEach(sel => {
            const c = sel.dataset.column;
            if (c !== col && state.mappings[c]?.role === 'ignore') {
                sel.value = 'ignore';
            }
        });
    }

    state.mappings[col] = { role };
    updateStats();
}

function updateStats() {
    let signals = 0, ignored = 0;
    let indexCol = '‚Äî', cohortCol = '‚Äî';

    for (const [col, m] of Object.entries(state.mappings)) {
        if (m.role === 'signal') signals++;
        else if (m.role === 'ignore') ignored++;
        else if (m.role === 'index') indexCol = col;
        else if (m.role === 'cohort') cohortCol = col;
    }

    document.getElementById('stat-signals').textContent = signals;
    document.getElementById('stat-index').textContent = indexCol;
    document.getElementById('stat-cohort').textContent = cohortCol;
    document.getElementById('stat-ignored').textContent = ignored;

    // Enable/disable next button
    document.getElementById('btn-next-2').disabled = signals === 0;
}

// =====================================================================
// STEP 3: PREVIEW & DOWNLOAD
// =====================================================================

function showPreview() {
    const loadingEl = document.getElementById('preview-loading');
    const containerEl = document.getElementById('preview-container');

    loadingEl.classList.remove('hidden');
    containerEl.classList.add('hidden');

    // Calculate summary
    const signalCols = Object.entries(state.mappings)
        .filter(([_, m]) => m.role === 'signal')
        .map(([col, _]) => col);

    const inputRows = state.fileInfo?.n_rows || 0;
    const outputRows = inputRows * signalCols.length;

    document.getElementById('sum-input-rows').textContent = inputRows.toLocaleString();
    document.getElementById('sum-signals').textContent = signalCols.length;
    document.getElementById('sum-output-rows').textContent = outputRows.toLocaleString();

    // Build preview table (simulated - showing what output will look like)
    setTimeout(() => {
        const tableEl = document.getElementById('preview-table');

        const hasCohort = Object.values(state.mappings).some(m => m.role === 'cohort');
        const cohortCol = Object.entries(state.mappings).find(([_, m]) => m.role === 'cohort')?.[0];

        let html = '<thead><tr>';
        if (hasCohort) html += '<th>cohort</th>';
        html += '<th>signal_id</th><th>signal_0</th><th>value</th>';
        html += '</tr></thead><tbody>';

        // Show first few rows for each signal
        const maxPreviewRows = 15;
        let rowCount = 0;

        for (const sig of signalCols.slice(0, 3)) {  // First 3 signals
            for (let i = 0; i < 5 && rowCount < maxPreviewRows; i++, rowCount++) {
                html += '<tr>';
                if (hasCohort) {
                    const cohortSample = state.columns.find(c => c.name === cohortCol)?.sample[0] || 'default';
                    html += `<td>${escapeHtml(String(cohortSample))}</td>`;
                }
                html += `<td>${escapeHtml(sig)}</td>`;
                html += `<td>${i}</td>`;
                const sigCol = state.columns.find(c => c.name === sig);
                const val = sigCol?.sample[i % sigCol.sample.length] ?? '...';
                html += `<td>${typeof val === 'number' ? val.toFixed(4) : escapeHtml(String(val))}</td>`;
                html += '</tr>';
            }
        }

        if (signalCols.length > 3 || inputRows > 5) {
            html += '<tr><td colspan="4" style="text-align: center; color: var(--dim);">... more rows ...</td></tr>';
        }

        html += '</tbody>';
        tableEl.innerHTML = html;

        loadingEl.classList.add('hidden');
        containerEl.classList.remove('hidden');
    }, 300);
}

async function downloadParquet() {
    const btn = document.getElementById('btn-download');
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating...';

    const formData = new FormData();
    formData.append('file', state.file);
    formData.append('mappings', JSON.stringify(state.mappings));

    try {
        const resp = await fetch('/api/schema/transform', {
            method: 'POST',
            body: formData,
        });

        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Transform failed');
        }

        // Download the file
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'observations.parquet';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        btn.textContent = '‚úì Downloaded!';
        btn.classList.remove('btn-success');
        btn.style.background = 'var(--green)';

    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = '‚¨á Download observations.parquet';
    }
}

// =====================================================================
// UTILS
// =====================================================================

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
</body>
</html>
