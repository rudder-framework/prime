# Manifold Canonical Schema v3.0.0
# =================================
#
# THIS IS THE SINGLE SOURCE OF TRUTH.
#
# BREAKING CHANGE: entity_id â†’ cohort (OPTIONAL)
#
# All validators read from this file:
# - Framework: data_confirmation.py
# - Manifold: data_check.py
# - Website: AI upload validation
# - Claude: Integration instructions

version: "3.0.0"
name: "Manifold Observations Schema"
description: "Canonical schema for observations.parquet consumed by Manifold"

# =============================================================================
# COLUMNS
# =============================================================================

columns:
  cohort:
    description: |
      Optional label for grouping signals.

      This is just a tag - a sticky note for humans.
      ZERO effect on compute. Manifold passes it through.
      Used for SQL filtering after compute.

      Can be:
      - A physical thing: "pump_1", "patient_42"
      - A category: "Consumer_Staples", "stocks"
      - An arbitrary grouping: "friday_data", "batch_001"
      - Literally anything: "bananas"
      - Empty: "" (totally fine)
      - Null: (also fine)

      Cannot be:
      - An index (that's what signal_0 is for)
      - Sequential numbers used for ordering

    type: "string"
    nullable: true
    default: ""
    required: false
    examples: ["pump_1", "Consumer_Staples", "friday_data", "bananas", ""]

  signal_id:
    description: |
      Identifies what is being measured.
      Each unique signal_id becomes a vector.
      REQUIRED - Manifold needs this.
    type: "string"
    nullable: false
    required: true
    examples: ["temp", "pressure", "return", "acc_x", "acc_y"]

  signal_0:
    description: |
      Index. Orders values within each cohort+signal combination.
      Sorted ascending Float64 per group.
      REQUIRED - Manifold needs this to build vectors.
    type: "float64"
    nullable: false
    required: true
    constraints:
      - "Sorted ascending per cohort+signal combination"
      - "No nulls"
    examples: [0.0, 1.0, 2.0, 3.0, 4.0]

  value:
    description: |
      The measurement. The actual number.
      REQUIRED - this is the data.
    type: "float64"
    nullable: true  # NaN allowed for missing data
    required: true
    examples: [25.3, -0.0042, 101.325]

# =============================================================================
# REQUIREMENTS
# =============================================================================

required_columns: ["signal_id", "signal_0", "value"]
optional_columns: ["cohort"]

requirements:
  min_signals: 2
  reason: "Pair engines need at least 2 signals"

  min_observations: 50
  reason: "Windowed engines need sufficient data"

  signal_0_sorted_ascending: true
  reason: "Vectors must have consistent ordering"

  cohort_required: false
  reason: "It's just a label. Blank is fine."

# =============================================================================
# VALIDATION RULES
# =============================================================================

validation_rules:

  - id: "REQUIRED_COLUMNS"
    severity: "error"
    check: "Required columns present"
    columns: ["signal_id", "signal_0", "value"]

  - id: "COLUMN_TYPES"
    severity: "error"
    check: "Columns have correct types"
    rules:
      signal_id: "string"
      signal_0: "float (float64)"
      value: "float (float32, float64)"
      cohort: "string (if present)"

  - id: "NO_NULLS_IN_REQUIRED"
    severity: "error"
    check: "No null values in signal_id, signal_0"
    columns: ["signal_id", "signal_0"]

  - id: "SIGNAL_0_SORTED"
    severity: "error"
    check: "signal_0 is sorted ascending per cohort+signal"
    test: "signal_0 is monotonically increasing for each group"

  - id: "MIN_SIGNALS"
    severity: "error"
    check: "At least 2 signals exist"
    test: "count(distinct signal_id) >= 2"
    message: "Pair engines require at least 2 signals"

  - id: "MIN_OBSERVATIONS"
    severity: "warning"
    check: "Each signal has >=50 observations"
    test: "count(*) >= 50 for each signal group"
    message: "Some engines may produce NaN with insufficient data"

# =============================================================================
# EXAMPLE VALID DATA
# =============================================================================

example_valid:
  description: "Correctly formatted observations"
  data: |
    cohort    | signal_id | signal_0 | value
    ----------|-----------|----------|------
    pump_1    | temp      | 0.0      | 25.3
    pump_1    | temp      | 1.0      | 25.4
    pump_1    | pressure  | 0.0      | 101.2
    pump_1    | pressure  | 1.0      | 101.3

    # cohort can also be blank:
              | temp      | 0.0      | 25.3
              | temp      | 1.0      | 25.4
              | pressure  | 0.0      | 101.2
              | pressure  | 1.0      | 101.3

# =============================================================================
# OUTPUTS
# =============================================================================

outputs:
  description: "Manifold produces these files when given valid input"
  files:
    - name: "primitives.parquet"
      description: "Signal-level metrics"
    - name: "primitives_pairs.parquet"
      description: "Directed pair metrics"
    - name: "geometry.parquet"
      description: "Symmetric pair metrics"
    - name: "topology.parquet"
      description: "Betti numbers, persistence"
    - name: "dynamics.parquet"
      description: "Lyapunov, RQA, Hurst"
    - name: "information_flow.parquet"
      description: "Transfer entropy, Granger"
    - name: "observations_enriched.parquet"
      description: "Rolling window metrics"
    - name: "physics.parquet"
      description: "Energy, entropy metrics"

# =============================================================================
# HUMAN READABLE SUMMARY
# =============================================================================

summary: |
  Manifold expects observations.parquet with these columns:

  REQUIRED:
  - signal_id (string): What is being measured
  - signal_0 (float64): Index, sorted ascending per group
  - value (float64): The measurement

  OPTIONAL:
  - cohort (string): A label for grouping (blank is fine)

  Rules:
  - signal_0 must be sorted ascending per cohort+signal group
  - At least 2 signals for pair calculations
  - cohort is OPTIONAL - just a tag for SQL later
